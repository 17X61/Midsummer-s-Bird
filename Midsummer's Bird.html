<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midsummer's Bird</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #1a1a1d;
            --text-secondary-color: #65676b;
            --border-color: #dcdfe3;
            --primary-color: #5E5B9D;
            --primary-hover-color: #7875b3;
            --input-bg-color: #e4e6eb;
            --user-bubble-color: #5E5B9D;
            --ai-bubble-color: #FFFFFF;
            --bubble-opacity: 0.95;
            --bubble-text-color: #1a1a1d;
            --user-bubble-text-color: #FFFFFF;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        #app-wrapper {
            transition: padding-left 0.3s ease;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: var(--card-bg-color);
            box-shadow: 2px 0 12px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transform: translateX(0);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .nav-link {
            color: var(--text-secondary-color);
        }
        .nav-link:hover, .nav-link.active {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .primary-gradient-text {
            background: linear-gradient(135deg, var(--primary-color), #a3a1d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .btn-primary:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }
        .btn-secondary:hover { background-color: #d8dbe0; }
        .btn-secondary:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }


        .modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .sub-modal { z-index: 60; }
        .super-sub-modal { z-index: 70; }

        /* 移动端模态框适配 */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 0.5rem;
            }
            .sub-modal .modal-content {
                max-width: 100% !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
                width: auto !important;
                height: auto !important;
            }
            .sub-modal .modal-content .card {
                padding: 1rem !important;
            }
            .sub-modal h2 {
                font-size: 1.25rem !important;
            }
            .sub-modal input, .sub-modal textarea, .sub-modal select {
                font-size: 16px !important; /* 防止iOS缩放 */
            }
        }

        /* 保存提示toast */
        .save-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid #10b981;
        }
        .save-toast.show {
            transform: translateX(0);
        }
        .save-toast .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .save-toast .message {
            color: var(--text-color);
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .save-toast {
                right: 10px;
                left: 10px;
                top: 10px;
                padding: 12px 16px;
            }
        }
        
        .light-input {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .light-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(94, 91, 157, 0.2);
        }

        ::-webkit-scrollbar { width: 0; height: 0; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background-color: transparent;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: transparent; }

        /* 完全隐藏所有滚动条 */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px;
            background: #e4e6eb;
            border-radius: 5px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: var(--primary-color);
            cursor: pointer; border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        input[type="checkbox"].switch {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            width: 38px;
            height: 22px;
            border-radius: 11px;
            background-color: #ccc;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        input[type="checkbox"].switch::before {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background-color: white;
            transition: transform 0.2s;
        }
        input[type="checkbox"].switch:checked {
            background-color: var(--primary-color);
        }
        input[type="checkbox"].switch:checked::before {
            transform: translateX(16px);
        }

        .prompt-entry:hover, .regex-script-item:hover, .char-item:hover { background-color: var(--bg-color); }
        .drag-handle { cursor: grab; }
        .sortable-ghost { opacity: 0.5; background: #e4e6eb; }

        .wi-entry-item.active, .char-item.active {
            background-color: var(--primary-color) !important;
            color: white;
        }
         .wi-entry-item.active .text-gray-500, .char-item.active .text-gray-500 {
            color: rgba(255,255,255,0.8);
         }
        .fa-star.favorited { color: #facc15; }

        /* Chat styles */
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .chat-message-group:hover .message-actions {
            opacity: 1;
        }
        .rendered-html-iframe {
            width: 100%;
            height: 80vh;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chat-bubble {
            color: var(--bubble-text-color);
            opacity: var(--bubble-opacity);
            cursor: pointer;
        }
        .chat-bubble.user-bubble {
            background-color: var(--user-bubble-color);
            color: var(--user-bubble-text-color);
        }
        .chat-bubble.ai-bubble {
            background-color: var(--ai-bubble-color);
        }
        .chat-bubble.selected {
             border: 2px solid var(--primary-color) !important;
        }
        
        /* Message Menu */
        .msg-menu {
            position: absolute;
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 0;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 120px;
            --arrow-position: 50%;
        }
        .msg-menu::before {
            content: '';
            position: absolute;
            bottom: -7px;
            left: var(--arrow-position, 50%);
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 7px solid var(--card-bg-color);
        }
        .msg-menu-item { padding: 10px 16px; color: var(--text-color); cursor: pointer; white-space: nowrap; font-size: 14px; }
        .msg-menu-item:hover { background: var(--bg-color); }
        .msg-menu-item.danger { color: #e74c3c; }

        /* Message Editing */
        .message-editing-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 150;
            padding: 1rem;
        }
        .message-editing-modal.active {
            display: flex;
        }
        .message-editing-modal .modal-content {
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transition: max-width 0.3s ease, max-height 0.3s ease;
        }
        .message-editing-modal.expanded .modal-content {
            max-width: 95vw;
            max-height: 95vh;
        }
        .message-editing-modal.expanded .message-edit-textarea {
            min-height: 400px;
        }
        .message-edit-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            background: var(--card-bg-color);
            color: var(--text-color);
        }
        .message-edit-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(94, 91, 157, 0.2);
        }
        .message-action-btn {
            padding: 4px 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-radius: 6px;
            background: var(--input-bg-color);
            color: var(--text-color);
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .message-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .message-action-btn.danger {
            background: #fee;
            color: #e74c3c;
            border-color: #fcc;
        }
        .message-action-btn.danger:hover {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        /* Multi-select Mode - 样式保留但功能已移除 */
        .multi-select-mode .chat-message-group { cursor: pointer; }
        .multi-select-mode .chat-message-group:hover { background: rgba(94, 91, 157, 0.05); }
        .multi-select-mode .msg-menu { display: none !important; }

        /* Character Select with Avatar */
        .char-select-wrapper {
            position: relative;
        }
        .char-select-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
        }
        .char-select-preview img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .char-select-preview:hover {
            border-color: var(--primary-color);
        }
        #char-select {
            position: relative;
            background-image: none;
            padding-left: 44px;
        }
        .char-avatar-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Reply Message */
        .reply-reference { 
            background: rgba(0,0,0,0.05); 
            border-left: 3px solid var(--primary-color);
            padding: 8px 12px; 
            margin-bottom: 8px; 
            border-radius: 4px; 
            font-size: 13px; 
            color: var(--text-secondary-color);
            max-height: 60px; overflow: hidden; 
        }
        .reply-reference .reply-from { color: var(--primary-color); font-weight: bold; margin-bottom: 2px; }

        /* Image Styles */
        .image-bubble {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }
        .image-message img {
            max-width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        /* Theme Modal Styles */
        .theme-preset-btn {
            border: 2px solid var(--border-color);
        }
        .theme-preset-btn:hover, .theme-preset-btn.active {
            border-color: var(--primary-color);
        }
        .theme-preset-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        .color-input {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 8px;
        }
        .color-text {
            font-family: monospace;
        }

        /* Advanced API Modal Styles */
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }
        .status-ready { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-testing { background: #ffc107; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }


        /* Markdown和HTML渲染样式 */
        .message-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content a {
            text-decoration: underline;
        }

        .message-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 16px 0;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 8px 0;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .message-content table td, .message-content table th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .message-content table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <aside id="sidebar" class="sidebar collapsed">
        <div class="flex items-center justify-between p-4 h-16 border-b border-gray-200 flex-shrink-0">
            <h1 class="text-lg font-bold primary-gradient-text whitespace-nowrap overflow-hidden">
                <span>midsummer's bird</span>
            </h1>
        </div>
        <nav id="main-nav" class="flex-grow p-4 space-y-2">
            <button data-modal="api-settings-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.api" title="API 设置"><i class="fas fa-robot text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.api">API 设置</span></button>
            <button data-modal="character-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.character" title="角色卡"><i class="fas fa-user-astronaut text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.character">角色卡</span></button>
            <button data-modal="presets-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.presets" title="AI 预设"><i class="fas fa-sliders-h text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.presets">AI 预设</span></button>
            <button data-modal="world-info-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.worldInfo" title="世界书"><i class="fas fa-book text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.worldInfo">世界书</span></button>
            <button data-modal="regex-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.regex" title="正则表达式"><i class="fas fa-code text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.regex">正则表达式</span></button>
            <button data-modal="theme-settings-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.theme" title="主题设置"><i class="fas fa-palette text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.theme">主题设置</span></button>
            <button data-modal="preferences-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.preferences" title="偏好设置"><i class="fas fa-sliders text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.preferences">偏好设置</span></button>
            <button data-modal="user-profile-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.user" title="用户/UI设置"><i class="fas fa-cog text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.user">用户/UI设置</span></button>
        </nav>
    </aside>

    <div id="app-wrapper">
        <main class="min-h-screen">
            <div class="card flex flex-col h-screen">
                <header class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center gap-3">
                         <button id="mobile-sidebar-toggle" class="p-2 -ml-2 text-gray-500 hover:text-primary-color">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <img id="char-avatar-header" src="https://placehold.co/40x40/5E5B9D/ffffff?text=AI" class="w-10 h-10 rounded-full object-cover">
                        <h2 id="char-name-header" class="text-xl font-bold">No Character Loaded</h2>
                    </div>
                    <button id="reselect-greeting-btn" class="btn-secondary px-3 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm" data-i18n-title="chat.reselectGreeting" title="重新选择开场白">
                        <i class="fas fa-redo mr-1"></i><span data-i18n="chat.reselectGreeting">重选开场白</span>
                    </button>
                </header>
                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                    </div>
                <footer class="p-4 border-t border-gray-200 flex-shrink-0">
                     <div id="reply-status-container"></div>
                    <div class="flex items-center gap-2">
                        <!-- 左侧菜单按钮 -->
                        <div class="relative">
                            <button id="chat-menu-btn" class="w-10 h-10 flex items-center justify-center btn-secondary rounded-lg hover:bg-gray-300 transition-colors flex-shrink-0" data-i18n-title="chat.moreOptions" title="更多选项">
                                <i class="fas fa-plus text-lg"></i>
                            </button>
                            <!-- 弹出菜单 -->
                            <div id="chat-menu-panel" class="hidden absolute bottom-12 left-0 bg-white border border-gray-200 rounded-lg shadow-lg p-2 min-w-[180px]">
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-view-prompt-btn">
                                    <i class="fas fa-eye text-purple-500"></i>
                                    <span data-i18n="chat.viewPrompt">查看提示词</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-new-chat-btn">
                                    <i class="fas fa-sync-alt text-green-500"></i>
                                    <span data-i18n="chat.newChat">新对话</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-image-btn">
                                    <i class="fas fa-image text-blue-500"></i>
                                    <span data-i18n="chat.sendImage">发送图片</span>
                                </button>
                                <div class="border-t border-gray-200 my-1"></div>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-summarize-btn">
                                    <i class="fas fa-compress-alt text-purple-500"></i>
                                    <span data-i18n="chat.summarize">总结聊天</span>
                                </button>
                                <div class="border-t border-gray-200 my-1"></div>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-export-config-btn">
                                    <i class="fas fa-download text-orange-500"></i>
                                    <span data-i18n="chat.exportConfig">导出配置</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-import-config-btn">
                                    <i class="fas fa-upload text-orange-500"></i>
                                    <span data-i18n="chat.importConfig">导入配置</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-export-chat-btn">
                                    <i class="fas fa-file-download text-indigo-500"></i>
                                    <span data-i18n="chat.exportChat">导出聊天记录</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-import-chat-btn">
                                    <i class="fas fa-file-upload text-indigo-500"></i>
                                    <span data-i18n="chat.importChat">导入聊天记录</span>
                                </button>
                            </div>
                            <!-- 隐藏的文件输入 -->
                            <input type="file" id="config-file-input" accept=".json" class="hidden">
                            <input type="file" id="chat-file-input" accept=".json" class="hidden">
                        </div>
                        <!-- 输入框 -->
                        <textarea id="chat-input" class="flex-1 light-input rounded-lg p-2.5 resize-none" data-i18n-placeholder="chat.inputPlaceholder" placeholder="输入消息..." rows="1" style="min-height: 40px; max-height: 200px;"></textarea>
                        <!-- 发送按钮 -->
                        <button id="send-button" class="w-10 h-10 flex-shrink-0 btn-primary text-white rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center" data-i18n-title="chat.sendMessage" title="发送消息">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- API 客户端模块 -->
    <script>
        // 简化的 API 客户端
        class SimpleAPIClient {
            constructor(config) {
                this.config = config;
            }

            async chat(messages, options = {}) {
                const { stream = false, onMessage = null } = options;
                const url = new URL(this.config.url);

                let endpoint = `${this.config.url.replace(/\/$/, '')}/chat/completions`;
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.config.key}`
                };

                let body = {
                    model: this.config.model,
                    messages: messages,
                    stream: stream,
                    max_tokens: options.maxTokens || 1024,
                    temperature: options.temperature || 0.7
                };

                // Google Gemini 特殊处理
                if (url.hostname.includes('google')) {
                    endpoint = `${url.origin}/v1beta/models/${this.config.model}:generateContent?key=${this.config.key}`;
                    delete headers.Authorization;

                    const userMessages = messages.filter(m => m.role !== 'system');
                    const systemMessage = messages.find(m => m.role === 'system');

                    if (systemMessage && userMessages.length > 0) {
                        userMessages[0].content = systemMessage.content + '\n\n' + userMessages[0].content;
                    }

                    body = {
                        contents: userMessages.map(m => ({
                            role: m.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: m.content }]
                        })),
                        generationConfig: {
                            maxOutputTokens: options.maxTokens || 1024,
                            temperature: options.temperature || 0.7
                        }
                    };
                    stream = false; // Gemini 不支持流式
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                if (stream && !url.hostname.includes('google')) {
                    return this.handleStreamResponse(response, onMessage);
                } else {
                    const data = await response.json();
                    if (data.choices) {
                        return { choices: [{ message: { content: data.choices[0].message.content } }] };
                    } else if (data.candidates) {
                        return { choices: [{ message: { content: data.candidates[0].content.parts[0].text } }] };
                    }
                    throw new Error('Unknown response format');
                }
            }

            async handleStreamResponse(response, onMessage) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);
                                const delta = json.choices?.[0]?.delta?.content;
                                if (delta) {
                                    fullContent += delta;
                                    if (onMessage) {
                                        onMessage(delta, fullContent);
                                    }
                                }
                            } catch (e) {
                                // 忽略解析错误
                            }
                        }
                    }
                }

                return { choices: [{ message: { content: fullContent } }] };
            }

            async testConnection() {
                try {
                    const response = await this.chat([
                        { role: 'user', content: 'Hi' }
                    ], { maxTokens: 5 });
                    return { success: true, message: '连接成功！' };
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }
        }

        // 全局 API 实例
        window.apiClient = null;
    </script>

    <div id="api-settings-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="api.title">API 设置</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4 overflow-y-auto pr-4 -mr-4">
                <div class="p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium mb-2" data-i18n="api.configManage">API 配置管理</label>
                    <div class="flex gap-2">
                        <select id="savedApiSelect" class="flex-1 light-input rounded-md p-2"></select>
                        <button id="loadApiBtn" class="btn-secondary px-3 rounded-lg" data-i18n-title="api.loadSelected" title="加载选中配置"><i class="fas fa-check"></i></button>
                        <button id="deleteApiBtn" class="btn-secondary px-3 rounded-lg hover:bg-red-100 hover:text-red-500" data-i18n-title="api.deleteSelected" title="删除选中配置"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div><label class="block text-sm font-medium mb-1" data-i18n="api.configName">配置名称</label><input id="apiConfigNameInput" type="text" data-i18n-placeholder="api.configNamePlaceholder" placeholder="为此配置命名" class="w-full light-input rounded-md p-2"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1" data-i18n="api.url">API URL (OpenAI 格式)</label>
                    <input id="api-url" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.url">
                    <div class="text-xs text-gray-500 mt-1 space-y-1">
                        <div><b data-i18n="api.supportedFormats">支持格式:</b> DeepSeek, OpenAI, SiliconFlow, Google Gemini 等.</div>
                        <div class="text-red-500"><b data-i18n="api.note">注意:</b> <span data-i18n="api.googleKeyNote">Google API密钥以 `AIza...` 开头.</span></div>
                    </div>
                </div>
                <div><label class="block text-sm font-medium mb-1" data-i18n="api.key">API Key</label><input id="api-key" type="password" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.key"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.model">模型列表</label>
                        <select id="model-select" class="w-full light-input rounded-md p-2 hidden"></select>
                        <input id="model-name" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.modelPlaceholder" placeholder="例如 gpt-4-turbo">
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-sm font-medium mb-1 invisible">占位</label>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center gap-2 cursor-pointer flex-1 min-w-0">
                                <input id="api-streaming-toggle" type="checkbox" class="w-4 h-4 accent-primary-color flex-shrink-0">
                                <span class="text-sm truncate" data-i18n="api.streaming">流式传输</span>
                            </label>
                            <button id="load-models-btn" class="py-2 px-3 btn-primary rounded-lg text-sm whitespace-nowrap flex-shrink-0">
                                <i class="fas fa-sync-alt mr-1"></i><span data-i18n="api.loadModels">刷新</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="api-test-result" class="text-sm mt-2 text-center h-auto min-h-[1rem]"></div>

                <hr class="my-4 border-gray-200">
                <h3 class="text-lg font-semibold primary-gradient-text" data-i18n="api.visionTitle">🖼️ 识图 API 设置 (可选)</h3>
                <p class="text-xs text-gray-500 mb-3" data-i18n="api.visionDescription">用于发送图片时让AI能够理解图片内容。</p>

                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionUrl">识图 API URL</label>
                        <input id="vision-api-url" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.url">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionKey">识图 API Key</label>
                        <input id="vision-api-key" type="password" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.key">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionModel">识图模型</label>
                        <select id="vision-model-select" class="w-full light-input rounded-md p-2 hidden"></select>
                        <button id="load-vision-models-btn" class="w-full mt-2 py-2 btn-primary rounded-lg text-sm">
                            <i class="fas fa-sync-alt mr-1"></i><span data-i18n="api.loadVisionModels">加载识图模型</span>
                        </button>
                    </div>
                </div>

                <div id="vision-api-test-result" class="text-sm mt-3 text-center h-auto min-h-[1rem]"></div>

                <div class="flex flex-wrap gap-4 pt-4 mt-auto">
                    <button id="saveAsNewBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="api.saveAsNew">另存为新配置</button>
                    <button id="updateCurrentBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="api.updateCurrent">更新当前配置</button>
                </div>
                <div class="flex flex-wrap gap-4">
                    <button id="testApiConnection" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.testConnection">测试连接</button>
                    <button id="debugModelsBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.debugModels">调试模型</button>
                    <button id="directChatTestBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.directChatTest">直接测试聊天</button>
                </div>
            </div>
        </div>
    </div>
    <div id="presets-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 rounded-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="presets.title">AI 预设</h2><button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div>
            <div class="flex flex-1 flex-col gap-6 overflow-hidden">
                <div class="w-full flex flex-col border-b border-gray-200 pb-4">
                    <div class="flex gap-2 mb-4"><button class="flex-1 py-2 text-sm btn-secondary rounded" onclick="document.getElementById('preset-import-json').click()" data-i18n="presets.import">导入</button><input type="file" id="preset-import-json" accept=".json" class="hidden"><button id="preset-export-json" class="flex-1 py-2 text-sm btn-secondary rounded" data-i18n="presets.export">导出</button></div>
                    <div id="preset-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
                    <div class="mt-4"><button id="save-as-preset-btn" class="w-full py-2 btn-primary rounded-lg" data-i18n="presets.saveAsNew">另存为新预设</button></div>
                </div>
                <div class="w-full flex flex-1 flex-col gap-6 overflow-hidden">
                    <div id="preset-editor" class="w-full overflow-y-auto pr-2 space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg mb-2" data-i18n="presets.samplingParams">采样参数</h3>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-calculator mr-1"></i>
                                <span data-i18n="presets.estimatedTokens">预估Token:</span> <span id="preset-token-estimate" class="font-bold text-primary-color">0</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Temperature</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-temp" min="0" max="2" step="0.01"><input type="number" id="param-temp-value" min="0" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Top P</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-top-p" min="0" max="1" step="0.01"><input type="number" id="param-top-p-value" min="0" max="1" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Top K</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-top-k" min="0" max="100" step="1"><input type="number" id="param-top-k-value" min="0" max="100" step="1" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Frequency Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-freq-pen" min="-2" max="2" step="0.01"><input type="number" id="param-freq-pen-value" min="-2" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Presence Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-pres-pen" min="-2" max="2" step="0.01"><input type="number" id="param-pres-pen-value" min="-2" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Repetition Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-rep-pen" min="0" max="2" step="0.01"><input type="number" id="param-rep-pen-value" min="0" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <hr class="border-gray-200">
                        <div class="grid grid-cols-5 gap-4 items-center">
                            <label class="text-sm col-span-2">Max Response Tokens</label>
                            <input type="number" id="param-max-tokens" min="1" max="8192" step="1" class="light-input rounded-md p-1 col-span-3">
                        </div>
                        <div class="grid grid-cols-5 gap-4 items-center">
                            <label class="text-sm col-span-2">Context Size (Tokens)</label>
                            <input type="number" id="param-context-size" min="1" max="32768" step="1" class="light-input rounded-md p-1 col-span-3">
                        </div>
                        <div class="p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                            <div class="flex justify-between mb-1">
                                <span data-i18n="presets.remainingContext">剩余上下文：</span>
                                <span id="remaining-context" class="font-bold">0</span>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-2">
                                <div id="context-usage-bar" class="bg-primary-color h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="prompt-editor" class="w-full flex flex-col overflow-hidden border-gray-200">
                        <div class="flex justify-between items-center mb-2 flex-shrink-0">
                             <h3 class="font-bold text-lg" data-i18n="presets.promptEntries">提示词条目</h3>
                             <div class="flex items-center gap-2">
                                <button id="add-prompt-btn" class="w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-i18n-title="presets.addEntry" title="添加新条目"><i class="fas fa-plus"></i></button>
                                <button id="restore-prompts-btn" class="w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-i18n-title="presets.restoreDefaults" title="恢复默认"><i class="fas fa-undo"></i></button>
                             </div>
                        </div>
                        <div id="prompt-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="character-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3"><i class="fas fa-user-astronaut"></i><span data-i18n="char.title">角色管理</span></h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col gap-0 overflow-hidden">
                <!-- 角色选择区域 -->
                <div class="p-4 space-y-3 flex-shrink-0 border-b border-gray-200">
                    <label class="block text-sm font-medium" data-i18n="char.current">当前角色</label>

                    <!-- 角色预览卡片（点击打开弹窗） -->
                    <div id="char-preview-card" class="p-3 rounded-lg border-2 border-gray-200 hover:border-primary-color cursor-pointer transition-all bg-white">
                        <div class="flex items-center gap-3">
                            <img id="current-char-avatar-preview" src="https://placehold.co/48x48/5E5B9D/ffffff?text=AI" class="w-12 h-12 rounded-full object-cover border-2 border-primary-color">
                            <div class="flex-1">
                                <p id="current-char-name-preview" class="font-bold text-lg" data-i18n="char.noSelect">未选择角色</p>
                                <p class="text-sm text-gray-500" data-i18n="char.clickSelect">点击选择或创建角色</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                       <button id="char-new-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-plus"></i> <span data-i18n="char.new">新建角色</span></button>
                       <button id="open-char-selector-btn" class="py-2 text-sm btn-primary rounded-lg"><i class="fas fa-users"></i> <span data-i18n="char.switch">切换角色</span></button>
                    </div>

                    <div class="flex gap-2">
                        <button id="char-import-btn" class="flex-1 py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-upload"></i> <span data-i18n="char.import">导入角色</span></button>
                        <input type="file" id="char-import-file" class="hidden" accept=".json,.png">
                    </div>
                </div>

                <!-- 角色编辑器 -->
                <div id="char-editor-panel" class="w-full flex-1 flex flex-col overflow-y-auto p-4">
                    <div id="char-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-users fa-3x mb-4"></i>
                        <p data-i18n="char.selectTip">选择一个角色进行编辑，或导入/新建一个角色。</p>
                    </div>
                    <div id="char-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="char-editing-id">
                        <div class="flex items-start gap-4 flex-shrink-0">
                            <div class="flex-shrink-0 text-center">
                                <img id="char-editor-avatar" src="https://placehold.co/128x128/5E5B9D/ffffff?text=AI" class="w-32 h-32 rounded-lg object-cover mx-auto">
                                <label class="mt-2 text-sm text-primary-color hover:underline cursor-pointer" data-i18n="char.uploadAvatar">上传头像<input type="file" id="char-avatar-upload" class="hidden" accept="image/*"></label>
                            </div>
                            <div class="flex-1 space-y-3">
                                <input id="char-editor-name" type="text" data-i18n-placeholder="char.name" placeholder="角色名称" class="w-full text-xl font-bold light-input rounded-md p-2">
                                <input id="char-editor-tags" type="text" data-i18n-placeholder="char.tags" placeholder="标签（用逗号分隔，如: 女性, 助手, 幻想）" class="w-full text-sm light-input rounded-md p-2">
                                <div class="flex flex-wrap items-center gap-2">
                                     <button id="char-save-btn" class="py-1.5 px-4 text-sm btn-primary rounded-lg"><i class="fas fa-save mr-2"></i><span data-i18n="char.save">保存</span></button>
                                     <button id="char-export-btn" data-i18n-title="char.export" title="导出为 .json" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-download"></i></button>
                                     <button id="char-duplicate-btn" data-i18n-title="char.duplicate" title="复制" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-clone"></i></button>
                                     <button id="char-delete-btn" data-i18n-title="char.delete" title="删除" class="w-9 h-9 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-3 flex-1 overflow-y-auto">
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-desc" class="block text-sm font-medium" data-i18n="char.description">角色描述 (性格, 外貌, 对话示例等)</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('desc', '角色描述')" data-i18n-title="char.expandEdit" title="放大编辑">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-desc" class="w-full light-input rounded-md p-2 resize-y" rows="6"></textarea>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-first-mes" class="block text-sm font-medium" data-i18n="char.firstMessage">第一条消息</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('firstMes', '第一条消息')" data-i18n-title="char.expandEdit" title="放大编辑">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-first-mes" class="w-full light-input rounded-md p-2 resize-y" rows="4"></textarea>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-medium" data-i18n="char.alternateGreetings">备选开场白</label>
                                    <button id="add-greeting-btn" class="text-sm btn-primary px-3 py-1 rounded-lg">
                                        <i class="fas fa-plus mr-1"></i><span data-i18n="char.addGreeting">添加</span>
                                    </button>
                                </div>
                                <div id="alternate-greetings-list" class="space-y-2 max-h-64 overflow-y-auto">
                                    <!-- 备选开场白列表将在这里显示 -->
                                </div>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-creator-notes" class="block text-sm font-medium" data-i18n="char.creatorNotes">创作者的注释</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('creatorNotes', '创作者的注释')" data-i18n-title="char.expandEdit" title="放大编辑">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-creator-notes" class="w-full light-input rounded-md p-2 resize-y" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="world-info-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-book"></i><span data-i18n="worldInfo.title">世界书</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="w-full flex flex-col border-b border-gray-200">
                    <div class="p-3 space-y-2 flex-shrink-0 border-b border-gray-200">
                        <label class="block text-sm font-medium" data-i18n="worldInfo.select">选择世界书</label>
                        <select id="wi-world-select" class="w-full light-input rounded-md p-2"></select>
                         <div class="grid grid-cols-2 gap-2">
                            <button id="wi-new-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-plus"></i> <span data-i18n="worldInfo.newWorld">新世界</span></button>
                            <button id="wi-import-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-upload"></i> <span data-i18n="worldInfo.import">导入</span></button>
                            <input type="file" id="wi-import-file" class="hidden" accept=".json">
                            <button id="wi-export-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-download"></i> <span data-i18n="worldInfo.export">导出</span></button>
                            <button id="wi-delete-world-btn" class="py-2 text-sm btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i> <span data-i18n="worldInfo.delete">删除</span></button>
                        </div>
                    </div>
                    <div class="p-3 flex-shrink-0">
                        <button id="wi-new-entry-btn" class="w-full py-2 btn-primary rounded-lg"><i class="fas fa-plus mr-2"></i><span data-i18n="worldInfo.newEntry">新建条目</span></button>
                    </div>
                    <div id="wi-entry-list" class="overflow-y-auto p-3 pt-0 space-y-2" style="max-height: 30vh;">
                        </div>
                </div>
                <div id="wi-editor-panel" class="flex-1 flex flex-col overflow-y-auto p-3">
                    <div id="wi-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-file-alt fa-3x mb-4"></i>
                        <p data-i18n="worldInfo.selectTip">选择一个条目进行编辑，或新建一个条目。</p>
                    </div>
                    <div id="wi-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="wi-editing-entry-id">
                        <div class="flex flex-wrap items-center gap-4 flex-shrink-0">
                            <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-enabled" type="checkbox" class="w-5 h-5 accent-primary-color"><span data-i18n="worldInfo.enabled">启用</span></label>
                            <input id="wi-entry-name" type="text" data-i18n-placeholder="worldInfo.entryTitle" placeholder="条目标题 (可选)" class="flex-1 light-input rounded-md p-2 min-w-[200px]">
                            <button id="wi-clone-entry-btn" data-i18n-title="worldInfo.clone" title="克隆" class="w-10 h-10 btn-secondary rounded-lg flex-shrink-0"><i class="fas fa-clone"></i></button>
                            <button id="wi-delete-entry-btn" data-i18n-title="worldInfo.delete" title="删除" class="w-10 h-10 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600 flex-shrink-0"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="card p-4">
                             <label class="block text-sm font-medium mb-2" data-i18n="worldInfo.primaryKeys">主要关键字 (逗号分隔)</label>
                             <textarea id="wi-entry-keys" class="w-full light-input rounded-md p-2 resize-y" rows="2"></textarea>
                             <div class="grid grid-cols-2 gap-4 mt-3 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-keys-case-sensitive" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.caseSensitive">区分大小写</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-keys-whole-word" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.wholeWord">完整单词</span></label>
                             </div>
                        </div>
                         <div class="card p-4 flex-1 flex flex-col overflow-hidden min-h-[200px]">
                            <label for="wi-entry-content" class="block text-sm font-medium mb-2" data-i18n="worldInfo.content">内容</label>
                            <textarea id="wi-entry-content" class="w-full h-full flex-1 light-input rounded-md p-2 resize-y"></textarea>
                        </div>
                        <div class="card p-4 grid grid-cols-1 gap-4 text-sm flex-shrink-0">
                            <div><label class="block font-medium mb-1" data-i18n="worldInfo.position">插入位置</label>
                                <select id="wi-entry-position" class="w-full light-input rounded-md p-1.5">
                                    <option value="0">角色定义之前</option>
                                    <option value="1">角色定义之后</option>
                                    <option value="2">示例消息前 (↑EM)</option>
                                    <option value="3">示例消息后 (↓EM)</option>
                                    <option value="4">@D 🟢[系统]在深度</option>
                                    <option value="5">@D 🟣[用户]在深度</option>
                                    <option value="6">@D 🧠[AI]在深度</option>
                                </select>
                            </div>
                             <div><label class="block font-medium mb-1" data-i18n="worldInfo.role">角色</label>
                                <select id="wi-entry-role" class="w-full light-input rounded-md p-1.5">
                                    <option value="0">系统</option>
                                    <option value="1">用户</option>
                                    <option value="2">AI</option>
                                </select>
                             </div>
                            <div><label class="block font-medium mb-1" data-i18n="worldInfo.depth">深度</label><input id="wi-entry-depth" type="number" value="4" class="w-full light-input rounded-md p-1.5"></div>
                             <div><label class="block font-medium mb-1" data-i18n="worldInfo.priority">优先级</label><input id="wi-entry-priority" type="number" value="100" class="w-full light-input rounded-md p-1.5"></div>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-constant" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.constant">总是启用 (Constant)</span></label>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-selective" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.selective">选择性</span></label>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-exclude-recursion" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.excludeRecursion">排除递归</span></label>
                        </div>
                        <div class="card p-4">
                            <h4 class="font-medium mb-3 text-sm" data-i18n="worldInfo.matchSources">额外匹配来源</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-desc" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharDesc">角色描述</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-pers" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharPers">角色性格</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-scenario" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchScenario">情景</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-user-profile" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchUserProfile">用户设定描述</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-notes" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharNotes">角色备注</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-creator-notes" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCreatorNotes">创作者的注释</span></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="regex-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-code"></i><span data-i18n="regex.title">正则表达式</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col overflow-y-auto p-4 space-y-6">
                <div class="flex flex-wrap gap-2">
                    <button id="regex-new-global-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i><span data-i18n="regex.newGlobal">新建全局正则</span></button>
                    <button id="regex-new-local-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i><span data-i18n="regex.newLocal">新建局部正则</span></button>
                    <button id="regex-import-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-upload mr-2"></i><span data-i18n="regex.import">导入正则</span></button>
                    <input type="file" id="regex-import-file" class="hidden" accept=".json">
                </div>

                <div id="global-regex-section">
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2" data-i18n="regex.globalTitle">全局正则脚本</h3>
                    <p class="text-sm text-gray-500 mb-3" data-i18n="regex.globalDesc">影响所有角色，保存在本地设定中。</p>
                    <div id="global-regex-list" class="space-y-2">
                        </div>
                </div>

                <div id="local-regex-section">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="text-lg font-semibold" data-i18n="regex.localTitle">局部正则脚本</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <span class="text-sm" data-i18n="regex.enable">启用</span>
                            <input type="checkbox" id="local-regex-enable-toggle" class="switch">
                        </label>
                    </div>
                    <p class="text-sm text-gray-500 mb-3" data-i18n="regex.localDesc">只影响当前角色，保存在角色卡片中。</p>
                    <div id="local-regex-list" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>
    <div id="user-profile-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-users"></i><span data-i18n="user.title">用户管理</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>

            <div class="flex-1 flex flex-col gap-0 overflow-hidden">
                <!-- 用户选择区域 -->
                <div class="p-4 space-y-3 flex-shrink-0 border-b border-gray-200">
                    <label class="block text-sm font-medium" data-i18n="user.currentUser">当前用户</label>

                    <!-- 用户预览卡片（点击打开弹窗） -->
                    <div id="user-preview-card" class="p-3 rounded-lg border-2 border-gray-200 hover:border-primary-color cursor-pointer transition-all bg-white">
                        <div class="flex items-center gap-3">
                            <img id="current-user-avatar-preview" src="https://placehold.co/48x48/E4E6EB/1A1A1D?text=U" class="w-12 h-12 rounded-full object-cover border-2 border-primary-color">
                            <div class="flex-1">
                                <p id="current-user-name-preview" class="font-bold text-lg">默认用户</p>
                                <p id="current-user-status-preview" class="text-sm text-gray-500">在线</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="user-new-btn" class="py-2 text-sm btn-secondary rounded-lg">
                            <i class="fas fa-plus"></i> <span data-i18n="user.new">新建用户</span>
                        </button>
                        <button id="open-user-selector-btn" class="py-2 text-sm btn-primary rounded-lg">
                            <i class="fas fa-users"></i> <span data-i18n="user.switch">切换用户</span>
                        </button>
                    </div>
                </div>

                <!-- 用户编辑器 -->
                <div class="w-full flex-1 flex flex-col overflow-y-auto p-4">
                    <div id="user-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-user-circle fa-3x mb-4"></i>
                        <p data-i18n="user.selectTip">选择一个用户进行编辑，或创建新用户。</p>
                    </div>

                    <div id="user-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="user-editing-id">

                        <!-- 头像和基本信息 -->
                        <div class="flex items-start gap-4 flex-shrink-0">
                            <div class="flex-shrink-0 text-center">
                                <div class="relative">
                                    <img id="user-editor-avatar" src="https://placehold.co/128x128/E4E6EB/1A1A1D?text=U"
                                         class="w-32 h-32 rounded-lg object-cover">
                                    <label class="mt-2 text-sm text-primary-color hover:underline cursor-pointer block" data-i18n="user.uploadAvatar">
                                        上传头像
                                        <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <div class="flex-1 space-y-3">
                                <input id="user-editor-name" type="text" data-i18n-placeholder="user.name" placeholder="用户名称" class="w-full text-xl font-bold light-input rounded-md p-2">
                                <input id="user-editor-status" type="text" data-i18n-placeholder="user.status" placeholder="状态/心情" class="w-full light-input rounded-md p-2">
                                <div class="flex flex-wrap items-center gap-2">
                                    <button id="user-save-btn" class="py-1.5 px-4 text-sm btn-primary rounded-lg"><i class="fas fa-save mr-2"></i><span data-i18n="user.save">保存</span></button>
                                    <button id="user-use-btn" class="py-1.5 px-4 text-sm btn-secondary rounded-lg"><i class="fas fa-user-check mr-1"></i><span data-i18n="user.use">使用</span></button>
                                    <button id="user-duplicate-btn" data-i18n-title="user.duplicate" title="复制" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-clone"></i></button>
                                    <button id="user-delete-btn" data-i18n-title="user.delete" title="删除" class="w-9 h-9 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- 详细设定区域 - 使用卡片网格布局 -->
                        <div class="grid grid-cols-1 gap-4 flex-1 overflow-y-auto">
                            <div class="card p-4 flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="user-editor-description" class="block text-sm font-medium" data-i18n="user.description">用户角色描述（将发送给AI）</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openUserTextEditModal('description', '用户角色描述')" data-i18n-title="user.expandEdit" title="放大编辑">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="user-editor-description"
                                          data-i18n-placeholder="user.descriptionPlaceholder"
                                          placeholder="描述您的角色设定，例如：你是一名程序员，喜欢技术讨论..."
                                          class="w-full flex-1 light-input rounded-md p-2 resize-none min-h-[120px]"></textarea>
                            </div>

                            <div class="card p-4 flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="user-editor-system-prompt" class="block text-sm font-medium" data-i18n="user.systemPrompt">系统提示词（可选，将添加到系统消息）</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openUserTextEditModal('systemPrompt', '系统提示词')" data-i18n-title="user.expandEdit" title="放大编辑">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="user-editor-system-prompt"
                                          data-i18n-placeholder="user.systemPromptPlaceholder"
                                          placeholder="例如：请以专业的方式回答技术问题..."
                                          class="w-full flex-1 light-input rounded-md p-2 resize-none min-h-[100px]"></textarea>
                            </div>

                            <!-- 用户偏好设置 -->
                            <div class="card p-4">
                                <h3 class="font-medium mb-3" data-i18n="user.preferences">偏好设置</h3>
                                <div class="space-y-3">
                                    <!-- 语言选择 -->
                                    <div>
                                        <label for="language-select" class="block text-sm font-medium mb-1" data-i18n="user.language">界面语言</label>
                                        <select id="language-select" class="w-full light-input rounded-md p-2">
                                            <option value="zh">中文 (Chinese)</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="user-auto-announce" class="w-4 h-4 accent-primary-color">
                                            <span class="text-sm" data-i18n="user.autoAnnounce">自动发送用户描述</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="user-show-typing" class="w-4 h-4 accent-primary-color">
                                            <span class="text-sm" data-i18n="user.showTyping">显示打字状态</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-prompt-modal" class="modal-overlay sub-modal">
        <div class="modal-content card p-6" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
             <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="edit.promptTitle">编辑提示词条目</h2><div><button id="delete-prompt-btn" class="text-red-500 hover:text-red-700 mr-4"><i class="fas fa-trash"></i> <span data-i18n="edit.delete">删除</span></button><button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div></div>
            <input type="hidden" id="edit-prompt-index">
            <div class="space-y-4">
                <div><label for="prompt-name-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptName">名称</label><input id="prompt-name-input" type="text" class="w-full light-input rounded-md p-2"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="prompt-position-select" class="block text-sm font-medium mb-1" data-i18n="edit.promptPosition">位置</label><select id="prompt-position-select" class="w-full light-input rounded-md p-2"><option value="0" data-i18n="edit.positionRelative">相对 (Relative)</option><option value="1" data-i18n="edit.positionInChat">在聊天中 (In-chat)</option></select></div>
                    <div><label for="prompt-depth-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptDepth">深度 (Depth)</label><input id="prompt-depth-input" type="number" class="w-full light-input rounded-md p-2" min="0"></div>
                </div>
                <div><label for="prompt-content-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptContent">内容</label><textarea id="prompt-content-input" rows="8" class="w-full light-input rounded-md p-2 resize-y"></textarea></div>
                <button id="save-prompt-changes-btn" class="w-full py-2 btn-primary rounded-lg" data-i18n="edit.saveChanges">保存更改</button>
            </div>
        </div>
    </div>

    <div id="edit-regex-modal" class="modal-overlay sub-modal">
        <div class="modal-content card p-6" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="regexEdit.title">正则脚本编辑器</h2><button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div>
            <input type="hidden" id="edit-regex-id">
            <input type="hidden" id="edit-regex-scope">
            <div class="space-y-4 text-sm">
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.scriptName">脚本名称</label><input id="regex-name-input" type="text" class="w-full light-input rounded-md p-2"></div>
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.findPattern">查找正则表达式</label><textarea id="regex-find-input" rows="3" class="w-full light-input rounded-md p-2 font-mono text-xs"></textarea></div>
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.replaceWith">替换为</label><textarea id="regex-replace-input" rows="3" class="w-full light-input rounded-md p-2 font-mono text-xs"></textarea></div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block font-medium mb-1" data-i18n="regexEdit.scope">作用范围</label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="0" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeUserInput">用户输入 (User Input)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="1" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeAIOutput">AI输出 (AI Output)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="2" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeQuickReply">快捷命令 (Quick Reply)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="3" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeWorldInfo">世界信息 (World Info)</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium mb-1" data-i18n="regexEdit.options">其他选项</label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer"><input id="regex-markdown-only" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.markdownOnly">仅已禁用 (Markdown Only)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input id="regex-prompt-only" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.promptOnly">在编辑时运行 (Prompt Only)</span></label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-medium mb-1" data-i18n="regexEdit.minDepth">最小深度</label><input id="regex-min-depth" type="number" data-i18n-placeholder="regexEdit.noLimit" placeholder="无限" class="w-full light-input rounded-md p-2"></div>
                    <div><label class="block font-medium mb-1" data-i18n="regexEdit.maxDepth">最大深度</label><input id="regex-max-depth" type="number" data-i18n-placeholder="regexEdit.noLimit" placeholder="无限" class="w-full light-input rounded-md p-2"></div>
                </div>
                 <div class="flex gap-4 pt-2">
                    <button id="save-regex-changes-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="regexEdit.save">保存</button>
                    <button id="delete-regex-btn" class="flex-1 py-2 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600" data-i18n="regexEdit.delete">删除</button>
                </div>
            </div>
        </div>
    </div>

    <div id="import-regex-location-modal" class="modal-overlay super-sub-modal">
        <div class="modal-content w-full card p-6 text-center">
            <h3 class="text-xl font-bold mb-4" data-i18n="regexImport.title">导入至:</h3>
            <div class="space-y-3 mb-6">
                <label class="block p-4 rounded-lg border cursor-pointer hover:bg-gray-50"><input type="radio" name="import-location" value="global" class="mr-2" checked><span data-i18n="regexImport.global">全局正则脚本</span></label>
                <label class="block p-4 rounded-lg border cursor-pointer hover:bg-gray-50"><input type="radio" name="import-location" value="local" class="mr-2"><span data-i18n="regexImport.local">局部正则脚本</span></label>
            </div>
            <div class="flex gap-4">
                <button id="confirm-regex-import-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="regexImport.confirm">确认</button>
                <button id="cancel-regex-import-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="regexImport.cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 文本编辑放大弹窗 -->
    <div id="text-edit-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" id="text-edit-modal-title" data-i18n="textEdit.title">编辑文本</h2>
                <button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="text-edit-field-name">
            <div class="flex-1 flex flex-col">
                <textarea id="text-edit-textarea" class="w-full h-full light-input rounded-md p-3 resize-none"></textarea>
            </div>
            <div class="flex gap-4 pt-4 mt-auto flex-shrink-0">
                <button id="save-text-edit-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="textEdit.save">保存</button>
                <button class="close-sub-modal-btn flex-1 py-2 btn-secondary rounded-lg" data-i18n="textEdit.cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 备选开场白编辑弹窗 -->
    <div id="greeting-edit-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="greetingEdit.title">编辑开场白</h2>
                <button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="greeting-edit-index">
            <div class="flex-1 flex flex-col">
                <textarea id="greeting-edit-textarea" class="w-full h-full light-input rounded-md p-3 resize-none" data-i18n-placeholder="greetingEdit.placeholder" placeholder="输入开场白内容..."></textarea>
            </div>
            <div class="flex gap-4 pt-4 mt-auto flex-shrink-0">
                <button id="save-greeting-edit-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="greetingEdit.save">保存</button>
                <button class="close-sub-modal-btn flex-1 py-2 btn-secondary rounded-lg" data-i18n="greetingEdit.cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 用户选择弹窗 -->
    <div id="user-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-2xl card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-users mr-2"></i><span data-i18n="userSelector.title">选择用户</span></h2>
                <button class="close-user-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div id="user-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- 用户列表动态生成 -->
            </div>
        </div>
    </div>

    <!-- 角色选择弹窗 -->
    <div id="char-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-2xl card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-user-astronaut mr-2"></i><span data-i18n="charSelector.title">选择角色</span></h2>
                <button class="close-char-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- 名称搜索框 -->
            <div class="mb-4">
                <input id="char-name-search" type="text" data-i18n-placeholder="charSelector.searchPlaceholder" placeholder="搜索角色名称..." class="w-full light-input rounded-md p-2 text-sm">
            </div>

            <!-- 标签筛选器 -->
            <div class="mb-4">
                <input id="char-tag-filter" type="text" data-i18n-placeholder="charSelector.tagFilterPlaceholder" placeholder="按标签筛选（输入标签名称）" class="w-full light-input rounded-md p-2 text-sm">
                <div id="char-tag-list" class="flex flex-wrap gap-2 mt-2">
                    <!-- 标签列表动态生成 -->
                </div>
            </div>

            <div id="char-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- 角色列表动态生成 -->
            </div>
        </div>
    </div>

    <!-- 开场白选择弹窗 -->
    <div id="greeting-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-4xl card p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-comment-dots mr-2"></i><span data-i18n="greetingSelector.title">选择开场白</span></h2>
                <button class="close-greeting-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div id="greeting-list" class="space-y-3 overflow-y-auto flex-1">
                <!-- 开场白列表动态生成 -->
            </div>
        </div>
    </div>

    <div id="theme-settings-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="theme.title">🎨 主题设置</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- 标签页 -->
            <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200 pb-2">
                <button id="theme-tab-presets" class="px-3 py-2 border-b-2 border-primary-color font-medium text-sm whitespace-nowrap" onclick="switchThemeTab('presets')" data-i18n="theme.tabPresets">预设主题</button>
                <button id="theme-tab-custom" class="px-3 py-2 text-gray-500 text-sm whitespace-nowrap" onclick="switchThemeTab('custom')" data-i18n="theme.tabCustom">自定义CSS</button>
                <button id="theme-tab-saved" class="px-3 py-2 text-gray-500 text-sm whitespace-nowrap" onclick="switchThemeTab('saved')" data-i18n="theme.tabSaved">保存的主题</button>
            </div>

            <div class="space-y-4 overflow-y-auto pr-4 -mr-4">
                <!-- 预设主题页 -->
                <div id="theme-presets-content" class="theme-tab-content">
                    <div class="setting-group">
                        <label class="block text-sm font-medium mb-2" data-i18n="theme.presetThemes">预设主题</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="default" data-i18n="theme.default">默认</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="dark" data-i18n="theme.dark">暗黑</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="blue" data-i18n="theme.blue">海洋</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="green" data-i18n="theme.green">森林</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="purple" data-i18n="theme.purple">紫罗兰</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="pink" data-i18n="theme.pink">樱花</button>
                        </div>
                    </div>
                    <hr>
                    <div class="setting-group space-y-3">
                        <label class="block text-sm font-medium" data-i18n="theme.colorSettings">颜色设置</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.primary">主色调</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="primaryColorInput" class="color-input">
                                    <input type="text" id="primaryColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.userBubble">用户气泡</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="userBubbleColorInput" class="color-input">
                                    <input type="text" id="userBubbleColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.bg">背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="bgColorInput" class="color-input">
                                    <input type="text" id="bgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.aiBubble">AI气泡</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="aiBubbleColorInput" class="color-input">
                                    <input type="text" id="aiBubbleColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.cardBg">卡片背景</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="cardBgColorInput" class="color-input">
                                    <input type="text" id="cardBgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.text">文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="textColorInput" class="color-input">
                                    <input type="text" id="textColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.border">边框颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="borderColorInput" class="color-input">
                                    <input type="text" id="borderColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.inputBg">输入框背景</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="inputBgColorInput" class="color-input">
                                    <input type="text" id="inputBgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 自定义CSS页 -->
                <div id="theme-custom-content" class="theme-tab-content hidden">
                    <div class="setting-group">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium" data-i18n="theme.customCSS">自定义CSS</label>
                            <div class="flex gap-2">
                                <button id="css-format-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.format">格式化</button>
                                <button id="css-minify-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.minify">压缩</button>
                                <button id="css-preview-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.preview">预览</button>
                            </div>
                        </div>
                        <textarea id="custom-css-editor" class="w-full h-96 light-input rounded-md p-3 font-mono text-sm resize-y" data-i18n-placeholder="theme.customCSSPlaceholder" placeholder="/* 输入你的自定义CSS */
/* 例如: */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.9);
}

.chat-bubble.user-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}"></textarea>
                        <div class="mt-2 text-xs text-gray-500" data-i18n="theme.customCSSHint">
                            提示：可以覆盖所有现有的CSS变量和类。实时预览查看效果。
                        </div>
                    </div>

                    <hr>

                    <div class="setting-group">
                        <label class="block text-sm font-medium mb-2" data-i18n="theme.cssVarsRef">CSS变量参考</label>
                        <div class="bg-gray-100 p-3 rounded-lg max-h-48 overflow-y-auto">
                            <pre class="text-xs font-mono">--bg-color: 背景颜色
--card-bg-color: 卡片背景
--text-color: 文字颜色
--text-secondary-color: 次要文字颜色
--border-color: 边框颜色
--primary-color: 主色调
--primary-hover-color: 主色调悬停
--input-bg-color: 输入框背景
--user-bubble-color: 用户气泡颜色
--ai-bubble-color: AI气泡颜色
--bubble-opacity: 气泡透明度
--bubble-text-color: 气泡文字颜色
--user-bubble-text-color: 用户气泡文字颜色</pre>
                        </div>
                    </div>
                </div>

                <!-- 保存的主题页 -->
                <div id="theme-saved-content" class="theme-tab-content hidden">
                    <div class="setting-group">
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-medium" data-i18n="theme.myThemes">我的主题</label>
                            <button id="save-current-theme-btn" class="btn-primary px-4 py-2 text-sm rounded-lg">
                                <i class="fas fa-save mr-2"></i><span data-i18n="theme.saveCurrentTheme">保存当前主题</span>
                            </button>
                        </div>
                        <div id="saved-themes-list" class="space-y-2">
                            <!-- 动态生成的主题列表 -->
                        </div>
                        <div class="text-center text-gray-400 py-8" id="no-saved-themes">
                            <i class="fas fa-palette fa-3x mb-2"></i>
                            <p data-i18n="theme.noSavedThemes">还没有保存的主题</p>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="flex flex-wrap gap-4 pt-4 mt-auto">
                    <button id="applyThemeBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="theme.apply">应用</button>
                    <button id="saveAsThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.saveAsNew">另存为新主题</button>
                    <button id="exportThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.exportTheme">导出主题</button>
                    <button id="importThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.importTheme">导入主题</button>
                    <button id="resetThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.reset">重置为默认</button>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="themeImportFile" class="hidden" accept=".json">
    <input type="file" id="imageFileInput" class="hidden" accept="image/*">

    <!-- 偏好设置模态框 -->
    <div id="preferences-modal" class="modal-overlay">
        <div class="modal-content card" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6 p-6 pb-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="preferences.title">⚙️ 偏好设置</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-4 p-6 pt-4">
                <!-- 语言设置 -->
                <div class="card p-4">
                    <h3 class="font-medium mb-3" data-i18n="preferences.language">界面语言</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="language-select-pref" class="block text-sm font-medium mb-1">Language / 语言</label>
                            <select id="language-select-pref" class="w-full light-input rounded-md p-2">
                                <option value="zh">中文 (Chinese)</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 用户行为设置 -->
                <div class="card p-4">
                    <h3 class="font-medium mb-3" data-i18n="preferences.behavior">用户行为</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="user-auto-announce-pref" class="w-4 h-4 accent-primary-color">
                            <span class="text-sm" data-i18n="preferences.autoAnnounce">自动发送用户描述</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="user-show-typing-pref" class="w-4 h-4 accent-primary-color">
                            <span class="text-sm" data-i18n="preferences.showTyping">显示打字状态</span>
                        </label>
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div class="flex gap-4 pt-2">
                    <button id="save-preferences-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="preferences.save">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 总结聊天配置模态框 -->
    <div id="summarize-modal" class="modal-overlay">
        <div class="modal-content card overflow-y-auto" style="max-width: 1400px; max-height: 90vh; width: 95vw;">
            <div class="flex justify-between items-center mb-6 pt-2 px-2">
                <h2 class="text-xl font-bold primary-gradient-text" data-i18n="summary.title">
                    总结聊天设置
                </h2>
                <button id="summarize-modal-close" class="text-gray-400 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- API配置 -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-server text-purple-500"></i>
                        <span data-i18n="summary.apiConfig">总结API配置</span>
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.apiUrl">API地址</label>
                            <input type="text" id="summarize-api-url"
                                   class="w-full light-input rounded-md p-2"
                                   data-i18n-placeholder="summary.apiUrlPlaceholder"
                                   placeholder="https://api.openai.com/v1/chat/completions">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.apiKey">API密钥</label>
                            <input type="password" id="summarize-api-key"
                                   class="w-full light-input rounded-md p-2"
                                   data-i18n-placeholder="summary.apiKeyPlaceholder"
                                   placeholder="sk-...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.model">模型</label>
                            <div class="flex gap-2">
                                <select id="summarize-api-model-select" class="flex-1 light-input rounded-md p-2">
                                    <option value="" data-i18n="summary.selectModel">选择模型...</option>
                                    <option value="gpt-4o">gpt-4o</option>
                                    <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                                    <option value="gpt-4">gpt-4</option>
                                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                    <option value="custom" data-i18n="summary.customModel">自定义...</option>
                                </select>
                                <button id="fetch-models-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.loadConfig" title="从API获取模型列表">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <input type="text" id="summarize-api-model"
                                   class="w-full light-input rounded-md p-2 mt-2 hidden"
                                   data-i18n-placeholder="summary.customModelPlaceholder"
                                   placeholder="输入自定义模型名称"
                                   value="gpt-4o-mini">
                        </div>
                        <div class="flex gap-2">
                            <button id="save-summarize-api-config-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n-title="summary.saveConfig" title="保存API配置">
                                <i class="fas fa-save mr-2"></i><span data-i18n="summary.saveConfig">保存配置</span>
                            </button>
                            <button id="load-summarize-api-config-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n-title="summary.loadConfig" title="加载API配置">
                                <i class="fas fa-upload mr-2"></i><span data-i18n="summary.loadConfig">加载配置</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 总结设置 -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-cog text-blue-500"></i>
                        <span data-i18n="summary.settings">总结设置</span>
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.messageCount">总结楼层数</label>
                            <input type="number" id="summarize-floor-count"
                                   class="w-full light-input rounded-md p-2"
                                   placeholder="10"
                                   value="10"
                                   min="1">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="summary.messageCountHint">总结最近的N条消息</p>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="summarize-auto-enable"
                                       class="w-4 h-4 accent-primary-color">
                                <span class="text-sm font-medium" data-i18n="summary.autoEnable">启用自动总结</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6" data-i18n="summary.autoEnableHint">达到设置的楼层数后自动触发总结</p>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="summarize-auto-hide"
                                       class="w-4 h-4 accent-primary-color" checked>
                                <span class="text-sm" data-i18n="summary.autoHide">自动隐藏已总结的消息</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6" data-i18n="summary.autoHideHint">隐藏的消息不会发送给AI</p>
                        </div>
                    </div>
                </div>

                <!-- 提示词模板 -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-file-alt text-green-500"></i>
                        <span data-i18n="summary.promptTemplates">提示词模板</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <select id="summarize-prompt-templates" class="flex-1 light-input rounded-md p-2">
                                <option value="" data-i18n="summary.selectTemplate">选择模板...</option>
                            </select>
                            <button id="load-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.loadTemplate" title="加载模板">
                                <i class="fas fa-download"></i>
                            </button>
                            <button id="save-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.saveTemplate" title="保存为新模板">
                                <i class="fas fa-save"></i>
                            </button>
                            <button id="delete-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md hover:bg-red-100 hover:text-red-600" data-i18n-title="summary.deleteTemplate" title="删除模板">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.prompt">总结提示词</label>
                            <textarea id="summarize-prompt"
                                      class="w-full light-input rounded-md p-2 resize-y font-mono text-sm"
                                      rows="8"
                                      data-i18n-placeholder="summary.promptPlaceholder"
                                      placeholder="请总结以下对话内容...">请简明扼要地总结以下对话的关键信息、重要事件和角色状态变化。注意：
1. 保留重要的细节和情节发展
2. 记录角色的情绪和关系变化
3. 使用第三人称视角
4. 保持客观中立的语气
5. 控制在200字以内</textarea>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex flex-col sm:flex-row gap-3 mt-4">
                    <button id="start-summarize-btn" class="flex-1 py-3 btn-primary rounded-lg text-base">
                        <i class="fas fa-play mr-2"></i><span data-i18n="summary.start">开始总结</span>
                    </button>
                    <button id="test-summarize-api-btn" class="flex-1 py-3 btn-secondary rounded-lg text-base">
                        <i class="fas fa-vial mr-2"></i><span data-i18n="summary.test">测试API</span>
                    </button>
                </div>
                <div id="summarize-api-test-result" class="text-sm mt-3 text-center h-auto min-h-[1rem]"></div>
            </div>
        </div>
    </div>

    <!-- 消息编辑弹窗 -->
    <div id="message-edit-modal" class="message-editing-modal">
        <div class="modal-content card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold primary-gradient-text" data-i18n="msgEdit.title">编辑消息</h3>
                <div class="flex items-center gap-2">
                    <button id="toggle-expand-edit-message" class="text-gray-400 hover:text-primary-color transition-colors" data-i18n-title="msgEdit.expandWindow" title="扩大/缩小窗口">
                        <i class="fas fa-expand text-lg"></i>
                    </button>
                    <button id="close-edit-message" class="text-gray-400 hover:text-gray-800">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" data-i18n="msgEdit.content">消息内容</label>
                <textarea id="edit-message-textarea" class="message-edit-textarea light-input rounded-md" rows="6"></textarea>
            </div>
            <div class="flex gap-3">
                <button id="save-edit-message" class="flex-1 btn-primary py-2 rounded-lg">
                    <i class="fas fa-check mr-2"></i><span data-i18n="msgEdit.save">保存</span>
                </button>
                <button id="cancel-edit-message" class="flex-1 btn-secondary py-2 rounded-lg">
                    <i class="fas fa-times mr-2"></i><span data-i18n="msgEdit.cancel">取消</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 查看提示词模态框 - 改进版本，添加详细检查信息 -->
    <div id="prompt-preview-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="prompt.title">📝 发送提示词检查</h2>
                <button id="close-prompt-preview" class="text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- 提示词检查清单 -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-bold text-sm mb-2 text-blue-800" data-i18n="prompt.checkTitle">✅ 提示词包含项检查：</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div id="check-system-prompt" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkSystemPrompt">系统提示词</span>
                    </div>
                    <div id="check-user-profile" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkUserProfile">用户角色设定</span>
                    </div>
                    <div id="check-char-desc" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkCharDesc">角色描述</span>
                    </div>
                    <div id="check-world-info" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkWorldInfo">世界书信息</span>
                    </div>
                    <div id="check-chat-history" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkChatHistory">聊天历史</span>
                    </div>
                    <div id="check-regex" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkRegex">正则表达式处理</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-100 rounded-lg flex-wrap">
                <div class="flex-1 flex flex-wrap gap-x-4 gap-y-2 text-sm min-w-0">
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.totalTokens">总Token数：</span>
                        <span id="total-tokens" class="text-primary-color font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.systemTokens">系统提示：</span>
                        <span id="system-tokens" class="text-blue-600">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.chatTokens">聊天历史：</span>
                        <span id="chat-tokens" class="text-green-600">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.worldTokens">世界书：</span>
                        <span id="world-tokens" class="text-purple-600">0</span>
                    </div>
                </div>
                <button id="copy-prompt-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-copy mr-2"></i><span data-i18n="prompt.copy">复制</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto">
                <div id="prompt-preview-content" class="space-y-4"></div>
            </div>
        </div>
    </div>
    <!-- 多选工具栏已移除 -->


    <script>
        // --- 多语言系统 ---
        const i18n = {
            currentLang: 'zh',
            translations: {
                zh: {
                    // 侧边栏
                    'sidebar.api': 'API 设置',
                    'sidebar.character': '角色卡',
                    'sidebar.presets': 'AI 预设',
                    'sidebar.worldInfo': '世界书',
                    'sidebar.regex': '正则表达式',
                    'sidebar.theme': '主题设置',
                    'sidebar.preferences': '偏好设置',
                    'sidebar.user': '用户/UI设置',
                    'sidebar.newChat': '新对话',
                    'sidebar.summarize': '总结聊天',
                    'sidebar.promptPreview': 'Prompt预览',

                    // API设置
                    'api.title': 'API 设置',
                    'api.configManage': 'API 配置管理',
                    'api.configName': '配置名称',
                    'api.configNamePlaceholder': '为此配置命名',
                    'api.loadSelected': '加载选中配置',
                    'api.deleteSelected': '删除选中配置',
                    'api.selectConfig': '选择配置',
                    'api.url': 'API URL (OpenAI 格式)',
                    'api.key': 'API Key',
                    'api.model': '模型列表',
                    'api.modelPlaceholder': '例如 gpt-4-turbo',
                    'api.loadModels': '刷新',
                    'api.streaming': '流式传输',
                    'api.temperature': '温度',
                    'api.maxTokens': '最大生成Token数',
                    'api.supportedFormats': '支持格式:',
                    'api.note': '注意:',
                    'api.googleKeyNote': 'Google API密钥以 `AIza...` 开头.',
                    'api.visionTitle': '🖼️ 识图 API 设置 (可选)',
                    'api.visionDescription': '用于发送图片时让AI能够理解图片内容。',
                    'api.visionUrl': '识图 API URL',
                    'api.visionKey': '识图 API Key',
                    'api.visionModel': '识图模型',
                    'api.loadVisionModels': '加载识图模型',
                    'api.saveAsNew': '另存为新配置',
                    'api.updateCurrent': '更新当前配置',
                    'api.testConnection': '测试连接',
                    'api.debugModels': '调试模型',
                    'api.directChatTest': '直接测试聊天',
                    'api.save': '保存设置',
                    'api.test': '测试 API',
                    'api.placeholder.url': '例如: https://api.openai.com/v1',
                    'api.placeholder.key': '输入API Key',

                    // 角色管理
                    'char.title': '角色管理',
                    'char.current': '当前角色',
                    'char.noSelect': '未选择角色',
                    'char.clickSelect': '点击选择或创建角色',
                    'char.new': '新建角色',
                    'char.switch': '切换角色',
                    'char.import': '导入角色',
                    'char.export': '导出角色',
                    'char.selectTip': '选择一个角色进行编辑，或导入/新建一个角色。',
                    'char.name': '角色名称',
                    'char.uploadAvatar': '上传头像',
                    'char.tags': '标签（用逗号分隔，如: 女性, 助手, 幻想）',
                    'char.save': '保存',
                    'char.delete': '删除',
                    'char.duplicate': '复制',
                    'char.description': '角色描述 (性格, 外貌, 对话示例等)',
                    'char.personality': '性格',
                    'char.scenario': '场景',
                    'char.firstMessage': '第一条消息',
                    'char.alternateGreetings': '备选开场白',
                    'char.addGreeting': '添加',
                    'char.creatorNotes': '创作者的注释',
                    'char.expandEdit': '放大编辑',

                    // AI预设
                    'presets.title': 'AI 预设',
                    'presets.import': '导入',
                    'presets.export': '导出',
                    'presets.saveAsNew': '另存为新预设',
                    'presets.samplingParams': '采样参数',
                    'presets.estimatedTokens': '预估Token',
                    'presets.remainingContext': '剩余上下文：',
                    'presets.promptEntries': '提示词条目',
                    'presets.addEntry': '添加新条目',
                    'presets.restoreDefaults': '恢复默认',

                    // 世界书
                    'worldInfo.title': '世界书',
                    'worldInfo.select': '选择世界书',
                    'worldInfo.newWorld': '新世界',
                    'worldInfo.import': '导入',
                    'worldInfo.export': '导出',
                    'worldInfo.delete': '删除',
                    'worldInfo.newEntry': '新建条目',
                    'worldInfo.selectTip': '选择一个条目进行编辑，或新建一个条目。',
                    'worldInfo.enabled': '启用',
                    'worldInfo.entryTitle': '条目标题 (可选)',
                    'worldInfo.clone': '克隆',
                    'worldInfo.primaryKeys': '主要关键字 (逗号分隔)',
                    'worldInfo.caseSensitive': '区分大小写',
                    'worldInfo.wholeWord': '完整单词',
                    'worldInfo.content': '内容',
                    'worldInfo.insertPosition': '插入位置',
                    'worldInfo.role': '角色',
                    'worldInfo.depth': '深度',
                    'worldInfo.priority': '优先级',
                    'worldInfo.constant': '总是启用 (Constant)',
                    'worldInfo.selective': '选择性',
                    'worldInfo.excludeRecursion': '排除递归',
                    'worldInfo.additionalSources': '额外匹配来源',
                    'worldInfo.charDesc': '角色描述',
                    'worldInfo.charPersonality': '角色性格',
                    'worldInfo.scenario': '情景',
                    'worldInfo.userProfile': '用户设定描述',
                    'worldInfo.charNotes': '角色备注',
                    'worldInfo.creatorNotes': '创作者的注释',

                    // 正则表达式
                    'regex.title': '正则表达式',
                    'regex.newGlobal': '新建全局正则',
                    'regex.newLocal': '新建局部正则',
                    'regex.import': '导入正则',
                    'regex.globalScripts': '全局正则脚本',
                    'regex.globalTitle': '全局正则脚本',
                    'regex.globalDesc': '影响所有角色，保存在本地设定中。',
                    'regex.localScripts': '局部正则脚本',
                    'regex.localTitle': '局部正则脚本',
                    'regex.localDesc': '只影响当前角色，保存在角色卡片中。',
                    'regex.enable': '启用',

                    // 主题设置
                    'theme.title': '主题设置',
                    'theme.tabPresets': '预设主题',
                    'theme.tabCustom': '自定义CSS',
                    'theme.tabSaved': '保存的主题',
                    'theme.presetThemes': '预设主题',
                    'theme.customCSS': '自定义CSS',
                    'theme.savedThemes': '保存的主题',
                    'theme.default': '默认',
                    'theme.dark': '暗黑',
                    'theme.blue': '海洋',
                    'theme.ocean': '海洋',
                    'theme.green': '森林',
                    'theme.forest': '森林',
                    'theme.purple': '紫罗兰',
                    'theme.violet': '紫罗兰',
                    'theme.pink': '樱花',
                    'theme.sakura': '樱花',
                    'theme.colorSettings': '颜色设置',
                    'theme.primary': '主色调',
                    'theme.primaryColor': '主色调',
                    'theme.userBubble': '用户气泡',
                    'theme.bg': '背景色',
                    'theme.aiBubble': 'AI气泡',
                    'theme.cardBg': '卡片背景',
                    'theme.text': '文字颜色',
                    'theme.border': '边框颜色',
                    'theme.inputBg': '输入框背景',
                    'theme.textSecondary': '次要文字颜色',
                    'theme.primaryHover': '主色调悬停',
                    'theme.format': '格式化',
                    'theme.minify': '压缩',
                    'theme.preview': '预览',
                    'theme.customCSSPlaceholder': '/* 输入你的自定义CSS */',
                    'theme.customCSSHint': '提示：可以覆盖所有现有的CSS变量和类。实时预览查看效果。',
                    'theme.cssVarsRef': 'CSS变量参考',
                    'theme.myThemes': '我的主题',
                    'theme.saveCurrentTheme': '保存当前主题',
                    'theme.noSavedThemes': '还没有保存的主题',
                    'theme.apply': '应用',
                    'theme.saveAsNew': '另存为新主题',
                    'theme.exportTheme': '导出主题',
                    'theme.importTheme': '导入主题',
                    'theme.reset': '重置为默认',
                    'theme.save': '保存主题',

                    // 用户设置
                    'user.title': '用户管理',
                    'user.currentUser': '当前用户',
                    'user.defaultUser': '默认用户',
                    'user.online': '在线',
                    'user.new': '新建用户',
                    'user.newUser': '新建用户',
                    'user.switch': '切换用户',
                    'user.switchUser': '切换用户',
                    'user.selectTip': '选择一个用户进行编辑，或创建新用户。',
                    'user.uploadAvatar': '上传头像',
                    'user.name': '用户名称',
                    'user.avatar': '用户头像URL',
                    'user.status': '状态/心情',
                    'user.save': '保存',
                    'user.use': '使用',
                    'user.duplicate': '复制',
                    'user.delete': '删除',
                    'user.description': '用户角色描述（将发送给AI）',
                    'user.descriptionPlaceholder': '描述您的角色设定，例如：你是一名程序员，喜欢技术讨论...',
                    'user.systemPrompt': '系统提示词（可选，将添加到系统消息）',
                    'user.systemPromptPlaceholder': '例如：请以专业的方式回答技术问题...',
                    'user.expandEdit': '放大编辑',
                    'user.preferences': '偏好设置',
                    'user.language': '界面语言',
                    'user.autoAnnounce': '自动发送用户描述',
                    'user.showTyping': '显示打字状态',

                    // 聊天界面
                    'chat.reselectGreeting': '重选开场白',
                    'chat.moreOptions': '更多选项',
                    'chat.viewPrompt': '查看提示词',
                    'chat.newChat': '新对话',
                    'chat.sendImage': '发送图片',
                    'chat.summarize': '总结聊天',
                    'chat.exportConfig': '导出配置',
                    'chat.importConfig': '导入配置',
                    'chat.exportChat': '导出聊天记录',
                    'chat.importChat': '导入聊天记录',
                    'chat.inputPlaceholder': '输入消息...',
                    'chat.sendMessage': '发送消息',

                    // 偏好设置
                    'preferences.title': '偏好设置',
                    'preferences.language': '界面语言',
                    'preferences.behavior': '用户行为',
                    'preferences.autoAnnounce': '自动发送用户描述',
                    'preferences.showTyping': '显示打字状态',
                    'preferences.save': '保存设置',

                    // 总结聊天
                    'summary.title': '总结聊天设置',
                    'summary.apiConfig': '总结API配置',
                    'summary.apiUrl': 'API地址',
                    'summary.apiUrlPlaceholder': 'https://api.openai.com/v1/chat/completions',
                    'summary.apiKey': 'API密钥',
                    'summary.apiKeyPlaceholder': 'sk-...',
                    'summary.model': '模型',
                    'summary.selectModel': '选择模型...',
                    'summary.customModel': '自定义...',
                    'summary.customModelPlaceholder': '输入自定义模型名称',
                    'summary.saveConfig': '保存配置',
                    'summary.loadConfig': '加载配置',
                    'summary.settings': '总结设置',
                    'summary.messageCount': '总结楼层数',
                    'summary.messageCountHint': '总结最近的N条消息',
                    'summary.autoEnable': '启用自动总结',
                    'summary.autoEnableHint': '达到设置的楼层数后自动触发总结',
                    'summary.autoHide': '自动隐藏已总结的消息',
                    'summary.autoHideHint': '隐藏的消息不会发送给AI',
                    'summary.promptTemplates': '提示词模板',
                    'summary.selectTemplate': '选择模板...',
                    'summary.loadTemplate': '加载模板',
                    'summary.saveTemplate': '保存为新模板',
                    'summary.deleteTemplate': '删除模板',
                    'summary.prompt': '总结提示词',
                    'summary.promptPlaceholder': '请总结以下对话内容...',
                    'summary.start': '开始总结',
                    'summary.test': '测试 API',
                    'summary.processing': '总结处理中...',
                    'summary.result': '总结结果',

                    // Prompt预览
                    'prompt.title': 'Prompt 预览',
                    'prompt.checkTitle': '提示词包含项检查：',
                    'prompt.checkSystemPrompt': '系统提示词',
                    'prompt.checkUserProfile': '用户角色设定',
                    'prompt.checkCharDesc': '角色描述',
                    'prompt.checkWorldInfo': '世界书信息',
                    'prompt.checkChatHistory': '聊天历史',
                    'prompt.checkRegex': '正则表达式处理',
                    'prompt.refresh': '刷新预览',
                    'prompt.system': '系统提示',
                    'prompt.userPersona': '用户角色设定',
                    'prompt.charDesc': '角色描述',
                    'prompt.worldInfo': '世界书信息',
                    'prompt.chatHistory': '聊天历史',
                    'prompt.regex': '正则表达式处理',
                    'prompt.totalTokens': '总Token数：',
                    'prompt.systemTokens': '系统提示：',
                    'prompt.chatTokens': '聊天历史：',
                    'prompt.worldTokens': '世界书：',
                    'prompt.copy': '复制',

                    // 消息操作
                    'msg.edit': '编辑',
                    'msg.regenerate': '重新生成',
                    'msg.delete': '删除',
                    'msg.deleteConfirm': '确定要删除这条消息吗？',
                    'msg.send': '发送',
                    'msg.placeholder': '输入消息...',
                    'msg.imageRecognizing': '正在识别图片...',
                    'msg.imageInfo': '[图片]',

                    // 编辑模态框
                    'edit.promptTitle': '编辑提示词条目',
                    'edit.promptName': '名称',
                    'edit.promptPosition': '位置',
                    'edit.promptDepth': '深度 (Depth)',
                    'edit.promptContent': '内容',
                    'edit.saveChanges': '保存更改',
                    'edit.delete': '删除',
                    'edit.positionRelative': '相对 (Relative)',
                    'edit.positionInChat': '在聊天中 (In-chat)',

                    // 正则编辑模态框
                    'regexEdit.title': '正则脚本编辑器',
                    'regexEdit.scriptName': '脚本名称',
                    'regexEdit.findPattern': '查找正则表达式',
                    'regexEdit.replaceWith': '替换为',
                    'regexEdit.scope': '作用范围',
                    'regexEdit.scopeUserInput': '用户输入 (User Input)',
                    'regexEdit.scopeAIOutput': 'AI输出 (AI Output)',
                    'regexEdit.scopeQuickReply': '快捷命令 (Quick Reply)',
                    'regexEdit.scopeWorldInfo': '世界信息 (World Info)',
                    'regexEdit.options': '其他选项',
                    'regexEdit.markdownOnly': '仅已禁用 (Markdown Only)',
                    'regexEdit.promptOnly': '在编辑时运行 (Prompt Only)',
                    'regexEdit.minDepth': '最小深度',
                    'regexEdit.maxDepth': '最大深度',
                    'regexEdit.noLimit': '无限',
                    'regexEdit.save': '保存',
                    'regexEdit.delete': '删除',

                    // 导入正则位置模态框
                    'regexImport.title': '导入至:',
                    'regexImport.global': '全局正则脚本',
                    'regexImport.local': '局部正则脚本',
                    'regexImport.confirm': '确认',
                    'regexImport.cancel': '取消',

                    // 文本编辑模态框
                    'textEdit.title': '编辑文本',
                    'textEdit.save': '保存',
                    'textEdit.cancel': '取消',

                    // 消息编辑模态框
                    'msgEdit.title': '编辑消息',
                    'msgEdit.content': '消息内容',
                    'msgEdit.expandWindow': '扩大/缩小窗口',
                    'msgEdit.save': '保存',
                    'msgEdit.cancel': '取消',

                    // 开场白编辑模态框
                    'greetingEdit.title': '编辑开场白',
                    'greetingEdit.placeholder': '输入开场白内容...',
                    'greetingEdit.save': '保存',
                    'greetingEdit.cancel': '取消',

                    // 用户选择模态框
                    'userSelector.title': '选择用户',

                    // 角色选择模态框
                    'charSelector.title': '选择角色',
                    'charSelector.searchPlaceholder': '搜索角色名称...',
                    'charSelector.tagFilterPlaceholder': '按标签筛选（输入标签名称）',

                    // 开场白选择模态框
                    'greetingSelector.title': '选择开场白',

                    // 通用
                    'common.save': '保存',
                    'common.cancel': '取消',
                    'common.confirm': '确认',
                    'common.close': '关闭',
                    'common.loading': '加载中...',
                    'common.success': '成功',
                    'common.error': '错误',
                    'common.upload': '上传',
                    'common.use': '使用',
                    'common.clone': '克隆',
                    'common.copy': '复制',
                    'common.invisible': '占位',
                },
                en: {
                    // Sidebar
                    'sidebar.api': 'API Settings',
                    'sidebar.character': 'Character',
                    'sidebar.presets': 'AI Presets',
                    'sidebar.worldInfo': 'World Info',
                    'sidebar.regex': 'Regex',
                    'sidebar.theme': 'Theme',
                    'sidebar.preferences': 'Preferences',
                    'sidebar.user': 'User/UI',
                    'sidebar.newChat': 'New Chat',
                    'sidebar.summarize': 'Summarize',
                    'sidebar.promptPreview': 'Prompt Preview',

                    // API Settings
                    'api.title': 'API Settings',
                    'api.configManage': 'API Configuration Management',
                    'api.configName': 'Configuration Name',
                    'api.configNamePlaceholder': 'Name this configuration',
                    'api.loadSelected': 'Load selected configuration',
                    'api.deleteSelected': 'Delete selected configuration',
                    'api.selectConfig': 'Select configuration',
                    'api.url': 'API URL (OpenAI format)',
                    'api.key': 'API Key',
                    'api.model': 'Model List',
                    'api.modelPlaceholder': 'e.g. gpt-4-turbo',
                    'api.loadModels': 'Refresh',
                    'api.streaming': 'Streaming',
                    'api.temperature': 'Temperature',
                    'api.maxTokens': 'Max Tokens',
                    'api.supportedFormats': 'Supported formats:',
                    'api.note': 'Note:',
                    'api.googleKeyNote': 'Google API keys start with `AIza...`.',
                    'api.visionTitle': '🖼️ Vision API Settings (Optional)',
                    'api.visionDescription': 'For AI to understand image content when sending pictures.',
                    'api.visionUrl': 'Vision API URL',
                    'api.visionKey': 'Vision API Key',
                    'api.visionModel': 'Vision Model',
                    'api.loadVisionModels': 'Load Vision Models',
                    'api.saveAsNew': 'Save as New Configuration',
                    'api.updateCurrent': 'Update Current Configuration',
                    'api.testConnection': 'Test Connection',
                    'api.debugModels': 'Debug Models',
                    'api.directChatTest': 'Direct Chat Test',
                    'api.save': 'Save Settings',
                    'api.test': 'Test API',
                    'api.placeholder.url': 'e.g., https://api.openai.com/v1',
                    'api.placeholder.key': 'Enter API Key',

                    // Character Management
                    'char.title': 'Character Management',
                    'char.current': 'Current Character',
                    'char.noSelect': 'No Character Selected',
                    'char.clickSelect': 'Click to select or create a character',
                    'char.new': 'New Character',
                    'char.switch': 'Switch Character',
                    'char.import': 'Import Character',
                    'char.export': 'Export Character',
                    'char.selectTip': 'Select a character to edit, or import/create a new one.',
                    'char.name': 'Character Name',
                    'char.uploadAvatar': 'Upload Avatar',
                    'char.tags': 'Tags (comma-separated, e.g.: female, assistant, fantasy)',
                    'char.save': 'Save',
                    'char.delete': 'Delete',
                    'char.duplicate': 'Duplicate',
                    'char.description': 'Character Description (personality, appearance, dialogue examples, etc.)',
                    'char.personality': 'Personality',
                    'char.scenario': 'Scenario',
                    'char.firstMessage': 'First Message',
                    'char.alternateGreetings': 'Alternate Greetings',
                    'char.addGreeting': 'Add',
                    'char.creatorNotes': 'Creator Notes',
                    'char.expandEdit': 'Expand Editor',

                    // AI Presets
                    'presets.title': 'AI Presets',
                    'presets.import': 'Import',
                    'presets.export': 'Export',
                    'presets.saveAsNew': 'Save as New Preset',
                    'presets.samplingParams': 'Sampling Parameters',
                    'presets.estimatedTokens': 'Estimated Tokens',
                    'presets.remainingContext': 'Remaining Context:',
                    'presets.promptEntries': 'Prompt Entries',
                    'presets.addEntry': 'Add New Entry',
                    'presets.restoreDefaults': 'Restore Defaults',

                    // World Info
                    'worldInfo.title': 'World Info',
                    'worldInfo.select': 'Select World Info',
                    'worldInfo.newWorld': 'New World',
                    'worldInfo.import': 'Import',
                    'worldInfo.export': 'Export',
                    'worldInfo.delete': 'Delete',
                    'worldInfo.newEntry': 'New Entry',
                    'worldInfo.selectTip': 'Select an entry to edit, or create a new one.',
                    'worldInfo.enabled': 'Enabled',
                    'worldInfo.entryTitle': 'Entry Title (optional)',
                    'worldInfo.clone': 'Clone',
                    'worldInfo.primaryKeys': 'Primary Keywords (comma-separated)',
                    'worldInfo.caseSensitive': 'Case Sensitive',
                    'worldInfo.wholeWord': 'Whole Word',
                    'worldInfo.content': 'Content',
                    'worldInfo.insertPosition': 'Insert Position',
                    'worldInfo.role': 'Role',
                    'worldInfo.depth': 'Depth',
                    'worldInfo.priority': 'Priority',
                    'worldInfo.constant': 'Always Enabled (Constant)',
                    'worldInfo.selective': 'Selective',
                    'worldInfo.excludeRecursion': 'Exclude Recursion',
                    'worldInfo.additionalSources': 'Additional Match Sources',
                    'worldInfo.charDesc': 'Character Description',
                    'worldInfo.charPersonality': 'Character Personality',
                    'worldInfo.scenario': 'Scenario',
                    'worldInfo.userProfile': 'User Profile Description',
                    'worldInfo.charNotes': 'Character Notes',
                    'worldInfo.creatorNotes': 'Creator Notes',

                    // Regex
                    'regex.title': 'Regular Expressions',
                    'regex.newGlobal': 'New Global Regex',
                    'regex.newLocal': 'New Local Regex',
                    'regex.import': 'Import Regex',
                    'regex.globalScripts': 'Global Regex Scripts',
                    'regex.globalTitle': 'Global Regex Scripts',
                    'regex.globalDesc': 'Affects all characters, saved in local settings.',
                    'regex.localScripts': 'Local Regex Scripts',
                    'regex.localTitle': 'Local Regex Scripts',
                    'regex.localDesc': 'Only affects current character, saved in character card.',
                    'regex.enable': 'Enable',

                    // Theme Settings
                    'theme.title': 'Theme Settings',
                    'theme.tabPresets': 'Presets',
                    'theme.tabCustom': 'Custom CSS',
                    'theme.tabSaved': 'Saved',
                    'theme.presetThemes': 'Preset Themes',
                    'theme.customCSS': 'Custom CSS',
                    'theme.savedThemes': 'Saved Themes',
                    'theme.default': 'Default',
                    'theme.dark': 'Dark',
                    'theme.blue': 'Ocean',
                    'theme.ocean': 'Ocean',
                    'theme.green': 'Forest',
                    'theme.forest': 'Forest',
                    'theme.purple': 'Violet',
                    'theme.violet': 'Violet',
                    'theme.pink': 'Sakura',
                    'theme.sakura': 'Sakura',
                    'theme.colorSettings': 'Color Settings',
                    'theme.primary': 'Primary Color',
                    'theme.primaryColor': 'Primary Color',
                    'theme.userBubble': 'User Bubble',
                    'theme.bg': 'Background',
                    'theme.aiBubble': 'AI Bubble',
                    'theme.cardBg': 'Card Background',
                    'theme.text': 'Text Color',
                    'theme.border': 'Border Color',
                    'theme.inputBg': 'Input Background',
                    'theme.textSecondary': 'Secondary Text',
                    'theme.primaryHover': 'Primary Hover',
                    'theme.format': 'Format',
                    'theme.minify': 'Minify',
                    'theme.preview': 'Preview',
                    'theme.customCSSPlaceholder': '/* Enter your custom CSS */',
                    'theme.customCSSHint': 'Tip: You can override all existing CSS variables and classes. Use preview to see effects.',
                    'theme.cssVarsRef': 'CSS Variables Reference',
                    'theme.myThemes': 'My Themes',
                    'theme.saveCurrentTheme': 'Save Current Theme',
                    'theme.noSavedThemes': 'No saved themes yet',
                    'theme.apply': 'Apply',
                    'theme.saveAsNew': 'Save as New Theme',
                    'theme.exportTheme': 'Export Theme',
                    'theme.importTheme': 'Import Theme',
                    'theme.reset': 'Reset to Default',
                    'theme.save': 'Save Theme',

                    // User Settings
                    'user.title': 'User Management',
                    'user.currentUser': 'Current User',
                    'user.defaultUser': 'Default User',
                    'user.online': 'Online',
                    'user.new': 'New User',
                    'user.newUser': 'New User',
                    'user.switch': 'Switch User',
                    'user.switchUser': 'Switch User',
                    'user.selectTip': 'Select a user to edit, or create a new one.',
                    'user.uploadAvatar': 'Upload Avatar',
                    'user.name': 'User Name',
                    'user.avatar': 'Avatar URL',
                    'user.status': 'Status/Mood',
                    'user.save': 'Save',
                    'user.use': 'Use',
                    'user.duplicate': 'Duplicate',
                    'user.delete': 'Delete',
                    'user.description': 'User Persona (sent to AI)',
                    'user.descriptionPlaceholder': 'Describe your persona, e.g.: You are a programmer who enjoys tech discussions...',
                    'user.systemPrompt': 'System Prompt (optional, added to system message)',
                    'user.systemPromptPlaceholder': 'E.g.: Please answer technical questions professionally...',
                    'user.expandEdit': 'Expand Edit',
                    'user.preferences': 'Preferences',
                    'user.language': 'Interface Language',
                    'user.autoAnnounce': 'Auto-send user description',
                    'user.showTyping': 'Show typing indicator',

                    // Chat Interface
                    'chat.reselectGreeting': 'Reselect Greeting',
                    'chat.moreOptions': 'More Options',
                    'chat.viewPrompt': 'View Prompt',
                    'chat.newChat': 'New Chat',
                    'chat.sendImage': 'Send Image',
                    'chat.summarize': 'Summarize Chat',
                    'chat.exportConfig': 'Export Configuration',
                    'chat.importConfig': 'Import Configuration',
                    'chat.exportChat': 'Export Chat History',
                    'chat.importChat': 'Import Chat History',
                    'chat.inputPlaceholder': 'Type a message...',
                    'chat.sendMessage': 'Send Message',

                    // Preferences
                    'preferences.title': 'Preferences',
                    'preferences.language': 'Interface Language',
                    'preferences.behavior': 'User Behavior',
                    'preferences.autoAnnounce': 'Auto-send user description',
                    'preferences.showTyping': 'Show typing indicator',
                    'preferences.save': 'Save Settings',

                    // Summarize Chat
                    'summary.title': 'Summarize Chat Settings',
                    'summary.apiConfig': 'Summary API Configuration',
                    'summary.apiUrl': 'API URL',
                    'summary.apiUrlPlaceholder': 'https://api.openai.com/v1/chat/completions',
                    'summary.apiKey': 'API Key',
                    'summary.apiKeyPlaceholder': 'sk-...',
                    'summary.model': 'Model',
                    'summary.selectModel': 'Select model...',
                    'summary.customModel': 'Custom...',
                    'summary.customModelPlaceholder': 'Enter custom model name',
                    'summary.saveConfig': 'Save Configuration',
                    'summary.loadConfig': 'Load Configuration',
                    'summary.settings': 'Summary Settings',
                    'summary.messageCount': 'Message Count',
                    'summary.messageCountHint': 'Summarize the last N messages',
                    'summary.autoEnable': 'Enable auto-summarize',
                    'summary.autoEnableHint': 'Auto-trigger summary when reaching set message count',
                    'summary.autoHide': 'Auto-hide summarized messages',
                    'summary.autoHideHint': 'Hidden messages won\'t be sent to AI',
                    'summary.promptTemplates': 'Prompt Templates',
                    'summary.selectTemplate': 'Select template...',
                    'summary.loadTemplate': 'Load template',
                    'summary.saveTemplate': 'Save as new template',
                    'summary.deleteTemplate': 'Delete template',
                    'summary.prompt': 'Summary Prompt',
                    'summary.promptPlaceholder': 'Please summarize the following conversation...',
                    'summary.start': 'Start Summary',
                    'summary.test': 'Test API',
                    'summary.processing': 'Summarizing...',
                    'summary.result': 'Summary Result',

                    // Prompt Preview
                    'prompt.title': 'Prompt Preview',
                    'prompt.checkTitle': 'Prompt Components Check:',
                    'prompt.checkSystemPrompt': 'System Prompt',
                    'prompt.checkUserProfile': 'User Persona',
                    'prompt.checkCharDesc': 'Character Description',
                    'prompt.checkWorldInfo': 'World Info',
                    'prompt.checkChatHistory': 'Chat History',
                    'prompt.checkRegex': 'Regex Processing',
                    'prompt.refresh': 'Refresh Preview',
                    'prompt.system': 'System Prompt',
                    'prompt.userPersona': 'User Persona',
                    'prompt.charDesc': 'Character Description',
                    'prompt.worldInfo': 'World Info',
                    'prompt.chatHistory': 'Chat History',
                    'prompt.regex': 'Regex Processing',
                    'prompt.totalTokens': 'Total Tokens: ',
                    'prompt.systemTokens': 'System: ',
                    'prompt.chatTokens': 'Chat: ',
                    'prompt.worldTokens': 'World: ',
                    'prompt.copy': 'Copy',

                    // Message Actions
                    'msg.edit': 'Edit',
                    'msg.regenerate': 'Regenerate',
                    'msg.delete': 'Delete',
                    'msg.deleteConfirm': 'Delete this message?',
                    'msg.send': 'Send',
                    'msg.placeholder': 'Type a message...',
                    'msg.imageRecognizing': 'Recognizing image...',
                    'msg.imageInfo': '[Image]',

                    // Message Edit Modal
                    'msgEdit.title': 'Edit Message',
                    'msgEdit.content': 'Message Content',
                    'msgEdit.expandWindow': 'Expand/Collapse window',
                    'msgEdit.save': 'Save',
                    'msgEdit.cancel': 'Cancel',

                    // Greeting Edit Modal
                    'greetingEdit.title': 'Edit Greeting',
                    'greetingEdit.placeholder': 'Enter greeting content...',
                    'greetingEdit.save': 'Save',
                    'greetingEdit.cancel': 'Cancel',

                    // User Selector Modal
                    'userSelector.title': 'Select User',

                    // Character Selector Modal
                    'charSelector.title': 'Select Character',
                    'charSelector.searchPlaceholder': 'Search character name...',
                    'charSelector.tagFilterPlaceholder': 'Filter by tag (enter tag name)',

                    // Greeting Selector Modal
                    'greetingSelector.title': 'Select Greeting',

                    // Edit Modals
                    'edit.promptTitle': 'Edit Prompt Entry',
                    'edit.promptName': 'Name',
                    'edit.promptPosition': 'Position',
                    'edit.promptDepth': 'Depth',
                    'edit.promptContent': 'Content',
                    'edit.saveChanges': 'Save Changes',
                    'edit.delete': 'Delete',
                    'edit.positionRelative': 'Relative',
                    'edit.positionInChat': 'In-chat',

                    // Regex Edit Modal
                    'regexEdit.title': 'Regex Script Editor',
                    'regexEdit.scriptName': 'Script Name',
                    'regexEdit.findPattern': 'Find Regex',
                    'regexEdit.replaceWith': 'Replace With',
                    'regexEdit.scope': 'Scope',
                    'regexEdit.scopeUserInput': 'User Input',
                    'regexEdit.scopeAIOutput': 'AI Output',
                    'regexEdit.scopeQuickReply': 'Quick Reply',
                    'regexEdit.scopeWorldInfo': 'World Info',
                    'regexEdit.options': 'Other Options',
                    'regexEdit.markdownOnly': 'Markdown Only',
                    'regexEdit.promptOnly': 'Prompt Only',
                    'regexEdit.minDepth': 'Min Depth',
                    'regexEdit.maxDepth': 'Max Depth',
                    'regexEdit.noLimit': 'Unlimited',
                    'regexEdit.save': 'Save',
                    'regexEdit.delete': 'Delete',

                    // Regex Import Modal
                    'regexImport.title': 'Import to:',
                    'regexImport.global': 'Global Regex Scripts',
                    'regexImport.local': 'Local Regex Scripts',
                    'regexImport.confirm': 'Confirm',
                    'regexImport.cancel': 'Cancel',

                    // Text Edit Modal
                    'textEdit.title': 'Edit Text',
                    'textEdit.save': 'Save',
                    'textEdit.cancel': 'Cancel',

                    // Common
                    'common.save': 'Save',
                    'common.cancel': 'Cancel',
                    'common.confirm': 'Confirm',
                    'common.close': 'Close',
                    'common.loading': 'Loading...',
                    'common.success': 'Success',
                    'common.error': 'Error',
                }
            },

            // 获取翻译文本
            t(key, lang = null) {
                const targetLang = lang || this.currentLang;
                return this.translations[targetLang]?.[key] || key;
            },

            // 切换语言
            setLanguage(lang) {
                this.currentLang = lang;
                localStorage.setItem('app_language', lang);
                this.updatePageTexts();
            },

            // 更新页面所有文本
            updatePageTexts() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const attr = el.getAttribute('data-i18n-attr');
                    if (attr) {
                        el.setAttribute(attr, this.t(key));
                    } else {
                        el.textContent = this.t(key);
                    }
                });

                // 更新 placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = this.t(key);
                });

                // 更新 title
                document.querySelectorAll('[data-i18n-title]').forEach(el => {
                    const key = el.getAttribute('data-i18n-title');
                    el.title = this.t(key);
                });
            },

            // 初始化
            init() {
                const savedLang = localStorage.getItem('app_language') || 'zh';
                this.currentLang = savedLang;
                // 页面加载完成后更新文本
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.updatePageTexts());
                } else {
                    this.updatePageTexts();
                }
            }
        };

        // 初始化多语言系统
        i18n.init();

        // --- IndexedDB 封装类 ---
        class IndexedDBStorage {
            constructor(dbName = 'SillyTavernDB', storeName = 'keyValueStore', version = 1) {
                this.dbName = dbName;
                this.storeName = storeName;
                this.version = version;
                this.db = null;
                this.initPromise = this.init();
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('IndexedDB 打开失败:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB 初始化成功');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'key' });
                            console.log('IndexedDB 对象存储创建成功');
                        }
                    };
                });
            }

            async setItem(key, value) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put({ key, value });

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB setItem 失败:', request.error);
                        reject(request.error);
                    };
                });
            }

            async getItem(key) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);

                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : null);
                    };
                    request.onerror = () => {
                        console.error('IndexedDB getItem 失败:', request.error);
                        reject(request.error);
                    };
                });
            }

            async removeItem(key) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB removeItem 失败:', request.error);
                        reject(request.error);
                    };
                });
            }

            async clear() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB clear 失败:', request.error);
                        reject(request.error);
                    };
                });
            }

            async getAllKeys() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAllKeys();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => {
                        console.error('IndexedDB getAllKeys 失败:', request.error);
                        reject(request.error);
                    };
                });
            }

            // 从 localStorage 迁移数据到 IndexedDB
            async migrateFromLocalStorage() {
                console.log('[数据迁移] 开始从 localStorage 迁移到 IndexedDB...');
                let migratedCount = 0;

                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        await this.setItem(key, value);
                        migratedCount++;
                    }
                    console.log(`[数据迁移] 成功迁移 ${migratedCount} 条数据`);

                    // 可选：清空 localStorage（谨慎操作）
                    // localStorage.clear();

                    return { success: true, count: migratedCount };
                } catch (error) {
                    console.error('[数据迁移] 迁移失败:', error);
                    return { success: false, error, count: migratedCount };
                }
            }

            // 计算当前存储使用情况
            async getStorageStats() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const items = request.result;
                        let totalSize = 0;
                        items.forEach(item => {
                            totalSize += JSON.stringify(item).length;
                        });

                        resolve({
                            itemCount: items.length,
                            totalSize: totalSize,
                            totalSizeKB: (totalSize / 1024).toFixed(2),
                            totalSizeMB: (totalSize / 1024 / 1024).toFixed(2)
                        });
                    };
                    request.onerror = () => {
                        console.error('IndexedDB getStorageStats 失败:', request.error);
                        reject(request.error);
                    };
                });
            }
        }

        // 创建全局 IndexedDB 存储实例
        const idbStorage = new IndexedDBStorage();

        // 全局聊天历史记录数组
        let chatHistory = []; // Array of { role: 'user'/'assistant', content: '...' }

        document.addEventListener('DOMContentLoaded', async () => {
            // 等待 IndexedDB 初始化完成
            await idbStorage.initPromise;
            console.log('IndexedDB 已就绪');

            // 检查是否需要从 localStorage 迁移数据
            const hasMigrated = await idbStorage.getItem('_migration_completed');
            if (!hasMigrated && localStorage.length > 0) {
                console.log('[初始化] 检测到 localStorage 数据，开始迁移...');
                const result = await idbStorage.migrateFromLocalStorage();
                if (result.success) {
                    await idbStorage.setItem('_migration_completed', 'true');
                    console.log('[初始化] 数据迁移完成');

                    // 显示迁移统计
                    const stats = await idbStorage.getStorageStats();
                    console.log('[存储统计]', stats);
                }
            }

            // --- 自动保存功能 ---
            let saveTimeout = null;
            const saveToast = document.getElementById('save-toast');

            // 显示保存提示
            function showSaveToast(message = '已自动保存') {
                const messageEl = saveToast.querySelector('.message');
                messageEl.textContent = message;
                saveToast.classList.add('show');
                setTimeout(() => {
                    saveToast.classList.remove('show');
                }, 2000);
            }

            // 防抖保存函数
            function triggerAutoSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    console.log('[自动保存] 正在保存数据...');
                    showSaveToast('已自动保存');
                }, 1000); // 1秒后保存
            }

            // 监听所有可能修改数据的事件
            // 注意：由于saveCharacters等函数在后面定义，我们需要在后面再设置监听

            // --- Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
            const appWrapper = document.getElementById('app-wrapper');

            mobileSidebarToggle.addEventListener('click', () => {
                sidebar.classList.remove('collapsed');
            });

            document.addEventListener('click', function(event) {
                if (!sidebar.contains(event.target) && !mobileSidebarToggle.contains(event.target)) {
                    sidebar.classList.add('collapsed');
                }
            });

            // --- Modal Logic ---
            const mainModals = ['api-settings-modal', 'presets-modal', 'character-modal', 'world-info-modal', 'regex-modal', 'user-profile-modal', 'theme-settings-modal', 'preferences-modal'];
            
            document.querySelectorAll('#main-nav button').forEach(button => {
                button.addEventListener('click', () => { showModal(button.dataset.modal); });
            });
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    closeAllModals();
                    modal.classList.add('active');
                    document.querySelector(`[data-modal="${modalId}"]`).classList.add('active');
                    sidebar.classList.add('collapsed');
                }
            }
            function closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    if (!modal.classList.contains('sub-modal') && !modal.classList.contains('super-sub-modal')) modal.classList.remove('active');
                });
                document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.remove('active'));
            }
            
            document.querySelectorAll('.modal-overlay:not(.sub-modal):not(.super-sub-modal)').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeAllModals(); });
            });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeAllModals));

            const editPromptModal = document.getElementById('edit-prompt-modal');
            editPromptModal.addEventListener('click', (e) => { if (e.target === editPromptModal) closeEditPromptModal(); });
            document.querySelectorAll('#edit-prompt-modal .close-sub-modal-btn').forEach(btn => btn.addEventListener('click', closeEditPromptModal));
            
            const editRegexModal = document.getElementById('edit-regex-modal');
            editRegexModal.addEventListener('click', (e) => { if (e.target === editRegexModal) closeEditRegexModal(); });
            document.querySelectorAll('#edit-regex-modal .close-sub-modal-btn').forEach(btn => btn.addEventListener('click', closeEditRegexModal));

            function openEditPromptModal(promptData, index) {
                document.getElementById('edit-prompt-index').value = index;
                document.getElementById('prompt-name-input').value = promptData.name || '';
                document.getElementById('prompt-position-select').value = promptData.injection_position ?? 0;
                document.getElementById('prompt-depth-input').value = promptData.injection_depth ?? 4;
                document.getElementById('prompt-content-input').value = promptData.content || '';
                editPromptModal.classList.add('active');
            }

            function closeEditPromptModal() {
                editPromptModal.classList.remove('active');
            }
            
            function openEditRegexModal() { editRegexModal.classList.add('active'); }
            function closeEditRegexModal() { editRegexModal.classList.remove('active'); }

            // --- PNG tEXt Chunk Reader ---
            // Based on https://github.com/sillytavern/sillytavern-extras/blob/main/png-metadata-reader/main.js
            async function extractPNGChunk(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const arr = new Uint8Array(event.target.result);
                        // Find the tEXt chunk for "chara"
                        const keyword = "chara";
                        let PngMagic = [137, 80, 78, 71, 13, 10, 26, 10];
                        if (!arr.slice(0, 8).every((val, i) => val === PngMagic[i])) {
                           return reject(new Error('Not a valid PNG file.'));
                        }

                        const decoder = new TextDecoder('utf-8');
                        let i = 8;
                        while (i < arr.length) {
                            const length = (arr[i] << 24) | (arr[i + 1] << 16) | (arr[i + 2] << 8) | arr[i + 3];
                            const type = String.fromCharCode(arr[i + 4], arr[i + 5], arr[i + 6], arr[i + 7]);

                            if (type === 'tEXt') {
                                const chunkData = arr.slice(i + 8, i + 8 + length);
                                let j = 0;
                                while (j < chunkData.length && chunkData[j] !== 0) { j++; }
                                const currentKeyword = decoder.decode(chunkData.slice(0, j));

                                if (currentKeyword === keyword) {
                                    const content = decoder.decode(chunkData.slice(j + 1));
                                    try {
                                        // Decode base64 to binary string
                                        const base64decoded = atob(content);
                                        // Convert binary string to UTF-8 bytes
                                        const bytes = new Uint8Array(base64decoded.length);
                                        for (let k = 0; k < base64decoded.length; k++) {
                                            bytes[k] = base64decoded.charCodeAt(k);
                                        }
                                        // Decode UTF-8 bytes to string
                                        const utf8String = new TextDecoder('utf-8').decode(bytes);
                                        const charData = JSON.parse(utf8String);
                                        return resolve({ charData, png: file });
                                    } catch (e) {
                                        return reject(new Error(`Failed to parse character data from PNG: ${e.message}`));
                                    }
                                }
                            }
                            i += 12 + length;
                        }
                        return reject(new Error('No "chara" metadata found in PNG file.'));
                    };
                    reader.onerror = () => reject(new Error('Failed to read file.'));
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // --- Advanced API Logic (Enhanced from Tea House) ---
            const api = {
                configName: document.getElementById('apiConfigNameInput'),
                url: document.getElementById('api-url'),
                key: document.getElementById('api-key'),
                modelName: document.getElementById('model-name'),
                streaming: document.getElementById('api-streaming-toggle'),
                visionUrl: document.getElementById('vision-api-url'),
                visionKey: document.getElementById('vision-api-key'),
                
                savedSelect: document.getElementById('savedApiSelect'),
                modelSelect: document.getElementById('model-select'),
                visionModelSelect: document.getElementById('vision-model-select'),
                
                loadBtn: document.getElementById('loadApiBtn'),
                deleteBtn: document.getElementById('deleteApiBtn'),
                saveAsNewBtn: document.getElementById('saveAsNewBtn'),
                updateCurrentBtn: document.getElementById('updateCurrentBtn'),
                testBtn: document.getElementById('testApiConnection'),
                debugModelsBtn: document.getElementById('debugModelsBtn'),
                directChatTestBtn: document.getElementById('directChatTestBtn'),
                loadModelsBtn: document.getElementById('load-models-btn'),
                loadVisionModelsBtn: document.getElementById('load-vision-models-btn'),
                
                resultDiv: document.getElementById('api-test-result'),
                visionResultDiv: document.getElementById('vision-api-test-result'),
                
                configs: {},
                currentId: null,
            };

            async function loadApiConfigs() {
                const configsData = await idbStorage.getItem('api_configs_v1');
                api.configs = configsData ? JSON.parse(configsData) : {};
                api.currentId = await idbStorage.getItem('current_api_id_v1');
                updateApiSelect();
                if (api.currentId && api.configs[api.currentId]) {
                    loadApiConfig(api.currentId);
                } else {
                    const firstId = Object.keys(api.configs)[0];
                    if(firstId) loadApiConfig(firstId);
                }
            }

            async function saveApiConfigs() {
                await idbStorage.setItem('api_configs_v1', JSON.stringify(api.configs));
                await idbStorage.setItem('current_api_id_v1', api.currentId);
            }

            function updateApiSelect() {
                api.savedSelect.innerHTML = '<option value="">选择配置</option>';
                Object.keys(api.configs).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = api.configs[id].name;
                    api.savedSelect.appendChild(option);
                });
                if (api.currentId) {
                    api.savedSelect.value = api.currentId;
                }
            }
            
            function loadApiConfig(id) {
                const config = api.configs[id];
                if (!config) return;

                api.configName.value = config.name || '';
                api.url.value = config.url || '';
                api.key.value = config.key || '';
                api.modelName.value = config.model || '';
                api.streaming.checked = config.streaming === undefined ? true : config.streaming; // Default to true
                api.visionUrl.value = config.visionUrl || '';
                api.visionKey.value = config.visionKey || '';

                api.modelSelect.innerHTML = '';
                (config.models || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = m;
                    api.modelSelect.appendChild(opt);
                });
                if(config.model) api.modelSelect.value = config.model;

                // 如果有模型列表，显示下拉框，隐藏输入框；否则相反
                const hasModels = config.models && config.models.length > 0;
                api.modelSelect.classList.toggle('hidden', !hasModels);
                api.modelName.classList.toggle('hidden', hasModels);

                api.visionModelSelect.innerHTML = '';
                 (config.visionModels || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = m;
                    api.visionModelSelect.appendChild(opt);
                });
                if(config.visionModel) api.visionModelSelect.value = config.visionModel;
                api.visionModelSelect.classList.toggle('hidden', !(config.visionModels && config.visionModels.length > 0));

                api.currentId = id;
                api.savedSelect.value = id;
                updateApiButtons();
            }

            function getCurrentApiConfigFromForm() {
                return {
                    name: api.configName.value.trim(),
                    url: api.url.value.trim(),
                    key: api.key.value.trim(),
                    model: api.modelName.value.trim(),
                    streaming: api.streaming.checked,
                    visionUrl: api.visionUrl.value.trim(),
                    visionKey: api.visionKey.value.trim(),
                    visionModel: api.visionModelSelect.value,
                    models: [...api.modelSelect.options].map(o => o.value).filter(o => o),
                    visionModels: [...api.visionModelSelect.options].map(o => o.value).filter(o => o),
                };
            }

            function updateApiButtons() {
                const hasSelection = !!api.savedSelect.value;
                const hasName = !!api.configName.value.trim();
                api.loadBtn.disabled = !hasSelection;
                api.deleteBtn.disabled = !hasSelection;
                api.updateCurrentBtn.disabled = !api.currentId || !hasName;
                api.saveAsNewBtn.disabled = !hasName;
            }

            api.savedSelect.addEventListener('change', updateApiButtons);
            api.configName.addEventListener('input', updateApiButtons);

            api.loadBtn.addEventListener('click', () => {
                if (api.savedSelect.value) loadApiConfig(api.savedSelect.value);
            });
            api.deleteBtn.addEventListener('click', async () => {
                const id = api.savedSelect.value;
                if(id && confirm(`确定要删除配置 "${api.configs[id].name}" 吗?`)){
                    delete api.configs[id];
                    if(api.currentId === id) {
                         api.currentId = null;
                         Object.keys(api).forEach(key => {
                             if (api[key].tagName === 'INPUT' || api[key].tagName === 'SELECT') {
                                 if (api[key].type === 'checkbox') api[key].checked = false;
                                 else api[key].value = '';
                             }
                         });
                    }
                    await saveApiConfigs();
                    await loadApiConfigs();
                }
            });
            api.saveAsNewBtn.addEventListener('click', async () => {
                const newConfig = getCurrentApiConfigFromForm();
                if(!newConfig.name) { alert("请输入配置名称"); return; }
                const newId = `api_${Date.now()}`;
                api.configs[newId] = newConfig;
                api.currentId = newId;
                await saveApiConfigs();
                updateApiSelect();
                api.savedSelect.value = newId;
                updateApiButtons();
                showApiResult("配置已保存！", "success", "resultDiv");
            });
            api.updateCurrentBtn.addEventListener('click', async () => {
                const id = api.currentId;
                if (!id) { alert("没有活动的配置可更新。请先加载一个或新建。"); return; }
                const updatedConfig = getCurrentApiConfigFromForm();
                if(!updatedConfig.name) { alert("请输入配置名称"); return; }

                console.log('[API配置] 准备更新配置:', id, updatedConfig);
                api.configs[id] = updatedConfig;
                await saveApiConfigs();
                console.log('[API配置] 配置已保存到存储');

                updateApiSelect();
                showApiResult("配置已更新！", "success", "resultDiv");

                // 验证保存
                const savedConfigs = await idbStorage.getItem('api_configs_v1');
                console.log('[API配置] 验证保存后的配置:', JSON.parse(savedConfigs));
            });

            function showApiResult(message, type, elementId) {
                const div = document.getElementById(elementId);
                div.innerHTML = message;
                div.className = `text-sm mt-2 text-center h-auto min-h-[1rem] ${type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-yellow-500'}`;
            }

            async function testConnection(isVision = false, isDebug = false) {
                const url = isVision ? api.visionUrl.value.trim() : api.url.value.trim();
                const key = isVision ? api.visionKey.value.trim() : api.key.value.trim();
                const resultDivId = isVision ? 'vision-api-test-result' : 'api-test-result';
                const btn = isDebug ? api.debugModelsBtn : api.testBtn;

                if (!url || !key) {
                    showApiResult('请填写 API URL 和 Key。', 'error', resultDivId);
                    return;
                }
                showApiResult('测试中...', 'info', resultDivId);
                btn.disabled = true;
                
                try {
                    let modelsUrl;
                    let headers = {};
                    const urlObj = new URL(url);

                    if (urlObj.hostname.includes('google')) {
                         modelsUrl = `${urlObj.origin}/v1beta/models?key=${key}`;
                    } else {
                        modelsUrl = `${url.replace(/\/$/, '')}/models`;
                        headers['Authorization'] = `Bearer ${key}`;
                    }
                    
                    const response = await fetch(modelsUrl, { headers });
                    if (response.ok) {
                        const data = await response.json();
                        let models = [];
                        if (data.data) models = data.data; // OpenAI format
                        else if (data.models) models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Google format

                        if (isDebug) {
                             const allModelIds = models.map(m => m.id).sort();
                             const debugHtml = `<details class="text-left"><summary>发现 ${allModelIds.length} 个模型</summary><pre class="bg-gray-100 p-2 rounded-md max-h-40 overflow-y-auto text-xs">${JSON.stringify(allModelIds, null, 2)}</pre></details>`;
                             showApiResult(debugHtml, 'success', resultDivId);
                        } else {
                            showApiResult(`连接成功！发现 ${models.length} 个模型`, 'success', resultDivId);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    showApiResult(`连接失败: ${error.message}`, 'error', resultDivId);
                } finally {
                    btn.disabled = false;
                }
            }

            async function loadModels(isVision = false) {
                const url = isVision ? api.visionUrl.value.trim() : api.url.value.trim();
                const key = isVision ? api.visionKey.value.trim() : api.key.value.trim();
                const btn = isVision ? api.loadVisionModelsBtn : api.loadModelsBtn;
                const select = isVision ? api.visionModelSelect : api.modelSelect;
                const input = isVision ? null : api.modelName; // 主模型有输入框
                const resultDivId = isVision ? 'vision-api-test-result' : 'api-test-result';

                const originalBtnText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>加载中...';
                btn.disabled = true;
                select.classList.add('hidden');
                if (input) input.classList.remove('hidden');

                try {
                    let modelsUrl;
                    let headers = {};
                    const urlObj = new URL(url);

                    if (urlObj.hostname.includes('google')) {
                         modelsUrl = `${urlObj.origin}/v1beta/models?key=${key}`;
                    } else {
                        modelsUrl = `${url.replace(/\/$/, '')}/models`;
                        headers['Authorization'] = `Bearer ${key}`;
                    }

                    const response = await fetch(modelsUrl, { headers });
                    if (!response.ok) throw new Error('无法获取模型列表');

                    const data = await response.json();
                    let models = [];
                    if (data.data) models = data.data; // OpenAI format
                    else if (data.models) models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Google format

                    select.innerHTML = '<option value="">--选择一个模型--</option>';
                    models.sort((a,b) => a.id.localeCompare(b.id)).forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        select.appendChild(option);
                    });

                    if (api.currentId && api.configs[api.currentId]) {
                        const currentConfig = api.configs[api.currentId];
                        const modelToSelect = isVision ? currentConfig.visionModel : currentConfig.model;
                        if(modelToSelect) select.value = modelToSelect;
                    }

                    select.classList.remove('hidden');
                    if (input) input.classList.add('hidden'); // 加载成功后隐藏输入框，显示下拉框
                    showApiResult(`模型加载成功！共 ${models.length} 个`, 'success', resultDivId);

                    // Save to current config
                     const currentConfig = getCurrentApiConfigFromForm();
                     if (isVision) {
                        currentConfig.visionModels = models.map(m => m.id);
                     } else {
                        currentConfig.models = models.map(m => m.id);
                     }
                      if (api.currentId) {
                         api.configs[api.currentId] = {...api.configs[api.currentId], ...currentConfig};
                         await saveApiConfigs();
                     }


                } catch(e) {
                    showApiResult(`加载模型失败: ${e.message}`, 'error', resultDivId);
                } finally {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                }
            }
            
            async function directChatTest() {
                 const url = api.url.value.trim();
                 const key = api.key.value.trim();

                 if (!url || !key) {
                     showApiResult('请填写 API URL 和 Key。', 'error', 'api-test-result');
                     return;
                 }

                 showApiResult('直接测试中...', 'info', 'api-test-result');
                 api.directChatTestBtn.disabled = true;

                 // 测试多个常见模型
                 const testModels = [
                     'gpt-3.5-turbo',
                     'gpt-4',
                     'gpt-4-turbo-preview',
                     'deepseek-chat',
                     'gemini-pro',
                     'gemini-1.5-flash',
                     'qwen-turbo',
                     'claude-3-haiku',
                     'llama-3.1-8b-instant',
                     'mixtral-8x7b-instruct'
                 ];

                 let successModel = null;
                 let successResponse = null;

                 for (const model of testModels) {
                     try {
                         console.log(`Testing model: ${model}`);
                         const urlObj = new URL(url);
                         let endpoint, headers, body;

                         if (urlObj.hostname.includes('google')) {
                             endpoint = `${urlObj.origin}/v1beta/models/${model}:generateContent?key=${key}`;
                             headers = { 'Content-Type': 'application/json' };
                             body = {
                                 contents: [{
                                     role: 'user',
                                     parts: [{ text: 'Say "Hello" and nothing else.' }]
                                 }],
                                 generationConfig: {
                                     maxOutputTokens: 10,
                                     temperature: 0.1
                                 }
                             };
                         } else {
                             endpoint = `${url.replace(/\/$/, '')}/chat/completions`;
                             headers = {
                                 'Content-Type': 'application/json',
                                 'Authorization': `Bearer ${key}`
                             };
                             body = {
                                 model: model,
                                 messages: [{role: 'user', content: 'Say "Hello" and nothing else.'}],
                                 max_tokens: 10,
                                 temperature: 0.1
                             };
                         }

                         const response = await fetch(endpoint, {
                             method: 'POST',
                             headers: headers,
                             body: JSON.stringify(body)
                         });

                         if (response.ok) {
                             successModel = model;
                             successResponse = await response.json();
                             console.log(`Success with model: ${model}`);
                             break;
                         }
                     } catch (e) {
                         console.log(`Failed with model ${model}:`, e.message);
                     }
                 }

                 if (successModel) {
                     api.modelName.value = successModel;

                     // 自动保存配置
                     const newConfig = getCurrentApiConfigFromForm();
                     if (!api.currentId) {
                         const newId = `api_${Date.now()}`;
                         api.configs[newId] = newConfig;
                         api.currentId = newId;
                     } else {
                         api.configs[api.currentId] = newConfig;
                     }
                     await saveApiConfigs();
                     updateApiSelect();

                     showApiResult(`✅ 直接测试成功！可用模型: ${successModel}`, 'success', 'api-test-result');
                 } else {
                     showApiResult('❌ 直接测试失败，请检查URL/Key或手动指定模型', 'error', 'api-test-result');
                 }
                 api.directChatTestBtn.disabled = false;
            }

            api.testBtn.addEventListener('click', () => testConnection(false));
            api.debugModelsBtn.addEventListener('click', () => testConnection(false, true));
            api.directChatTestBtn.addEventListener('click', directChatTest);
            api.loadModelsBtn.addEventListener('click', () => loadModels(false));
            api.loadVisionModelsBtn.addEventListener('click', () => loadModels(true));
            api.modelSelect.addEventListener('change', () => { if (api.modelSelect.value) api.modelName.value = api.modelSelect.value; });
            api.visionModelSelect.addEventListener('change', () => { 
                const config = api.configs[api.currentId];
                if(config) config.visionModel = api.visionModelSelect.value;
             });

            function getCurrentApiConfig() {
                if (api.currentId && api.configs[api.currentId]) {
                    return api.configs[api.currentId];
                }
                return null;
            }

            // --- Preset Logic ---
            const presetList = document.getElementById('preset-list'), 
                  saveAsPresetBtn = document.getElementById('save-as-preset-btn'), 
                  presetImportInput = document.getElementById('preset-import-json'), 
                  presetExportBtn = document.getElementById('preset-export-json'), 
                  promptListContainer = document.getElementById('prompt-list'), 
                  addPromptBtn = document.getElementById('add-prompt-btn'),
                  restorePromptsBtn = document.getElementById('restore-prompts-btn');

            const paramInputs = {
                temp: { slider: document.getElementById('param-temp'), number: document.getElementById('param-temp-value') },
                top_p: { slider: document.getElementById('param-top-p'), number: document.getElementById('param-top-p-value') },
                top_k: { slider: document.getElementById('param-top-k'), number: document.getElementById('param-top-k-value') },
                freq_pen: { slider: document.getElementById('param-freq-pen'), number: document.getElementById('param-freq-pen-value') },
                pres_pen: { slider: document.getElementById('param-pres-pen'), number: document.getElementById('param-pres-pen-value') },
                rep_pen: { slider: document.getElementById('param-rep-pen'), number: document.getElementById('param-rep-pen-value') },
                max_tokens: { number: document.getElementById('param-max-tokens') },
                context_size: { number: document.getElementById('param-context-size') },
            };

            const defaultPrompts = [
                {"identifier":"main","name":"Main Prompt","enabled":true,"role":"system","content":"...","system_prompt":true,"marker":false},
                {"identifier":"jailbreak","name":"Post-History Instructions","enabled":false,"role":"system","content":"","system_prompt":true,"marker":false},
                {"identifier":"nsfw","name":"Auxiliary Prompt","enabled":false,"role":"system","content":"","system_prompt":true,"marker":false},
                {"identifier":"personaDescription","name":"Persona","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"worldInfoBefore","name":"World Info (before)","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"charDescription","name":"Char Description","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"charPersonality","name":"Char Personality","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"scenario","name":"Scenario","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"dialogueExamples","name":"Chat Examples","enabled":true,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"worldInfoAfter","name":"World Info (after)","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"chatHistory","name":"Chat History","enabled":true,"role":"system","system_prompt":true,"marker":true},
            ].map(p => ({...p, injection_depth: 4, injection_order: 100}));
            
            async function getPresets() {
                const data = await idbStorage.getItem('presets_v4');
                return data ? JSON.parse(data) : {};
            }
            async function savePresets(presets, newPresetName = null) {
                // 在清空DOM之前先获取当前选中的预设名
                const current = newPresetName || document.querySelector('.preset-item.active')?.dataset.name || '默认';
                await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                await loadPresetsList();
                await selectPreset(current);
                triggerAutoSave();
            }
            
            async function loadPresetsList() {
                let presets = await getPresets();
                presetList.innerHTML = '';
                if (!presets['默认']) {
                    presets['默认'] = { temp: 1, top_p: 1, top_k: 50, freq_pen: 0, pres_pen: 0, rep_pen: 1.1, max_tokens: 1024, context_size: 4096, prompts: JSON.parse(JSON.stringify(defaultPrompts)) };
                    await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                }

                if (Array.isArray(presets)) {
                    const newPresets = {};
                    presets.forEach(p => newPresets[p.name || '未命名预设'] = p);
                    presets = newPresets;
                    await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                }

                Object.keys(presets).forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'preset-item p-2 rounded-md cursor-pointer hover:bg-gray-100 flex justify-between items-center';
                    item.dataset.name = name;

                    item.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-grip-vertical drag-handle text-gray-400"></i><span>${name}</span></div>`;

                    const buttons = document.createElement('div');
                    const saveBtn = document.createElement('button');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i>';
                    saveBtn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-primary-color';
                    saveBtn.title = '保存';
                    saveBtn.onclick = (e) => { e.stopPropagation(); saveCurrentPreset(name); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-red-500';
                    deleteBtn.title = '删除';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deletePreset(name); };

                    buttons.appendChild(saveBtn);
                    if (name !== '默认') buttons.appendChild(deleteBtn);
                    item.appendChild(buttons);
                    item.addEventListener('click', () => selectPreset(name));
                    presetList.appendChild(item);
                });
                const currentPreset = await idbStorage.getItem('currentPreset_v4') || '默认';
                await selectPreset(currentPreset);
                new Sortable(presetList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: onPresetSort });
            }

            async function onPresetSort(evt) {
                const presets = await getPresets();
                const orderedNames = [...presetList.children].map(item => item.dataset.name);
                const orderedPresets = {};
                orderedNames.forEach(name => { orderedPresets[name] = presets[name]; });
                await idbStorage.setItem('presets_v4', JSON.stringify(orderedPresets));
            }

            async function selectPreset(name) {
                const presets = await getPresets();
                if (!presets[name]) name = '默认';
                 document.querySelectorAll('.preset-item').forEach(item => {
                    if (item.dataset.name === name) {
                        item.style.backgroundColor = 'var(--bg-color)';
                        item.style.fontWeight = '500';
                        item.classList.add('active');
                    } else {
                        item.style.backgroundColor = 'transparent';
                         item.style.fontWeight = '400';
                        item.classList.remove('active');
                    }
                });
                await idbStorage.setItem('currentPreset_v4', name);
                await updateFullPresetForm(name);
            }

            async function updateFullPresetForm(presetName) {
                const presets = await getPresets();
                const preset = presets[presetName] || presets['默认'];
                if (!preset) return;

                Object.keys(paramInputs).forEach(key => {
                    const value = preset[key];
                    if (paramInputs[key].slider) paramInputs[key].slider.value = value ?? 0;
                    if (paramInputs[key].number) paramInputs[key].number.value = value ?? 0;
                });
                paramInputs.context_size.number.value = preset.context_size ?? (preset.openai_max_context || 4096);
                
                promptListContainer.innerHTML = '';
                (preset.prompts || []).forEach((promptData, index) => {
                    const entry = document.createElement('div');
                    entry.className = 'prompt-entry rounded-lg p-2 flex justify-between items-center transition-colors';
                    entry.dataset.originalIndex = index;
                    entry.innerHTML = `
                        <div class="flex items-center gap-2 flex-1">
                             <i class="fas fa-grip-vertical drag-handle text-gray-400"></i>
                             <label class="flex items-center gap-2 cursor-pointer flex-1">
                                <input type="checkbox" ${promptData.enabled ? 'checked' : ''} class="prompt-enabled-toggle w-4 h-4 accent-primary-color">
                                <span class="font-medium text-sm">${promptData.name}</span>
                            </label>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3">
                            <span>${promptData.role || 'system'}</span>
                            <button class="edit-prompt-entry-btn w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-index="${index}" title="编辑"><i class="fas fa-pen"></i></button>
                        </div>`;
                    promptListContainer.appendChild(entry);
                });

                promptListContainer.querySelectorAll('.edit-prompt-entry-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                         e.stopPropagation();
                         const index = parseInt(btn.dataset.index);
                         const currentPresetName = document.querySelector('.preset-item.active')?.dataset.name || '默认';
                         const currentPreset = (await getPresets())[currentPresetName];
                         openEditPromptModal(currentPreset.prompts[index], index);
                    });
                });
                new Sortable(promptListContainer, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: onPromptSort });
            }
            
            async function onPromptSort() {
                const presetName = document.querySelector('.preset-item.active').dataset.name;
                const presets = await getPresets();
                const prompts = presets[presetName].prompts;

                const newOrderIndices = [...promptListContainer.children].map(item => parseInt(item.dataset.originalIndex));
                const reorderedPrompts = newOrderIndices.map(index => prompts[index]);

                presets[presetName].prompts = reorderedPrompts;
                await savePresets(presets);
                updateFullPresetForm(presetName); // Redraw to update indices
            }
            
            document.getElementById('save-prompt-changes-btn').addEventListener('click', async () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const index = parseInt(document.getElementById('edit-prompt-index').value);
                const presets = await getPresets();
                if (presets[presetName] && presets[presetName].prompts[index] != null) {
                    const promptData = presets[presetName].prompts[index];
                    promptData.name = document.getElementById('prompt-name-input').value;
                    promptData.injection_position = parseInt(document.getElementById('prompt-position-select').value);
                    promptData.injection_depth = parseInt(document.getElementById('prompt-depth-input').value);
                    promptData.content = document.getElementById('prompt-content-input').value;
                    await savePresets(presets);
                    closeEditPromptModal();
                }
            });

            document.getElementById('delete-prompt-btn').addEventListener('click', async () => {
                if (!confirm('确定要删除这个提示词条目吗？')) return;
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const index = parseInt(document.getElementById('edit-prompt-index').value);
                const presets = await getPresets();
                if (presets[presetName] && presets[presetName].prompts[index] != null) {
                     presets[presetName].prompts.splice(index, 1);
                     await savePresets(presets);
                     closeEditPromptModal();
                }
            });
            
            addPromptBtn.addEventListener('click', async () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                if (presets[presetName]) {
                    const newPrompt = { name: "新提示词", content: "", enabled: true, role: "system", injection_position: 0, injection_depth: 4, injection_order: 100 };
                    if (!presets[presetName].prompts) presets[presetName].prompts = [];
                    presets[presetName].prompts.push(newPrompt);
                    await savePresets(presets);
                }
            });

            restorePromptsBtn.addEventListener('click', async () => {
                if (!confirm('您确定要将提示词列表恢复为默认设置吗？此操作不可撤销。')) return;
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                if (presets[presetName]) {
                    presets[presetName].prompts = JSON.parse(JSON.stringify(defaultPrompts));
                    await savePresets(presets);
                }
            });

            promptListContainer.addEventListener('change', async (e) => {
                if (e.target.classList.contains('prompt-enabled-toggle')) {
                    const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                    if (!presetName) return;
                    const index = parseInt(e.target.closest('.prompt-entry').dataset.originalIndex);
                    const presets = await getPresets();
                    if (presets[presetName] && presets[presetName].prompts[index] != null) {
                        presets[presetName].prompts[index].enabled = e.target.checked;
                        await savePresets(presets);
                    }
                }
            });
            
            async function getCurrentPresetData() {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                let existingPrompts = (presets[presetName] && presets[presetName].prompts) ? [...presets[presetName].prompts] : [];

                const data = { prompts: existingPrompts };
                Object.keys(paramInputs).forEach(key => {
                    if (paramInputs[key].number) {
                        data[key] = paramInputs[key].number.type === 'number' ? parseFloat(paramInputs[key].number.value) : paramInputs[key].number.value;
                    }
                });
                return data;
            }

            async function saveCurrentPreset(name) {
                const presets = await getPresets();
                presets[name] = await getCurrentPresetData();
                await savePresets(presets);
                alert(`预设 "${name}" 已保存!`);
            }

            async function deletePreset(name) {
                if (name === '默认') { alert('不能删除默认预设!'); return; }
                if (confirm(`确定要删除预设 "${name}" 吗?`)) {
                    const presets = await getPresets();
                    delete presets[name];
                    await savePresets(presets);
                }
            }
            saveAsPresetBtn.addEventListener('click', async () => {
                const newName = prompt("输入新预设的名称:");
                if (newName && newName.trim() !== '') {
                    const presets = await getPresets();
                    presets[newName.trim()] = await getCurrentPresetData();
                    await savePresets(presets, newName.trim());
                }
            });

            presetImportInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedPreset = JSON.parse(e.target.result);
                        if (typeof importedPreset.temperature === 'undefined' && !importedPreset.prompts) { throw new Error('文件似乎不是有效的预设格式。'); }
                        const presetName = file.name.replace(/\.json$/i, '');
                        const presets = await getPresets();
                        presets[presetName] = {
                            temp: importedPreset.temperature ?? 1, top_p: importedPreset.top_p ?? 1,
                            top_k: importedPreset.top_k ?? 50, freq_pen: importedPreset.frequency_penalty ?? 0,
                            pres_pen: importedPreset.presence_penalty ?? 0, rep_pen: importedPreset.repetition_penalty ?? 1.1,
                            max_tokens: importedPreset.openai_max_tokens ?? 1024, context_size: importedPreset.openai_max_context ?? 4096,
                            prompts: importedPreset.prompts || []
                        };
                        await savePresets(presets, presetName);
                        alert(`预设 "${presetName}" 已成功导入!`);
                    } catch (err) { alert(`导入失败: ${err.message}`); console.error("Preset import error:", err); }
                    finally { event.target.value = ''; }
                };
                reader.onerror = () => { alert('读取文件时出错。'); event.target.value = ''; };
                reader.readAsText(file);
            });

            presetExportBtn.addEventListener('click', () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                if(!presetName) { alert("请先选择一个预设"); return; }
                const presets = getPresets();
                const data = presets[presetName];
                 const exportData = {
                    temperature: data.temp, top_p: data.top_p, top_k: data.top_k,
                    frequency_penalty: data.freq_pen, presence_penalty: data.pres_pen,
                    repetition_penalty: data.rep_pen, openai_max_tokens: data.max_tokens,
                    openai_max_context: data.context_size, prompts: data.prompts
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${presetName}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });

            Object.values(paramInputs).forEach(inputs => {
                if (inputs.slider) {
                    inputs.slider.addEventListener('input', () => inputs.number.value = inputs.slider.value);
                    inputs.number.addEventListener('input', () => { if (inputs.slider) inputs.slider.value = inputs.number.value; });
                }
            });
            
            // --- Character Logic ---
            const char = {
                importBtn: document.getElementById('char-import-btn'),
                importFile: document.getElementById('char-import-file'),
                newBtn: document.getElementById('char-new-btn'),
                editor: {
                    panel: document.getElementById('char-editor-panel'),
                    placeholder: document.getElementById('char-editor-placeholder'),
                    content: document.getElementById('char-editor-content'),
                    id: document.getElementById('char-editing-id'),
                    avatarImg: document.getElementById('char-editor-avatar'),
                    avatarUpload: document.getElementById('char-avatar-upload'),
                    name: document.getElementById('char-editor-name'),
                    desc: document.getElementById('char-editor-desc'),
                    firstMes: document.getElementById('char-editor-first-mes'),
                    creatorNotes: document.getElementById('char-editor-creator-notes'),
                    saveBtn: document.getElementById('char-save-btn'),
                    exportBtn: document.getElementById('char-export-btn'),
                    duplicateBtn: document.getElementById('char-duplicate-btn'),
                    deleteBtn: document.getElementById('char-delete-btn'),
                },
                data: {},
                activeCharacterId: null
            };

            async function getCharacters() {
                const data = await idbStorage.getItem('characters_v2');
                return data ? JSON.parse(data) : {};
            }
            async function saveCharacters() {
                try {
                    console.log('[保存角色] 保存角色数据:', Object.keys(char.data).length, '个角色');
                    const dataStr = JSON.stringify(char.data);
                    console.log('[保存角色] 数据大小:', (dataStr.length / 1024).toFixed(2), 'KB');

                    await idbStorage.setItem('characters_v2', dataStr);

                    // 验证保存
                    const saved = await idbStorage.getItem('characters_v2');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('[保存角色] ✓ 验证成功: IndexedDB中有', Object.keys(parsed).length, '个角色');
                    } else {
                        console.error('[保存角色] ✗ 验证失败: IndexedDB中没有数据!');
                        throw new Error('保存验证失败');
                    }

                    triggerAutoSave();
                    return true;
                } catch (e) {
                    console.error('[保存角色] ✗ 保存失败:', e);
                    if (e.name === 'QuotaExceededError' || e.code === 22) {
                        // 计算当前存储使用情况
                        let totalSize = 0;
                        const allKeys = await idbStorage.getAllKeys();
                        for (let key of allKeys) {
                            const value = await idbStorage.getItem(key);
                            if (value) {
                                totalSize += value.length + key.length;
                            }
                        }
                        const usedMB = (totalSize / (1024 * 1024)).toFixed(2);

                        const message = `存储空间已满！\n\n当前已使用: ${usedMB} MB\n\n解决方案：\n1. 导出并删除不需要的角色\n2. 导出并清理聊天记录\n3. 压缩角色头像图片\n4. 清理旧的聊天历史记录\n\n是否要查看存储使用详情？`;

                        if (confirm(message)) {
                            // 显示详细的存储信息
                            let details = '存储详情：\n\n';
                            const characterData = await idbStorage.getItem('characters_v2');
                            const characterSize = characterData?.length || 0;
                            details += `角色数据: ${(characterSize / 1024).toFixed(2)} KB\n`;

                            let chatHistorySize = 0;
                            for (let key of allKeys) {
                                if (key.startsWith('chat_history_')) {
                                    const value = await idbStorage.getItem(key);
                                    if (value) chatHistorySize += value.length;
                                }
                            }
                            details += `聊天记录: ${(chatHistorySize / 1024).toFixed(2)} KB\n`;
                            details += `\n角色数量: ${Object.keys(char.data).length}\n`;
                            alert(details);
                        }
                    } else {
                        alert('保存失败: ' + e.message);
                    }
                    return false;
                }
            }

            function renderCharacterSelect(filterTags = [], nameSearch = '') {
                const charList = document.getElementById('char-list');
                if (!charList) return;

                charList.innerHTML = '';

                // 收集所有标签
                const allTags = new Set();
                Object.values(char.data).forEach(character => {
                    if (character.tags && Array.isArray(character.tags)) {
                        character.tags.forEach(tag => allTags.add(tag));
                    }
                });

                // 渲染标签列表
                const tagList = document.getElementById('char-tag-list');
                if (tagList) {
                    tagList.innerHTML = '';
                    Array.from(allTags).sort().forEach(tag => {
                        const tagBtn = document.createElement('button');
                        tagBtn.className = `px-3 py-1 rounded-full text-sm transition-all ${
                            filterTags.includes(tag)
                                ? 'bg-primary-color text-white'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`;
                        tagBtn.textContent = tag;
                        tagBtn.addEventListener('click', () => {
                            const newFilterTags = filterTags.includes(tag)
                                ? filterTags.filter(t => t !== tag)
                                : [...filterTags, tag];
                            renderCharacterSelect(newFilterTags, nameSearch);
                        });
                        tagList.appendChild(tagBtn);
                    });
                }

                const sortedChars = Object.values(char.data).sort((a, b) => (b.fav ? 1 : 0) - (a.fav ? 1 : 0) || a.name.localeCompare(b.name));

                // 根据标签和名称筛选角色
                let filteredChars = sortedChars;

                // 标签筛选
                if (filterTags.length > 0) {
                    filteredChars = filteredChars.filter(character => {
                        if (!character.tags || !Array.isArray(character.tags)) return false;
                        return filterTags.every(tag => character.tags.includes(tag));
                    });
                }

                // 名称搜索
                if (nameSearch.trim()) {
                    const searchLower = nameSearch.toLowerCase().trim();
                    filteredChars = filteredChars.filter(character => {
                        const name = (character.name || '').toLowerCase();
                        const desc = (character.description || '').toLowerCase();
                        return name.includes(searchLower) || desc.includes(searchLower);
                    });
                }

                if (filteredChars.length === 0) {
                    charList.innerHTML = '<div class="text-center text-gray-500 py-8">没有匹配的角色</div>';
                    return;
                }

                filteredChars.forEach(character => {
                    const item = document.createElement('div');
                    item.className = 'char-item p-3 rounded-lg cursor-pointer border-2 transition-all';
                    item.dataset.charId = character.id;

                    if (character.id === char.activeCharacterId) {
                        item.className += ' border-primary-color bg-primary-color bg-opacity-10';
                    } else {
                        item.className += ' border-gray-200 hover:border-primary-color hover:bg-gray-50';
                    }

                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${character.avatar && character.avatar !== 'none' ? character.avatar : 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI'}"
                                 class="w-12 h-12 rounded-full object-cover border-2 ${character.id === char.activeCharacterId ? 'border-primary-color' : 'border-gray-300'}">
                            <div class="flex-1">
                                <p class="font-bold text-base">${(character.fav ? '★ ' : '') + (character.name || '无名角色')}</p>
                                <p class="text-xs text-gray-500 truncate">${character.description ? character.description.substring(0, 50) + '...' : '暂无描述'}</p>
                            </div>
                            ${character.id === char.activeCharacterId ? '<i class="fas fa-check-circle text-primary-color text-xl"></i>' : ''}
                        </div>
                    `;

                    item.addEventListener('click', () => {
                        selectCharacter(character.id);
                        closeCharacterSelector();
                    });
                    charList.appendChild(item);
                });
            }

            function openCharacterSelector() {
                const modal = document.getElementById('char-selector-modal');
                if (modal) {
                    renderCharacterSelect();
                    modal.classList.add('active');
                }
            }

            function closeCharacterSelector() {
                const modal = document.getElementById('char-selector-modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            function updateCharPreviewCard() {
                const character = char.data[char.activeCharacterId];
                const avatarEl = document.getElementById('current-char-avatar-preview');
                const nameEl = document.getElementById('current-char-name-preview');

                if (character) {
                    if (avatarEl) avatarEl.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI';
                    if (nameEl) nameEl.textContent = character.name || '无名角色';
                } else {
                    if (avatarEl) avatarEl.src = 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI';
                    if (nameEl) nameEl.textContent = '未选择角色';
                }
            }

            async function selectCharacter(id) {
                // 保存当前角色的聊天记录
                if (char.activeCharacterId && chatHistory.length > 0) {
                    await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    triggerAutoSave();
                }

                if (!char.data[id]) {
                    hideCharacterEditor();
                    char.activeCharacterId = null;
                    await idbStorage.removeItem('active_character_v2');
                    updateCharPreviewCard();
                    document.getElementById('char-name-header').textContent = 'No Character Loaded';
                    document.getElementById('char-avatar-header').src = 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                    await loadWiData(null);
                    await loadRegexData([], false);
                    startNewChat();
                    return;
                }
                char.activeCharacterId = id;
                await idbStorage.setItem('active_character_v2', id);

                const character = char.data[id];
                document.getElementById('char-name-header').textContent = character.name;
                const avatarHeader = document.getElementById('char-avatar-header');
                avatarHeader.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';

                populateCharacterEditor(character);
                updateCharPreviewCard();

                // Reload other modals with character-specific data
                await loadWiData(character.data?.character_book);
                await loadRegexData(character.data?.regex, character.data?.regex_enabled);

                // 尝试加载该角色的聊天记录
                await loadChatHistory(id);
            }
            
            function showCharacterEditor(character) {
                char.editor.id.value = character.id;
                char.editor.avatarImg.src = character.avatar || 'https://placehold.co/128x128/5E5B9D/ffffff?text=AI';
                char.editor.name.value = character.name || '';
                char.editor.desc.value = character.description || (character.data?.description || '');
                char.editor.firstMes.value = character.first_mes || (character.data?.first_mes || '');
                char.editor.creatorNotes.value = character.creatorcomment || (character.data?.creator_notes || '');

                // 显示标签
                const tags = character.tags || character.data?.tags || [];
                document.getElementById('char-editor-tags').value = tags.join(', ');

                char.editor.placeholder.classList.add('hidden');
                char.editor.content.classList.remove('hidden');
                char.editor.content.classList.add('flex');
            }
            function hideCharacterEditor() {
                char.editor.id.value = '';
                char.editor.placeholder.classList.remove('hidden');
                char.editor.content.classList.add('hidden');
                char.editor.content.classList.remove('flex');
            }

            function populateCharacterEditor(character) {
                showCharacterEditor(character);
                renderAlternateGreetings(character);
            }

            // 渲染备选开场白列表
            function renderAlternateGreetings(character) {
                const list = document.getElementById('alternate-greetings-list');
                list.innerHTML = '';

                const greetings = character.data?.alternate_greetings || [];

                if (greetings.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">暂无备选开场白</p>';
                    return;
                }

                greetings.forEach((greeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 flex items-start gap-2';

                    const badge = document.createElement('div');
                    badge.className = 'flex-shrink-0 w-6 h-6 bg-primary-color text-white rounded-full flex items-center justify-center text-xs font-bold';
                    badge.textContent = index + 1;

                    const content = document.createElement('div');
                    content.className = 'flex-1 min-w-0';
                    const preview = greeting.length > 100 ? greeting.substring(0, 100) + '...' : greeting;
                    const textNode = document.createElement('p');
                    textNode.className = 'text-sm text-gray-700 break-words';
                    textNode.textContent = preview;
                    content.appendChild(textNode);

                    const actions = document.createElement('div');
                    actions.className = 'flex-shrink-0 flex gap-1';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-primary-color hover:text-primary-hover-color p-1';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = '编辑';
                    editBtn.onclick = () => openGreetingEditModal(index, greeting);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 p-1';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = '删除';
                    deleteBtn.onclick = () => deleteGreeting(index);

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);

                    item.appendChild(badge);
                    item.appendChild(content);
                    item.appendChild(actions);
                    list.appendChild(item);
                });

                // 使列表可拖动排序
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: onGreetingSort
                });
            }

            // 打开开场白编辑弹窗
            function openGreetingEditModal(index, content) {
                const modal = document.getElementById('greeting-edit-modal');
                const textarea = document.getElementById('greeting-edit-textarea');
                const indexInput = document.getElementById('greeting-edit-index');

                indexInput.value = index;
                textarea.value = content || '';
                modal.style.display = 'flex';
            }

            // 添加新开场白
            document.getElementById('add-greeting-btn').addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data) character.data = {};
                if (!character.data.alternate_greetings) character.data.alternate_greetings = [];

                character.data.alternate_greetings.push('');
                renderAlternateGreetings(character);
                openGreetingEditModal(character.data.alternate_greetings.length - 1, '');
            });

            // 保存开场白编辑
            document.getElementById('save-greeting-edit-btn').addEventListener('click', async () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                const index = parseInt(document.getElementById('greeting-edit-index').value);
                const content = document.getElementById('greeting-edit-textarea').value;

                if (!character.data) character.data = {};
                if (!character.data.alternate_greetings) character.data.alternate_greetings = [];

                character.data.alternate_greetings[index] = content;

                await saveCharacters();
                renderAlternateGreetings(character);

                // 关闭弹窗
                document.getElementById('greeting-edit-modal').style.display = 'none';
            });

            // 删除开场白
            async function deleteGreeting(index) {
                if (!confirm('确定要删除这条开场白吗？')) return;

                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data?.alternate_greetings) return;

                character.data.alternate_greetings.splice(index, 1);

                await saveCharacters();
                renderAlternateGreetings(character);
            }

            // 开场白排序
            async function onGreetingSort(evt) {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data?.alternate_greetings) return;

                const list = document.getElementById('alternate-greetings-list');
                const newOrder = [];

                Array.from(list.children).forEach(item => {
                    const index = Array.from(list.children).indexOf(item);
                    const badge = item.querySelector('.bg-primary-color');
                    if (badge) {
                        const originalIndex = parseInt(badge.textContent) - 1;
                        if (character.data.alternate_greetings[originalIndex]) {
                            newOrder.push(character.data.alternate_greetings[originalIndex]);
                        }
                    }
                });

                character.data.alternate_greetings = newOrder;
                await saveCharacters();
                renderAlternateGreetings(character);
            }
            
            async function saveCharacterFromEditor() {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const character = char.data[id];

                character.name = char.editor.name.value;
                character.description = char.editor.desc.value;
                character.first_mes = char.editor.firstMes.value;
                character.creatorcomment = char.editor.creatorNotes.value;

                if (!character.data) character.data = {};
                character.data.name = character.name;
                character.data.description = character.description;
                character.data.first_mes = character.first_mes;
                character.data.creator_notes = character.creatorcomment;

                // 保存标签
                const tagsInput = document.getElementById('char-editor-tags').value;
                const tagsArray = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                character.data.tags = tagsArray;
                character.tags = tagsArray; // 同时保存到顶层

                // **FIX**: Save character-specific world book if it was being edited
                if (wi.charBook && wi.worldSelect.value === 'char_book') {
                    character.data.character_book = wi.charBook;
                }

                await saveCharacters();
                renderCharacterSelect();
                updateCharPreviewCard();
                if (id === char.activeCharacterId) {
                    // Update header
                    document.getElementById('char-name-header').textContent = character.name;
                    const avatarHeader = document.getElementById('char-avatar-header');
                    avatarHeader.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                }
                alert(`角色 "${character.name}" 已保存!`);
            }

            function processAndAddCharacter(charData, pngFile = null) {
                console.log('[导入角色] 开始处理角色数据:', charData.name || charData.data?.name);

                const newChar = {
                    id: `char_${Date.now()}`,
                    fav: false,
                    avatar: charData.avatar || 'none',
                    name: charData.name || charData.data?.name || '未命名角色',
                    description: charData.description || charData.data?.description || '',
                    first_mes: charData.first_mes || charData.data?.first_mes || '',
                    creatorcomment: charData.creatorcomment || charData.data?.creator_notes || '',
                    tags: charData.tags || charData.data?.tags || [], // 处理tags字段
                    data: {
                        character_book: null,
                        regex: [],
                        regex_enabled: false,
                        tags: charData.tags || charData.data?.tags || [] // 同时保存到data中
                    },
                };

                // 处理完整的 data 对象
                if (charData.data) {
                    newChar.data = {
                        ...charData.data,
                        character_book: charData.data.character_book || null,
                        regex: charData.data.regex || [],
                        regex_enabled: charData.data.regex_enabled || false,
                        tags: charData.data.tags || charData.tags || [] // 确保tags被保存
                    };
                    // 更新顶层的tags
                    if (charData.data.tags || charData.tags) {
                        newChar.tags = charData.data.tags || charData.tags || [];
                    }
                }

                // 处理 V3 卡片格式的正则
                if (charData.data?.extensions?.regex_scripts) {
                    newChar.data.regex = charData.data.extensions.regex_scripts;
                    newChar.data.regex_enabled = true;
                }

                // 处理 V3 卡片格式的世界书
                if (charData.data?.character_book) {
                    newChar.data.character_book = charData.data.character_book;
                }

                if (newChar.avatar === 'none' && pngFile) {
                    // 将图片转换为base64以便持久化
                    console.log('[导入角色] 正在读取PNG头像...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            newChar.avatar = e.target.result;
                            console.log('[导入角色] 头像读取完成，准备保存角色:', newChar.name);
                            char.data[newChar.id] = newChar;
                            console.log('[导入角色] 添加到char.data后，总角色数:', Object.keys(char.data).length);

                            const success = saveCharacters();
                            if (success) {
                                renderCharacterSelect();
                                selectCharacter(newChar.id);
                                alert(`角色 "${newChar.name}" 导入成功！`);
                            } else {
                                // 保存失败，回滚
                                delete char.data[newChar.id];
                                console.error('[导入角色] ✗ 保存失败，已回滚');
                            }
                        } catch (error) {
                            console.error('[导入角色] 保存过程出错:', error);
                            delete char.data[newChar.id];
                            alert(`角色保存失败: ${error.message}`);
                        }
                    };
                    reader.onerror = function(error) {
                        console.error('[导入角色] 头像读取失败:', error);
                        // 即使头像读取失败，也尝试保存角色（不含头像）
                        char.data[newChar.id] = newChar;
                        const success = saveCharacters();
                        if (success) {
                            renderCharacterSelect();
                            selectCharacter(newChar.id);
                            alert(`角色 "${newChar.name}" 已导入（头像读取失败）`);
                        } else {
                            delete char.data[newChar.id];
                            alert(`角色保存失败`);
                        }
                    };
                    reader.readAsDataURL(pngFile);
                    return; // 等待异步读取完成
                }

                console.log('[导入角色] 准备保存角色（无PNG）:', newChar.name);
                char.data[newChar.id] = newChar;
                console.log('[导入角色] 添加到char.data后，总角色数:', Object.keys(char.data).length);

                const success = saveCharacters();
                if (success) {
                    renderCharacterSelect();
                    selectCharacter(newChar.id);
                    alert(`角色 "${newChar.name}" 导入成功！`);
                } else {
                    // 保存失败，回滚
                    delete char.data[newChar.id];
                    console.error('[导入角色] ✗ 保存失败，已回滚');
                }
            }

            // 文本编辑弹窗相关函数
            window.openTextEditModal = function(fieldName, title) {
                const modal = document.getElementById('text-edit-modal');
                const titleEl = document.getElementById('text-edit-modal-title');
                const fieldNameEl = document.getElementById('text-edit-field-name');
                const textarea = document.getElementById('text-edit-textarea');

                let fieldMap = {
                    'desc': char.editor.desc,
                    'firstMes': char.editor.firstMes,
                    'creatorNotes': char.editor.creatorNotes
                };

                const targetField = fieldMap[fieldName];
                if (!targetField) return;

                titleEl.textContent = title;
                fieldNameEl.value = fieldName;
                textarea.value = targetField.value;

                modal.classList.add('active');
            };

            // 用户文本编辑弹窗
            window.openUserTextEditModal = function(fieldName, title) {
                const modal = document.getElementById('text-edit-modal');
                const titleEl = document.getElementById('text-edit-modal-title');
                const fieldNameEl = document.getElementById('text-edit-field-name');
                const textarea = document.getElementById('text-edit-textarea');

                let fieldMap = {
                    'description': document.getElementById('user-editor-description'),
                    'systemPrompt': document.getElementById('user-editor-system-prompt')
                };

                const targetField = fieldMap[fieldName];
                if (!targetField) return;

                titleEl.textContent = title;
                fieldNameEl.value = 'user_' + fieldName;
                textarea.value = targetField.value;

                modal.classList.add('active');
            };

            function closeTextEditModal() {
                document.getElementById('text-edit-modal').classList.remove('active');
            }

            document.getElementById('save-text-edit-btn').addEventListener('click', () => {
                const fieldName = document.getElementById('text-edit-field-name').value;
                const textarea = document.getElementById('text-edit-textarea');

                // 角色编辑字段
                let fieldMap = {
                    'desc': char.editor.desc,
                    'firstMes': char.editor.firstMes,
                    'creatorNotes': char.editor.creatorNotes
                };

                // 用户编辑字段
                let userFieldMap = {
                    'user_description': document.getElementById('user-editor-description'),
                    'user_systemPrompt': document.getElementById('user-editor-system-prompt')
                };

                const targetField = fieldMap[fieldName] || userFieldMap[fieldName];
                if (targetField) {
                    targetField.value = textarea.value;
                }

                closeTextEditModal();
            });

            document.querySelectorAll('#text-edit-modal .close-sub-modal-btn').forEach(btn => {
                btn.addEventListener('click', closeTextEditModal);
            });

            document.getElementById('text-edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'text-edit-modal') {
                    closeTextEditModal();
                }
            });

            char.importBtn.addEventListener('click', () => char.importFile.click());
            char.importFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    if (file.name.toLowerCase().endsWith('.json')) {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        processAndAddCharacter(data);
                    } else if (file.name.toLowerCase().endsWith('.png')) {
                        const { charData } = await extractPNGChunk(file);
                        processAndAddCharacter(charData, file);
                    } else {
                        throw new Error('不支持的文件格式。请选择 .json 或 .png 文件。');
                    }
                } catch(e) {
                    alert(`导入失败: ${e.message}`);
                    console.error("Character import error:", e);
                } finally {
                    event.target.value = ''; // Reset file input
                }
            });

            char.newBtn.addEventListener('click', () => {
                const newChar = {
                    id: `char_${Date.now()}`,
                    fav: false,
                    name: "新角色",
                    description: "",
                    first_mes: "你好！",
                    creatorcomment: "",
                    data: {
                        character_book: null,
                        regex: [],
                        regex_enabled: false
                    }
                };
                char.data[newChar.id] = newChar;
                saveCharacters();
                renderCharacterSelect();
                selectCharacter(newChar.id);
            });
            
            char.editor.saveBtn.addEventListener('click', saveCharacterFromEditor);

            char.editor.deleteBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                if (confirm(`确定要删除角色 "${char.data[id].name}" 吗?`)) {
                    delete char.data[id];
                    saveCharacters();
                    renderCharacterSelect();
                    const firstCharId = Object.keys(char.data)[0] || null;
                    selectCharacter(firstCharId);
                }
            });

            char.editor.duplicateBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const originalChar = char.data[id];
                const newChar = JSON.parse(JSON.stringify(originalChar));
                newChar.id = `char_${Date.now()}`;
                newChar.name = `${originalChar.name} (复制)`;
                char.data[newChar.id] = newChar;
                saveCharacters();
                renderCharacterSelect();
                selectCharacter(newChar.id);
            });
            
            char.editor.exportBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const character = char.data[id];
                const exportData = {
                    spec: 'chara_card_v2',
                    spec_version: '2.0',
                    data: {
                        name: character.name,
                        description: character.description,
                        personality: "",
                        scenario: "",
                        first_mes: character.first_mes,
                        mes_example: "",
                        creator_notes: character.creatorcomment,
                        system_prompt: "",
                        post_history_instructions: "",
                        tags: [],
                        creator: "",
                        character_version: "1.0",
                        alternate_greetings: [],
                        // **FIX**: Ensure local regex and char book are included in export
                        character_book: character.data.character_book,
                        regex: character.data.regex,
                        regex_enabled: character.data.regex_enabled,
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${character.name}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });

            if (char.editor.avatarUpload) {
                char.editor.avatarUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const id = char.editor.id.value;
                    if (file && char.data[id]) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imageUrl = event.target.result;
                            char.data[id].avatar = imageUrl;
                            char.editor.avatarImg.src = imageUrl;
                            // 更新预览卡片和列表
                            renderCharacterSelect();
                            updateCharPreviewCard();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // 角色选择弹窗事件绑定
            const openCharSelectorBtn = document.getElementById('open-char-selector-btn');
            const charPreviewCard = document.getElementById('char-preview-card');

            if (openCharSelectorBtn) {
                openCharSelectorBtn.addEventListener('click', () => openCharacterSelector());
            }

            if (charPreviewCard) {
                charPreviewCard.addEventListener('click', () => openCharacterSelector());
            }

            // 关闭角色选择器
            const closeCharSelectorBtns = document.querySelectorAll('.close-char-selector-btn');
            closeCharSelectorBtns.forEach(btn => {
                btn.addEventListener('click', () => closeCharacterSelector());
            });

            // 点击弹窗外部关闭
            const charSelectorModal = document.getElementById('char-selector-modal');
            if (charSelectorModal) {
                charSelectorModal.addEventListener('click', (e) => {
                    if (e.target === charSelectorModal) {
                        closeCharacterSelector();
                    }
                });
            }

            // 标签筛选输入框
            const charTagFilter = document.getElementById('char-tag-filter');
            if (charTagFilter) {
                charTagFilter.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const tagButtons = document.querySelectorAll('#char-tag-list button');

                    if (!searchTerm) {
                        // 显示所有标签
                        tagButtons.forEach(btn => btn.style.display = '');
                    } else {
                        // 筛选标签
                        tagButtons.forEach(btn => {
                            const tagName = btn.textContent.toLowerCase();
                            btn.style.display = tagName.includes(searchTerm) ? '' : 'none';
                        });
                    }
                });
            }

            // 角色名称搜索
            const charNameSearch = document.getElementById('char-name-search');
            if (charNameSearch) {
                charNameSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    // 获取当前选中的标签
                    const selectedTags = Array.from(document.querySelectorAll('#char-tag-list button.bg-primary-color'))
                        .map(btn => btn.textContent);
                    renderCharacterSelect(selectedTags, searchTerm);
                });
            }

            // 关闭开场白选择器
            const closeGreetingSelectorBtns = document.querySelectorAll('.close-greeting-selector-btn');
            closeGreetingSelectorBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('greeting-selector-modal').style.display = 'none';
                });
            });

            // 点击弹窗外部关闭开场白选择器
            const greetingSelectorModal = document.getElementById('greeting-selector-modal');
            if (greetingSelectorModal) {
                greetingSelectorModal.addEventListener('click', (e) => {
                    if (e.target === greetingSelectorModal) {
                        greetingSelectorModal.style.display = 'none';
                    }
                });
            }

            // 重新选择开场白按钮
            const reselectGreetingBtn = document.getElementById('reselect-greeting-btn');
            if (reselectGreetingBtn) {
                reselectGreetingBtn.addEventListener('click', () => {
                    const activeChar = char.data[char.activeCharacterId];
                    if (!activeChar || !activeChar.first_mes) {
                        alert('当前没有可用的角色或开场白');
                        return;
                    }

                    // 收集所有可用的开场白
                    const greetings = [activeChar.first_mes];
                    if (activeChar.data && activeChar.data.alternate_greetings) {
                        greetings.push(...activeChar.data.alternate_greetings.filter(g => g && g.trim()));
                    }

                    if (greetings.length === 1) {
                        alert('当前角色只有一条开场白');
                        return;
                    }

                    // 显示开场白选择器
                    showGreetingSelector(greetings);
                });
            }

            async function loadCharacters() {
                char.data = await getCharacters();
                console.log('[加载角色] 从IndexedDB加载了', Object.keys(char.data).length, '个角色');
                console.log('[加载角色] 角色列表:', Object.values(char.data).map(c => c.name));

                char.activeCharacterId = await idbStorage.getItem('active_character_v2');
                renderCharacterSelect();
                if (char.activeCharacterId && char.data[char.activeCharacterId]) {
                    await selectCharacter(char.activeCharacterId);
                } else {
                    const firstCharId = Object.keys(char.data)[0];
                    if (firstCharId) {
                       await selectCharacter(firstCharId);
                    } else {
                        await loadWiData(null);
                        await loadRegexData([], false);
                    }
                }
            }


            // --- World Info Logic ---
            const wi = {
                worldSelect: document.getElementById('wi-world-select'),
                newWorldBtn: document.getElementById('wi-new-world-btn'),
                deleteWorldBtn: document.getElementById('wi-delete-world-btn'),
                importWorldBtn: document.getElementById('wi-import-world-btn'),
                importFileInput: document.getElementById('wi-import-file'),
                exportWorldBtn: document.getElementById('wi-export-world-btn'),
                newEntryBtn: document.getElementById('wi-new-entry-btn'),
                entryList: document.getElementById('wi-entry-list'),
                editor: {
                    panel: document.getElementById('wi-editor-panel'),
                    placeholder: document.getElementById('wi-editor-placeholder'),
                    content: document.getElementById('wi-editor-content'),
                    id: document.getElementById('wi-editing-entry-id'),
                    enabled: document.getElementById('wi-entry-enabled'),
                    name: document.getElementById('wi-entry-name'),
                    keys: document.getElementById('wi-entry-keys'),
                    entryContent: document.getElementById('wi-entry-content'),
                    cloneBtn: document.getElementById('wi-clone-entry-btn'),
                    deleteBtn: document.getElementById('wi-delete-entry-btn'),
                },
                data: {},
                charBook: null
            };

            async function getWiData() {
                const data = await idbStorage.getItem('world_info_v3');
                return data ? JSON.parse(data) : {};
            }
            async function saveWiData(data) {
                await idbStorage.setItem('world_info_v3', JSON.stringify(data));
                triggerAutoSave();
            }
            
            async function loadWiData(characterBook = null) {
                wi.data = await getWiData();
                wi.charBook = characterBook;
                if (Object.keys(wi.data).length === 0) {
                    wi.data = { "默认世界": [] };
                    await saveWiData(wi.data);
                }
                renderWorlds();
                const lastSelected = await idbStorage.getItem('wi_last_selected_world') || Object.keys(wi.data)[0];
                
                const selectExists = [...wi.worldSelect.options].some(opt => opt.value === lastSelected);
                if (selectExists) {
                    wi.worldSelect.value = lastSelected;
                } else if(wi.worldSelect.options.length > 0) {
                    wi.worldSelect.selectedIndex = 0;
                }
                renderEntries(wi.worldSelect.value);
            }

            function renderWorlds() {
                const currentVal = wi.worldSelect.value;
                wi.worldSelect.innerHTML = '';

                if (wi.charBook && wi.charBook.entries?.length > 0) {
                     const charOptGroup = document.createElement('optgroup');
                     charOptGroup.label = "角色世界书";
                     const option = document.createElement('option');
                     option.value = `char_book`;
                     option.textContent = wi.charBook.name || "Character Book";
                     charOptGroup.appendChild(option);
                     wi.worldSelect.appendChild(charOptGroup);
                }

                const globalOptGroup = document.createElement('optgroup');
                globalOptGroup.label = "全局世界书";
                const worldNames = Object.keys(wi.data);

                if (worldNames.length > 0) {
                    worldNames.forEach(worldName => {
                        const option = document.createElement('option');
                        option.value = worldName;
                        option.textContent = worldName;
                        globalOptGroup.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "无全局世界";
                    option.disabled = true;
                    globalOptGroup.appendChild(option);
                }
                wi.worldSelect.appendChild(globalOptGroup);

                if([...wi.worldSelect.options].some(opt => opt.value === currentVal)) {
                    wi.worldSelect.value = currentVal;
                }
            }

            function renderEntries(worldName) {
                wi.entryList.innerHTML = '';
                hideWiEditor();
                
                let entries = [];
                if (worldName === 'char_book' && wi.charBook) {
                    entries = wi.charBook.entries.map((entry, index) => ({...entry, id: `char_entry_${entry.id || index}`}));
                } else if (wi.data[worldName]) {
                    entries = wi.data[worldName];
                }

                if (!entries || entries.length === 0) return;

                entries.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'wi-entry-item p-2.5 rounded-lg cursor-pointer hover:bg-gray-100 border border-gray-200 transition-colors';
                    item.dataset.id = entry.id;
                    item.innerHTML = `
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate text-sm leading-tight">${entry.name || entry.comment || '无标题条目'}</div>
                                <p class="text-xs text-gray-500 mt-0.5 truncate leading-tight">${(Array.isArray(entry.keys) ? entry.keys.join(', ') : entry.keys) || '无关键字'}</p>
                            </div>
                            <input type="checkbox" ${entry.enabled ? 'checked' : ''} class="wi-entry-enable-toggle accent-primary-color w-4 h-4 flex-shrink-0 mt-0.5" data-id="${entry.id}" title="${entry.enabled ? '点击禁用' : '点击启用'}">
                        </div>`;
                    item.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                           selectEntry(worldName, entry.id);
                        }
                    });
                    wi.entryList.appendChild(item);
                });
            }

            function selectEntry(worldName, entryId) {
                let entries = [];
                if (worldName === 'char_book' && wi.charBook) {
                    entries = wi.charBook.entries.map((entry, index) => ({...entry, id: `char_entry_${entry.id || index}`}));
                } else if (wi.data[worldName]) {
                    entries = wi.data[worldName];
                }
                const entry = entries?.find(e => e.id === entryId);
                if (!entry) { hideWiEditor(); return; }

                document.querySelectorAll('.wi-entry-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`.wi-entry-item[data-id="${entryId}"]`)?.classList.add('active');
                
                showWiEditor(entry);
            }

            function showWiEditor(entry) {
                 wi.editor.id.value = entry.id;
                wi.editor.enabled.checked = entry.enabled;
                wi.editor.name.value = entry.name || entry.comment || '';
                wi.editor.keys.value = Array.isArray(entry.keys) ? entry.keys.join(', ') : (entry.keys || '');
                wi.editor.entryContent.value = entry.content;
                wi.editor.placeholder.classList.add('hidden');
                wi.editor.content.classList.remove('hidden');
                wi.editor.content.classList.add('flex');
            }

            function hideWiEditor() {
                wi.editor.id.value = '';
                wi.editor.placeholder.classList.remove('hidden');
                wi.editor.content.classList.add('hidden');
                wi.editor.content.classList.remove('flex');
                document.querySelectorAll('.wi-entry-item').forEach(el => el.classList.remove('active'));
            }

            function saveCurrentEntry() {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                const isCharBook = worldName === 'char_book';

                if (!worldName || !entryId || (isCharBook && !wi.charBook)) return;

                let dataSet = isCharBook ? wi.charBook.entries : wi.data[worldName];
                const entryIndex = dataSet.findIndex(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (entryIndex === -1) return;

                // 更新条目数据
                const keysInput = wi.editor.keys.value;
                dataSet[entryIndex] = {
                    ...dataSet[entryIndex],
                    enabled: wi.editor.enabled.checked,
                    name: wi.editor.name.value,
                    comment: wi.editor.name.value, // 兼容性
                    keys: keysInput.split(',').map(k => k.trim()).filter(k => k), // 转为数组
                    content: wi.editor.entryContent.value,
                    // 保留其他字段
                    case_sensitive: document.getElementById('wi-keys-case-sensitive')?.checked || false,
                    whole_word: document.getElementById('wi-keys-whole-word')?.checked || false,
                    position: parseInt(document.getElementById('wi-entry-position')?.value || '0'),
                    role: parseInt(document.getElementById('wi-entry-role')?.value || '0'),
                    scan_depth: parseInt(document.getElementById('wi-scan-depth')?.value || '50'),
                    use_regex: document.getElementById('wi-use-regex')?.checked || false
                };

                if(isCharBook) {
                    const activeChar = char.data[char.activeCharacterId];
                    if(activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    saveWiData(wi.data);
                }

                // 刷新列表显示
                renderEntries(worldName);
                console.log('[世界书] 条目已保存:', dataSet[entryIndex]);
            }
            
            wi.worldSelect.addEventListener('change', async (e) => {
                const isCharBook = e.target.value === 'char_book';
                const isGlobal = !isCharBook && e.target.value;

                wi.newWorldBtn.disabled = isCharBook;
                wi.importWorldBtn.disabled = isCharBook;
                wi.deleteWorldBtn.disabled = isCharBook || !isGlobal;
                wi.exportWorldBtn.disabled = isCharBook || !isGlobal;
                wi.newEntryBtn.disabled = !e.target.value;

                if (!isCharBook) {
                    await idbStorage.setItem('wi_last_selected_world', e.target.value);
                }
                renderEntries(e.target.value);
            });
            
            wi.newWorldBtn.addEventListener('click', async () => {
                const worldName = prompt("输入新世界的名称:");
                if (worldName && worldName.trim() !== '') {
                    if (wi.data[worldName]) {
                        alert("该名称的世界已存在。");
                        return;
                    }
                    wi.data[worldName] = [];
                    await saveWiData(wi.data);
                    await loadWiData(wi.charBook);
                    wi.worldSelect.value = worldName;
                    renderEntries(worldName);
                }
            });

            wi.deleteWorldBtn.addEventListener('click', async () => {
                const worldName = wi.worldSelect.value;
                if (!worldName || worldName === 'char_book' || !wi.data[worldName]) {
                    alert('请选择一个有效的全局世界进行删除。');
                    return;
                }

                if (confirm(`确定要删除世界 "${worldName}" 吗？此操作不可撤销。`)) {
                    delete wi.data[worldName];
                    await idbStorage.removeItem('wi_last_selected_world');
                    await saveWiData(wi.data);
                    await loadWiData(wi.charBook);
                }
            });

            wi.importWorldBtn.addEventListener('click', () => wi.importFileInput.click());
            wi.importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        let newEntries;
                        if (importedData.entries && typeof importedData.entries === 'object') {
                             newEntries = Object.values(importedData.entries).map((entry, idx) => ({
                                id: `wi_${Date.now()}_${entry.uid || idx}`,
                                name: entry.comment || '无标题',
                                keys: (entry.key || []).join(', '),
                                content: entry.content || '',
                                enabled: !entry.disable,
                            }));
                        } else if (Array.isArray(importedData)) {
                            newEntries = importedData;
                        } else {
                             throw new Error('无效的世界书文件格式。');
                        }

                        const proposedName = file.name.replace(/\.json$/i, '');
                        const worldName = prompt("为导入的世界书输入名称:", proposedName);

                        if (!worldName) return;
                        if (wi.data[worldName]) {
                            alert(`错误: 名为 "${worldName}" 的世界已存在。`);
                            return;
                        }

                        wi.data[worldName] = newEntries;
                        await saveWiData(wi.data);
                        await loadWiData(wi.charBook);
                        wi.worldSelect.value = worldName;
                        renderEntries(worldName);
                        alert(`成功导入 "${worldName}"!`);

                    } catch (err) { alert(`导入失败: ${err.message}`); }
                    finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            });

            // 新建条目
            wi.newEntryBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                if (!worldName) return;

                const isCharBook = worldName === 'char_book';
                const newEntry = {
                    id: `wi_${Date.now()}`,
                    enabled: true,
                    name: '新条目',
                    keys: [],
                    content: '',
                    case_sensitive: false,
                    whole_word: false,
                    position: 0,
                    role: 0,
                    scan_depth: 50,
                    use_regex: false
                };

                if (isCharBook && wi.charBook) {
                    if (!wi.charBook.entries) wi.charBook.entries = [];
                    wi.charBook.entries.push(newEntry);
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else if (wi.data[worldName]) {
                    wi.data[worldName].push(newEntry);
                    saveWiData(wi.data);
                }

                renderEntries(worldName);
                selectEntry(worldName, newEntry.id);
            });

            // 克隆条目
            wi.editor.cloneBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                if (!worldName || !entryId) return;

                const isCharBook = worldName === 'char_book';
                let dataSet = isCharBook ? wi.charBook?.entries : wi.data[worldName];
                const entry = dataSet?.find(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (!entry) return;

                const clonedEntry = {
                    ...entry,
                    id: `wi_${Date.now()}`,
                    name: (entry.name || entry.comment || '无标题') + ' (副本)'
                };

                if (isCharBook && wi.charBook) {
                    wi.charBook.entries.push(clonedEntry);
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    wi.data[worldName].push(clonedEntry);
                    saveWiData(wi.data);
                }

                renderEntries(worldName);
                selectEntry(worldName, clonedEntry.id);
            });

            // 删除条目
            wi.editor.deleteBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                if (!worldName || !entryId) return;

                if (!confirm('确定要删除此条目吗？此操作不可撤销。')) return;

                const isCharBook = worldName === 'char_book';
                let dataSet = isCharBook ? wi.charBook?.entries : wi.data[worldName];
                const entryIndex = dataSet?.findIndex(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (entryIndex === -1) return;

                dataSet.splice(entryIndex, 1);

                if (isCharBook) {
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    saveWiData(wi.data);
                }

                hideWiEditor();
                renderEntries(worldName);
            });

            // 自动保存 - 监听所有输入变化
            [wi.editor.enabled, wi.editor.name, wi.editor.keys, wi.editor.entryContent].forEach(element => {
                if (!element) return;
                const eventType = element.type === 'checkbox' ? 'change' : 'input';
                element.addEventListener(eventType, () => {
                    if (wi.editor.id.value) {
                        saveCurrentEntry();
                    }
                });
            });

            // 监听其他表单元素
            ['wi-keys-case-sensitive', 'wi-keys-whole-word', 'wi-entry-position', 'wi-entry-role', 'wi-scan-depth', 'wi-use-regex'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    const eventType = elem.type === 'checkbox' || elem.tagName === 'SELECT' ? 'change' : 'input';
                    elem.addEventListener(eventType, () => {
                        if (wi.editor.id.value) {
                            saveCurrentEntry();
                        }
                    });
                }
            });


            // --- Regex Logic ---
            const regex = {
                globalList: document.getElementById('global-regex-list'),
                localList: document.getElementById('local-regex-list'),
                newGlobalBtn: document.getElementById('regex-new-global-btn'),
                newLocalBtn: document.getElementById('regex-new-local-btn'),
                importBtn: document.getElementById('regex-import-btn'),
                importFile: document.getElementById('regex-import-file'),
                localEnableToggle: document.getElementById('local-regex-enable-toggle'),
                editor: {
                    id: document.getElementById('edit-regex-id'),
                    scope: document.getElementById('edit-regex-scope'),
                    name: document.getElementById('regex-name-input'),
                    find: document.getElementById('regex-find-input'),
                    replace: document.getElementById('regex-replace-input'),
                    placements: document.querySelectorAll('.regex-placement-cb'),
                    markdownOnly: document.getElementById('regex-markdown-only'),
                    promptOnly: document.getElementById('regex-prompt-only'),
                    minDepth: document.getElementById('regex-min-depth'),
                    maxDepth: document.getElementById('regex-max-depth'),
                    saveBtn: document.getElementById('save-regex-changes-btn'),
                    deleteBtn: document.getElementById('delete-regex-btn'),
                },
                importModal: {
                    modal: document.getElementById('import-regex-location-modal'),
                    confirmBtn: document.getElementById('confirm-regex-import-btn'),
                    cancelBtn: document.getElementById('cancel-regex-import-btn'),
                    location: () => document.querySelector('input[name="import-location"]:checked').value,
                },
                data: { global: [], local: [] },
                importedDataCache: null,
            };

            async function getRegexData() {
                const globalDataStr = await idbStorage.getItem('global_regex_v1');
                const globalData = globalDataStr ? JSON.parse(globalDataStr) : [];
                return { global: globalData };
            }

            async function saveRegexData() {
                await idbStorage.setItem('global_regex_v1', JSON.stringify(regex.data.global));
                const activeChar = char.data[char.activeCharacterId];
                if (activeChar) {
                    if(!activeChar.data) activeChar.data = {};
                    activeChar.data.regex = regex.data.local;
                    activeChar.data.regex_enabled = regex.localEnableToggle.checked;
                    await saveCharacters();
                }
                triggerAutoSave();
            }
            
            function createScriptItem(script, scope) {
                 const item = document.createElement('div');
                 item.className = 'regex-script-item flex items-center justify-between p-2 rounded-lg border cursor-pointer';
                 item.dataset.id = script.id;
                 item.dataset.scope = scope;
                 item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <i class="fas fa-grip-vertical drag-handle text-gray-400"></i>
                        <span class="font-medium text-sm truncate">${script.scriptName}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-eye text-gray-400" title="预览"></i>
                        <button class="edit-regex-btn w-8 h-8 flex items-center justify-center btn-secondary rounded-md" title="编辑"><i class="fas fa-pen"></i></button>
                        <input type="checkbox" class="switch regex-enable-toggle" ${!script.disabled ? 'checked' : ''}>
                    </div>
                 `;
                 item.querySelector('.edit-regex-btn').addEventListener('click', (e) => {
                     e.stopPropagation();
                     populateRegexEditor(script, scope);
                 });
                 item.querySelector('.regex-enable-toggle').addEventListener('click', (e) => {
                     e.stopPropagation();
                     script.disabled = !e.target.checked;
                     saveRegexData();
                 });
                 return item;
            }

            function renderRegexLists() {
                regex.globalList.innerHTML = '';
                regex.localList.innerHTML = '';

                // 确保 global 数组存在
                if (!regex.data.global || regex.data.global.length === 0) {
                    regex.globalList.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">没有找到脚本</p>';
                } else {
                    regex.data.global.forEach(script => regex.globalList.appendChild(createScriptItem(script, 'global')));
                }

                const activeCharExists = char.activeCharacterId && char.data[char.activeCharacterId];
                document.getElementById('local-regex-section').style.opacity = activeCharExists ? '1' : '0.5';
                document.getElementById('regex-new-local-btn').disabled = !activeCharExists;

                if (activeCharExists && regex.data.local && regex.data.local.length > 0) {
                    regex.data.local.forEach(script => regex.localList.appendChild(createScriptItem(script, 'local')));
                } else {
                     regex.localList.innerHTML = `<p class="text-sm text-gray-400 text-center py-4">${activeCharExists ? '没有找到脚本' : '请先选择一个角色'}</p>`;
                }

                new Sortable(regex.globalList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (e) => onRegexSort(e, 'global') });
                new Sortable(regex.localList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (e) => onRegexSort(e, 'local') });
            }

            function onRegexSort(evt, scope) {
                const reorderedData = Array.from(evt.to.children).map(item => {
                    return regex.data[scope].find(script => script.id === item.dataset.id);
                });
                regex.data[scope] = reorderedData;
                saveRegexData();
            }

            async function loadRegexData(characterRegex = [], characterRegexEnabled = false) {
                const data = await getRegexData();
                regex.data.global = data.global || [];
                regex.data.local = characterRegex || [];
                regex.localEnableToggle.checked = characterRegexEnabled;
                renderRegexLists();
            }
            
            function populateRegexEditor(script, scope) {
                regex.editor.id.value = script.id;
                regex.editor.scope.value = scope;
                regex.editor.name.value = script.scriptName || '';
                regex.editor.find.value = script.findRegex || '';
                regex.editor.replace.value = script.replaceString || '';
                regex.editor.markdownOnly.checked = script.markdownOnly || false;
                regex.editor.promptOnly.checked = script.promptOnly || false;
                regex.editor.minDepth.value = script.minDepth ?? '';
                regex.editor.maxDepth.value = script.maxDepth ?? '';
                
                regex.editor.placements.forEach(cb => {
                    const placementVal = parseInt(cb.dataset.placement);
                    cb.checked = (script.placement || []).includes(placementVal);
                });
                openEditRegexModal();
            }
            
            function saveRegexFromEditor() {
                const id = regex.editor.id.value;
                const scope = regex.editor.scope.value;
                if (!regex.data[scope]) return;
                const scriptIndex = regex.data[scope].findIndex(s => s.id === id);
                if (scriptIndex === -1) return;
                
                const script = regex.data[scope][scriptIndex];
                script.scriptName = regex.editor.name.value;
                script.findRegex = regex.editor.find.value;
                script.replaceString = regex.editor.replace.value;
                script.markdownOnly = regex.editor.markdownOnly.checked;
                script.promptOnly = regex.editor.promptOnly.checked;
                script.minDepth = regex.editor.minDepth.value ? parseInt(regex.editor.minDepth.value) : null;
                script.maxDepth = regex.editor.maxDepth.value ? parseInt(regex.editor.maxDepth.value) : null;
                
                script.placement = [];
                regex.editor.placements.forEach(cb => {
                    if (cb.checked) {
                        script.placement.push(parseInt(cb.dataset.placement));
                    }
                });
                
                saveRegexData();
                renderRegexLists();
                closeEditRegexModal();
            }
            
            function deleteRegexFromEditor() {
                if (!confirm('确定要删除这个正则脚本吗？')) return;
                const id = regex.editor.id.value;
                const scope = regex.editor.scope.value;
                if (!regex.data[scope]) return;
                regex.data[scope] = regex.data[scope].filter(s => s.id !== id);
                saveRegexData();
                renderRegexLists();
                closeEditRegexModal();
            }
            
            function createNewRegex(scope) {
                const newScript = {
                    id: `regex_${Date.now()}`,
                    scriptName: '新正则脚本',
                    findRegex: '',
                    replaceString: '',
                    placement: [1], // Default to AI Output
                    disabled: false,
                    markdownOnly: false,
                    promptOnly: false,
                    minDepth: null,
                    maxDepth: null
                };
                if (!regex.data[scope]) regex.data[scope] = [];
                regex.data[scope].push(newScript);
                saveRegexData();
                renderRegexLists();
                populateRegexEditor(newScript, scope);
            }
            
            regex.newGlobalBtn.addEventListener('click', () => createNewRegex('global'));
            regex.newLocalBtn.addEventListener('click', () => {
                 if (!char.activeCharacterId) {
                    alert('请先选择一个角色以添加局部正则。');
                    return;
                }
                createNewRegex('local')
            });
            regex.editor.saveBtn.addEventListener('click', saveRegexFromEditor);
            regex.editor.deleteBtn.addEventListener('click', deleteRegexFromEditor);
            regex.localEnableToggle.addEventListener('change', saveRegexData);
            
            regex.importBtn.addEventListener('click', () => regex.importFile.click());
            regex.importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        regex.importedDataCache = Array.isArray(imported) ? imported : [imported];
                        
                        if (!regex.importedDataCache.every(item => item.id && item.scriptName && item.findRegex !== undefined)) {
                            throw new Error('JSON 文件格式无效或缺少必要字段。');
                        }
                        
                        regex.importModal.modal.classList.add('active');
                        document.querySelector('input[name="import-location"][value="local"]').disabled = !char.activeCharacterId;

                    } catch(err) {
                        alert(`导入失败: ${err.message}`);
                        regex.importedDataCache = null;
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            });

            regex.importModal.confirmBtn.addEventListener('click', () => {
                if (!regex.importedDataCache) return;
                const location = regex.importModal.location();
                
                regex.importedDataCache.forEach(script => {
                    if (!regex.data[location]) regex.data[location] = [];
                    if (!regex.data[location].some(s => s.id === script.id)) {
                        regex.data[location].push(script);
                    }
                });
                
                saveRegexData();
                renderRegexLists();
                alert(`成功导入 ${regex.importedDataCache.length} 个脚本到${location === 'global' ? '全局' : '局部'}列表!`);
                regex.importModal.modal.classList.remove('active');
                regex.importedDataCache = null;
            });
            
            regex.importModal.cancelBtn.addEventListener('click', () => {
                regex.importModal.modal.classList.remove('active');
                regex.importedDataCache = null;
            });

            // --- Token计算和提示词预览 ---
            function estimateTokens(text) {
                // 简单的Token估算：平均每4个字符为1个token（英文）
                // 中文大约每个字2-3个token
                if (!text) return 0;

                const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
                const englishChars = text.length - chineseChars;

                // 中文字符按2.5个token计算，英文按0.25个token计算
                return Math.ceil(chineseChars * 2.5 + englishChars * 0.25);
            }

            function updatePromptPreview(messages) {
                if (!messages || messages.length === 0) return;

                const previewContent = document.getElementById('prompt-preview-content');
                if (!previewContent) return;

                let systemTokens = 0;
                let chatTokens = 0;
                let worldTokens = 0;
                let html = '';

                // 检查清单状态
                let hasSystemPrompt = false;
                let hasUserProfile = false;
                let hasCharDesc = false;
                let hasWorldInfo = false;
                let hasChatHistory = false;
                let hasRegex = regex.data.global.length > 0 || (regex.localEnableToggle?.checked && regex.data.local.length > 0);

                messages.forEach((msg, index) => {
                    const tokens = estimateTokens(msg.content);

                    if (msg.role === 'system') {
                        hasSystemPrompt = true;

                        // 检查系统消息中的各种内容
                        if (msg.content.includes('User:')) {
                            hasUserProfile = true;
                        }
                        if (msg.content.includes('Character:') || msg.content.includes('You are')) {
                            hasCharDesc = true;
                        }

                        // 检查是否包含世界书信息
                        if (msg.content.includes('World Information:')) {
                            hasWorldInfo = true;
                            const worldInfoStart = msg.content.indexOf('World Information:');
                            const beforeWorld = msg.content.substring(0, worldInfoStart);
                            const worldInfo = msg.content.substring(worldInfoStart);

                            systemTokens += estimateTokens(beforeWorld);
                            worldTokens += estimateTokens(worldInfo);
                        } else {
                            systemTokens += tokens;
                        }
                    } else {
                        chatTokens += tokens;
                        if (msg.role === 'user' || msg.role === 'assistant') {
                            hasChatHistory = true;
                        }
                    }

                    // 构建预览HTML
                    const roleColor = msg.role === 'system' ? 'bg-blue-50 border-blue-300' :
                                     msg.role === 'user' ? 'bg-green-50 border-green-300' :
                                     'bg-purple-50 border-purple-300';

                    const roleIcon = msg.role === 'system' ? 'fa-cog' :
                                    msg.role === 'user' ? 'fa-user' :
                                    'fa-robot';

                    const roleLabel = msg.role === 'system' ? '系统' :
                                     msg.role === 'user' ? '用户' :
                                     'AI助手';

                    html += `
                        <div class="border rounded-lg p-4 ${roleColor}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fas ${roleIcon}"></i>
                                    <span class="font-bold">${roleLabel}</span>
                                </div>
                                <span class="text-sm text-gray-600">${tokens} tokens</span>
                            </div>
                            <div class="text-sm whitespace-pre-wrap font-mono bg-white p-3 rounded border">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                });

                previewContent.innerHTML = html;

                // 更新Token统计
                document.getElementById('total-tokens').textContent = systemTokens + chatTokens + worldTokens;
                document.getElementById('system-tokens').textContent = systemTokens;
                document.getElementById('chat-tokens').textContent = chatTokens;
                document.getElementById('world-tokens').textContent = worldTokens;

                // 更新检查清单
                updateCheckItem('check-system-prompt', hasSystemPrompt);
                updateCheckItem('check-user-profile', hasUserProfile);
                updateCheckItem('check-char-desc', hasCharDesc);
                updateCheckItem('check-world-info', hasWorldInfo);
                updateCheckItem('check-chat-history', hasChatHistory);
                updateCheckItem('check-regex', hasRegex);
            }

            function updateCheckItem(id, status) {
                const element = document.getElementById(id);
                if (!element) return;

                const icon = element.querySelector('i');
                if (status) {
                    icon.className = 'fas fa-check-circle text-green-500';
                    element.style.opacity = '1';
                } else {
                    icon.className = 'fas fa-times-circle text-gray-400';
                    element.style.opacity = '0.6';
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function showPromptPreview() {
                const modal = document.getElementById('prompt-preview-modal');
                // 如果还没有构建过提示词，先构建一次
                if (!window.lastConstructedPrompt) {
                    const messages = await constructFinalPrompt();
                    window.lastConstructedPrompt = messages;
                }
                if (window.lastConstructedPrompt) {
                    updatePromptPreview(window.lastConstructedPrompt);
                }
                modal.classList.add('active');
            }

            // 将函数添加到全局作用域，以便 onclick 可以访问
            window.showPromptPreview = showPromptPreview;

            // 提示词预览模态框事件
            document.getElementById('close-prompt-preview')?.addEventListener('click', () => {
                document.getElementById('prompt-preview-modal').classList.remove('active');
            });

            document.getElementById('copy-prompt-btn')?.addEventListener('click', () => {
                if (window.lastConstructedPrompt) {
                    const text = window.lastConstructedPrompt.map(m => `[${m.role}]\n${m.content}`).join('\n\n');
                    navigator.clipboard.writeText(text).then(() => {
                        const btn = document.getElementById('copy-prompt-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>已复制';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    });
                }
            });

            // --- Chat Logic ---
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            // chatHistory 已在全局作用域声明
            let currentReply = null; // 当前回复的消息

            function startNewChat(greetingContent = null) {
                chatHistory = [];
                chatMessages.innerHTML = '';

                // 清理所有注入的样式元素
                document.querySelectorAll('style[id^="style-"]').forEach(style => {
                    style.remove();
                });

                const activeChar = char.data[char.activeCharacterId];

                // 如果指定了开场白内容,直接使用
                if (greetingContent) {
                    addMessageToHistory({role: 'assistant', content: greetingContent, type: 'text'});
                    return;
                }

                // 如果没有激活角色或没有开场白,直接返回
                if (!activeChar || !activeChar.first_mes) {
                    return;
                }

                // 收集所有可用的开场白
                const greetings = [activeChar.first_mes];
                if (activeChar.data && activeChar.data.alternate_greetings) {
                    greetings.push(...activeChar.data.alternate_greetings.filter(g => g && g.trim()));
                }

                // 如果只有一条开场白,直接使用
                if (greetings.length === 1) {
                    addMessageToHistory({role: 'assistant', content: greetings[0], type: 'text'});
                } else {
                    // 如果有多条开场白,显示选择弹窗
                    showGreetingSelector(greetings);
                }
            }

            function showGreetingSelector(greetings) {
                const modal = document.getElementById('greeting-selector-modal');
                const list = document.getElementById('greeting-list');
                list.innerHTML = '';

                // 清理之前可能注入到head的旧样式
                document.querySelectorAll('style[id^="style-preview-"]').forEach(style => {
                    style.remove();
                });

                greetings.forEach((greeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';

                    // 应用regex转换后获取预览
                    const processedGreeting = applyRegex(greeting);

                    // 创建元素而不是用innerHTML避免XSS
                    const flexDiv = document.createElement('div');
                    flexDiv.className = 'flex items-start gap-3';

                    const badge = document.createElement('div');
                    badge.className = 'flex-shrink-0 w-8 h-8 bg-primary-color text-white rounded-full flex items-center justify-center font-bold';
                    badge.textContent = index + 1;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex-1 min-w-0';

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'text-sm font-medium text-gray-900 mb-1';
                    titleDiv.textContent = `开场白 ${index + 1}`;

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'text-sm text-gray-600 break-words';
                    previewDiv.style.maxHeight = '200px';
                    previewDiv.style.overflow = 'hidden';
                    previewDiv.style.overflowWrap = 'break-word';
                    previewDiv.style.wordBreak = 'break-word';
                    previewDiv.style.maxWidth = '100%';

                    // 检查是否包含HTML内容
                    if (containsHTML(processedGreeting)) {
                        // 检查是否是完整的HTML文档（包含<!DOCTYPE, <html>, <body>等）
                        const isFullHTMLDoc = /<!DOCTYPE|<html|<body/i.test(processedGreeting);

                        if (isFullHTMLDoc) {
                            // 对于完整的HTML文档，不直接渲染，而是显示提示信息
                            // 避免同时渲染多个复杂iframe导致页面卡顿
                            const placeholder = document.createElement('div');
                            placeholder.className = 'p-4 bg-purple-50 border border-purple-200 rounded-lg text-center';
                            placeholder.innerHTML = `
                                <div class="text-purple-700 mb-2">
                                    <i class="fas fa-code text-2xl"></i>
                                </div>
                                <div class="text-sm text-purple-600 font-medium">包含完整HTML文档</div>
                                <div class="text-xs text-purple-500 mt-1">点击此开场白可查看完整内容</div>
                            `;
                            previewDiv.appendChild(placeholder);
                        } else {
                            // 非完整HTML文档，使用原有的div隔离方案
                            const sandbox = document.createElement('div');
                            sandbox.style.maxHeight = '200px';
                            sandbox.style.overflow = 'hidden';
                            sandbox.style.position = 'relative';
                            sandbox.style.maxWidth = '100%';

                            // 处理<style>标签
                            const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
                            const styles = [];
                            let match;

                            // 提取所有<style>标签内容
                            while ((match = styleRegex.exec(processedGreeting)) !== null) {
                                styles.push(match[1]);
                            }

                            if (styles.length > 0) {
                                // 移除原内容中的<style>标签
                                const contentWithoutStyles = processedGreeting.replace(styleRegex, '');

                                // 创建一个唯一的样式容器ID
                                const styleId = `greeting-preview-${index}`;

                                // 使用作用域限定的样式 - 添加前缀到所有选择器
                                let scopedStyles = styles.join('\n');
                                // 为每个CSS规则添加作用域前缀
                                scopedStyles = scopedStyles.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, (match, selector, separator) => {
                                    // 跳过 @规则 (如 @media, @keyframes)
                                    if (selector.trim().startsWith('@')) {
                                        return match;
                                    }
                                    // 添加作用域前缀
                                    return `#${styleId} ${selector.trim()}${separator}`;
                                });

                                // 创建一个带有唯一ID的wrapper
                                const styledWrapper = document.createElement('div');
                                styledWrapper.id = styleId;
                                styledWrapper.style.maxHeight = '200px';
                                styledWrapper.style.overflow = 'hidden';
                                styledWrapper.style.position = 'relative';
                                styledWrapper.style.maxWidth = '100%';

                                // 创建<style>元素并插入到wrapper内部
                                const styleElement = document.createElement('style');
                                styleElement.textContent = scopedStyles;
                                styledWrapper.appendChild(styleElement);

                                // 插入不含<style>的HTML内容
                                const contentContainer = document.createElement('div');
                                contentContainer.innerHTML = contentWithoutStyles;
                                styledWrapper.appendChild(contentContainer);

                                sandbox.appendChild(styledWrapper);
                            } else {
                                // 没有样式,直接使用innerHTML
                                sandbox.innerHTML = processedGreeting;
                            }

                            previewDiv.appendChild(sandbox);
                        }
                    } else {
                        // 纯文本内容
                        const textPreview = processedGreeting.length > 300 ? processedGreeting.substring(0, 300) + '...' : processedGreeting;
                        previewDiv.textContent = textPreview;
                        previewDiv.style.whiteSpace = 'pre-wrap';
                    }

                    contentDiv.appendChild(titleDiv);
                    contentDiv.appendChild(previewDiv);
                    flexDiv.appendChild(badge);
                    flexDiv.appendChild(contentDiv);
                    item.appendChild(flexDiv);

                    item.addEventListener('click', () => {
                        modal.style.display = 'none';
                        startNewChat(greeting);
                    });

                    list.appendChild(item);
                });

                modal.style.display = 'flex';
            }
            
            async function addMessageToHistory(messageData) {
                const messageId = `msg_${Date.now()}`;
                const message = { id: messageId, ...messageData };
                chatHistory.push(message);
                renderMessage(message);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // 自动保存聊天记录
                if (char.activeCharacterId) {
                    await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    triggerAutoSave();
                }
            }

            async function loadChatHistory(characterId) {
                // 尝试从IndexedDB加载该角色的聊天记录
                const savedHistory = await idbStorage.getItem(`chat_history_${characterId}`);
                if (savedHistory) {
                    try {
                        chatHistory = JSON.parse(savedHistory);
                        // 清空聊天界面
                        chatMessages.innerHTML = '';
                        // 清理所有注入的样式元素
                        document.querySelectorAll('style[id^="style-"]').forEach(style => {
                            style.remove();
                        });
                        // 重新渲染所有消息(跳过隐藏的消息)
                        chatHistory.forEach(message => {
                            if (!message.hidden) {
                                renderMessage(message);
                            }
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } catch (e) {
                        console.error('Failed to load chat history:', e);
                        // 如果加载失败，则开始新聊天
                        startNewChat();
                    }
                } else {
                    // 没有保存的聊天记录，开始新聊天
                    startNewChat();
                }
            }

            // 保存聊天记录
            async function saveChat() {
                if (char.activeCharacterId) {
                    try {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        triggerAutoSave();
                    } catch (e) {
                        console.error('保存聊天记录失败:', e);
                    }
                }
            }

            // 重新渲染所有消息
            function renderMessages() {
                // 清空聊天界面
                chatMessages.innerHTML = '';
                // 清理所有注入的样式元素
                document.querySelectorAll('style[id^="style-"]').forEach(style => {
                    style.remove();
                });
                // 重新渲染所有消息（跳过隐藏的消息）
                chatHistory.forEach(message => {
                    if (!message.hidden) {
                        renderMessage(message);
                    }
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // 检测是否包含HTML标签（仅用于regex替换后的内容）
            function containsHTML(text) {
                // 检测是否包含HTML标签，排除常见的符号组合
                return /<[a-z][\s\S]*>/i.test(text);
            }

            // 为iframe注入透明背景样式
            function injectTransparentStyles(iframeDoc) {
                if (!iframeDoc || !iframeDoc.head) return;
                try {
                    const transparentStyle = iframeDoc.createElement('style');
                    transparentStyle.textContent = `
                        /* 让iframe的body背景透明,但不影响状态栏组件本身的样式 */
                        html, body {
                            background-color: transparent !important;
                        }
                    `;
                    iframeDoc.head.appendChild(transparentStyle);
                } catch (e) {
                    console.log('[iframe] 无法注入透明样式:', e);
                }
            }

            function applyRegex(text) {
                let processedText = text;
                const allScripts = [
                    ...(regex.data.global || []),
                    ...(regex.localEnableToggle.checked ? (regex.data.local || []) : [])
                ];

                for (const script of allScripts) {
                    if (script.disabled || !script.findRegex) continue;
                    try {
                        let pattern = script.findRegex;
                        let flags = 'g'; // Default global flag

                        // Check if findRegex is in /pattern/flags format
                        if (pattern.startsWith('/')) {
                            const lastSlashIndex = pattern.lastIndexOf('/');
                            if (lastSlashIndex > 0) {
                                // Extract flags (everything after last slash)
                                const extractedFlags = pattern.substring(lastSlashIndex + 1);
                                // Extract pattern (between first and last slash)
                                pattern = pattern.substring(1, lastSlashIndex);
                                // Combine extracted flags with default 'g' flag
                                flags = extractedFlags.includes('g') ? extractedFlags : extractedFlags + 'g';
                            }
                        }

                        const re = new RegExp(pattern, flags);
                        // 使用函数形式的replace来正确处理捕获组
                        processedText = processedText.replace(re, function(match, ...groups) {
                            let result = script.replaceString;
                            // 替换 $1, $2, $3 等捕获组
                            groups.forEach((group, index) => {
                                if (group !== undefined) {
                                    // 使用正则替换所有出现的 $1, $2 等
                                    const placeholder = new RegExp('\\$' + (index + 1), 'g');
                                    result = result.replace(placeholder, group);
                                }
                            });
                            return result;
                        });
                    } catch (e) {
                        console.error(`Regex error in script "${script.scriptName}":`, e);
                    }
                }
                return processedText;
            }

            function renderMessage(message) {
                 const { id, role, content, type = 'text', replyTo, imageUrl, description } = message;

                const isUser = role === 'user';

                const group = document.createElement('div');
                group.id = id;
                group.className = `chat-message-group flex flex-col items-center gap-1 mb-3`;
                group.style.position = 'relative';

                // 获取用户头像
                const currentUser = userManagement.getCurrentUser();
                const charAvatar = char.data[char.activeCharacterId]?.avatar;
                const charAvatarSrc = (charAvatar && charAvatar !== 'none') ? charAvatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                let avatarSrc = isUser ? (currentUser?.avatar || 'https://placehold.co/40x40/E4E6EB/1A1A1D?text=U') : charAvatarSrc;

                // 头像和名称
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'flex flex-col items-center gap-1';

                const avatarImg = document.createElement('img');
                avatarImg.src = avatarSrc;
                avatarImg.className = 'w-12 h-12 rounded-full object-cover';
                avatarImg.addEventListener('dblclick', () => {
                    avatarImg.classList.add('patted');
                    setTimeout(() => avatarImg.classList.remove('patted'), 600);
                });

                const userName = document.createElement('span');
                userName.className = 'text-xs text-gray-500 font-medium';
                userName.textContent = isUser ? (userManagement.getCurrentUser()?.name || '用户') : (char.data[char.activeCharacterId]?.name || 'AI');

                // 添加消息操作栏（放在头像下方，横向排列）
                const actionsBar = document.createElement('div');
                actionsBar.className = 'message-actions flex flex-row gap-1 mt-1';

                // 编辑按钮
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn text-xs px-1.5 py-1';
                editBtn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                editBtn.title = '编辑';
                editBtn.onclick = () => startEditMessage(id);
                actionsBar.appendChild(editBtn);

                // 重新生成按钮 (仅AI消息)
                if (!isUser) {
                    const regenBtn = document.createElement('button');
                    regenBtn.className = 'message-action-btn text-xs px-1.5 py-1';
                    regenBtn.innerHTML = '<i class="fas fa-sync-alt text-xs"></i>';
                    regenBtn.title = '重新生成';
                    regenBtn.onclick = () => regenerateMessage(id);
                    actionsBar.appendChild(regenBtn);
                }

                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn danger text-xs px-1.5 py-1';
                deleteBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                deleteBtn.title = '删除';
                deleteBtn.onclick = () => {
                    if (confirm('确定要删除这条消息吗？')) {
                        deleteMessage(id);
                    }
                };
                actionsBar.appendChild(deleteBtn);

                avatarContainer.appendChild(avatarImg);
                avatarContainer.appendChild(userName);
                avatarContainer.appendChild(actionsBar);
                group.appendChild(avatarContainer);

                const messageContentContainer = document.createElement('div');
                messageContentContainer.className = `flex flex-col w-full`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `chat-bubble rounded-lg p-3 w-full ${isUser ? 'user-bubble' : 'ai-bubble'}`;
                messageBubble.dataset.messageId = id;

                if (replyTo) {
                    const replyRef = document.createElement('div');
                    replyRef.className = 'reply-reference';
                    replyRef.innerHTML = `<div class="reply-from">回复 ${replyTo.fromName}</div>
                                          <div>${replyTo.content.substring(0, 50)}...</div>`;
                    messageBubble.appendChild(replyRef);
                }

                let finalContent = content;

                if (type === 'text') {
                    // 只对AI消息应用regex
                    if (!isUser) {
                        finalContent = applyRegex(content);
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content text-left whitespace-pre-wrap';

                    // 检查是否是HTML代码块或完整的HTML文档
                    if (finalContent.trim().startsWith('```html') || finalContent.trim().startsWith('<!DOCTYPE html>') || finalContent.trim().startsWith('```\n<!DOCTYPE html>')) {
                        // 移除markdown代码块标记
                        let htmlContent = finalContent.trim();
                        // 移除开头的 ```html 或 ```
                        htmlContent = htmlContent.replace(/^```html\s*\n?/, '').replace(/^```\s*\n?/, '');
                        // 移除结尾的 ```
                        htmlContent = htmlContent.replace(/\n?```\s*$/, '');
                        htmlContent = htmlContent.trim();

                        console.log('[iframe] 准备渲染HTML内容，长度:', htmlContent.length);

                        // 创建iframe容器
                        const iframeContainer = document.createElement('div');
                        iframeContainer.className = 'iframe-container';
                        iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                        // 创建iframe并设置适当的sandbox权限（参考SillyTavern）
                        const iframe = document.createElement('iframe');
                        iframe.className = 'rendered-html-iframe';
                        // 设置sandbox权限：允许脚本、同源访问、表单和模态框
                        iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';

                        // 设置iframe样式
                        iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                        // 检测是否为移动设备
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                        console.log('[iframe] 设备类型:', isMobile ? '移动端' : 'PC端');

                        // 统一使用srcdoc方式加载，避免Blob URL的跨域安全问题
                        console.log('[iframe] 使用srcdoc加载');
                        iframe.srcdoc = htmlContent;

                        // 添加加载状态指示
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;';
                        loadingIndicator.textContent = '加载中...';
                        iframeContainer.appendChild(loadingIndicator);

                        // 监听iframe加载
                        iframe.addEventListener('load', function() {
                            console.log('[iframe] 加载完成');
                            loadingIndicator.remove();

                            try {
                                const iframeWindow = iframe.contentWindow;
                                if (iframeWindow) {
                                    // 注入透明背景样式
                                    const iframeDoc = iframe.contentDocument || iframeWindow.document;
                                    injectTransparentStyles(iframeDoc);

                                    // 捕获iframe内部的JavaScript错误
                                    iframeWindow.addEventListener('error', function(event) {
                                        console.error('[iframe] 内部错误:', event.error || event.message);
                                    });

                                    // 捕获未处理的Promise拒绝
                                    iframeWindow.addEventListener('unhandledrejection', function(event) {
                                        console.error('[iframe] Promise错误:', event.reason);
                                    });

                                    // 音频播放修复（移动端和PC端）
                                    console.log('[iframe] 注入音频播放支持代码');

                                    // 注入音频播放解锁代码
                                    const audioFix = iframeWindow.document.createElement('script');
                                    audioFix.textContent = `
                                            (function() {
                                                console.log('[Mobile Audio Fix] 初始化移动端音频支持');

                                                // 等待用户的第一次交互来解锁音频
                                                let hasInteracted = false;

                                                function markInteraction() {
                                                    if (hasInteracted) return;
                                                    hasInteracted = true;
                                                    console.log('[Mobile Audio Fix] 用户已交互，音频已解锁');
                                                    tryPlayMusic();
                                                }

                                                function tryPlayMusic() {
                                                    if (!hasInteracted) return;

                                                    const bgmPlayer = document.getElementById('bgMusic');
                                                    if (!bgmPlayer) return;

                                                    if (bgmPlayer.paused && bgmPlayer.src && bgmPlayer.src !== window.location.href) {
                                                        bgmPlayer.play().catch(e => console.error("Autoplay prevent after interaction:", e));
                                                    }
                                                }

                                                // 在第一次用户交互时解锁（使用捕获阶段）
                                                document.addEventListener('click', (e) => {
                                                    markInteraction();
                                                }, true); // 使用捕获阶段，确保在其他事件之前触发

                                                document.addEventListener('touchstart', (e) => {
                                                    markInteraction();
                                                }, true);

                                                document.addEventListener('touchend', (e) => {
                                                    markInteraction();
                                                }, true);

                                                // 监听其他可能的交互事件
                                                document.addEventListener('touchmove', (e) => {
                                                    markInteraction();
                                                }, { once: true, capture: true });

                                                // 页面可见性变化时尝试恢复播放
                                                document.addEventListener('visibilitychange', () => {
                                                    if (!document.hidden && hasInteracted) {
                                                        tryPlayMusic();
                                                    }
                                                });

                                                // 覆盖原有的音频播放函数，添加移动端支持
                                                if (window.toggleMusic) {
                                                    const originalToggleMusic = window.toggleMusic;
                                                    window.toggleMusic = function() {
                                                        markInteraction(); // 确保标记交互
                                                        console.log('[Mobile Audio Fix] toggleMusic 被调用');

                                                        const music = document.getElementById('bgMusic');
                                                        if (!music) {
                                                            console.log('[Mobile Audio Fix] 未找到bgMusic元素');
                                                            return;
                                                        }

                                                        if (!music.src || music.src === window.location.href) {
                                                            console.log('[Mobile Audio Fix] 音乐源未设置');
                                                            return;
                                                        }

                                                        if (music.paused) {
                                                            console.log('[Mobile Audio Fix] 尝试播放音乐:', music.src);
                                                            const playPromise = music.play();
                                                            if (playPromise !== undefined) {
                                                                playPromise.then(() => {
                                                                    console.log('[Mobile Audio Fix] 音乐播放成功');
                                                                }).catch(err => {
                                                                    console.error('[Mobile Audio Fix] 播放失败:', err);
                                                                });
                                                            }
                                                        } else {
                                                            console.log('[Mobile Audio Fix] 暂停音乐');
                                                            music.pause();
                                                        }

                                                        // 更新按钮图标
                                                        const playIcon = document.getElementById('musicIconPlay');
                                                        const pauseIcon = document.getElementById('musicIconPause');
                                                        if (playIcon && pauseIcon) {
                                                            if (music.paused) {
                                                                playIcon.style.display = 'block';
                                                                pauseIcon.style.display = 'none';
                                                            } else {
                                                                playIcon.style.display = 'none';
                                                                pauseIcon.style.display = 'block';
                                                            }
                                                        }
                                                    };
                                                }

                                                // 监听nextScene函数，在切换场景时也尝试播放音乐
                                                if (window.nextScene) {
                                                    const originalNextScene = window.nextScene;
                                                    window.nextScene = function() {
                                                        const result = originalNextScene.apply(this, arguments);

                                                        // 延迟检查是否需要播放新音乐
                                                        setTimeout(() => {
                                                            if (hasInteracted) {
                                                                const music = document.getElementById('bgMusic');
                                                                if (music && music.src && !music.paused) {
                                                                    // 如果音乐正在播放但被阻止了，重新尝试
                                                                    if (music.readyState > 0) {
                                                                        const playPromise = music.play();
                                                                        if (playPromise !== undefined) {
                                                                            playPromise.catch(err => {
                                                                                console.log('[Mobile Audio Fix] 场景切换后音乐播放失败:', err);
                                                                            });
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }, 100);

                                                        return result;
                                                    };
                                                }

                                                console.log('[Mobile Audio Fix] 音频播放支持已安装');
                                            })();
                                        `;
                                        iframeWindow.document.body.appendChild(audioFix);
                                }
                            } catch (e) {
                                console.log('[iframe] 无法访问iframe窗口:', e);
                            }
                        });

                        // 监听加载错误
                        iframe.addEventListener('error', function(e) {
                            console.error('[iframe] 加载错误:', e);
                            loadingIndicator.textContent = '加载失败';
                            loadingIndicator.style.color = 'red';
                        });

                        // 等待iframe加载完成后调整高度
                        iframe.addEventListener('load', function() {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (iframeDoc && iframeDoc.body) {
                                    // 注入透明背景样式
                                    injectTransparentStyles(iframeDoc);

                                    // 等待iframe内容完全渲染
                                    setTimeout(() => {
                                        try {
                                            const height = Math.max(
                                                iframeDoc.body.scrollHeight,
                                                iframeDoc.documentElement.scrollHeight,
                                                iframeDoc.body.offsetHeight,
                                                iframeDoc.documentElement.offsetHeight,
                                                400 // 最小高度
                                            );
                                            console.log('[iframe] 调整高度为:', height);
                                            iframe.style.height = height + 'px';
                                            iframeContainer.style.minHeight = height + 'px';
                                        } catch (e) {
                                            console.log('[iframe] 无法访问iframe高度:', e);
                                            // 使用默认高度
                                            iframe.style.height = '600px';
                                        }
                                    }, 100);
                                }
                            } catch (e) {
                                console.log('[iframe] 无法访问iframe文档:', e);
                                iframe.style.height = '600px';
                            }
                        });

                        iframeContainer.appendChild(iframe);
                        messageBubble.appendChild(iframeContainer);
                        messageBubble.className += ' p-0 overflow-hidden';
                    } else if (containsHTML(finalContent)) {
                        // 检查是否包含完整的HTML文档
                        const hasFullHTMLDoc = /<!DOCTYPE|<html[^>]*>|<head[^>]*>|<body[^>]*>/i.test(finalContent);

                        if (hasFullHTMLDoc) {
                            // 如果包含完整HTML文档,可能是文本+HTML的混合内容
                            // 尝试分离文本部分和HTML部分
                            const htmlDocMatch = finalContent.match(/(<!DOCTYPE[\s\S]*|<html[\s\S]*)/i);

                            if (htmlDocMatch && htmlDocMatch.index > 0) {
                                // 有文本部分在HTML之前
                                const textPart = finalContent.substring(0, htmlDocMatch.index).trim();
                                const htmlPart = htmlDocMatch[0];

                                // 处理文本部分 - 转换换行符
                                if (textPart) {
                                    const textDiv = document.createElement('div');
                                    textDiv.className = 'mb-4';
                                    const textWithBreaks = textPart
                                        .replace(/\r\n/g, '<br>')
                                        .replace(/\r/g, '<br>')
                                        .replace(/\n/g, '<br>');
                                    textDiv.innerHTML = textWithBreaks;
                                    messageBubble.appendChild(textDiv);
                                }

                                // 处理HTML部分 - 使用iframe
                                if (htmlPart) {
                                    const iframeContainer = document.createElement('div');
                                    iframeContainer.className = 'iframe-container mt-4';
                                    iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                    const iframe = document.createElement('iframe');
                                    iframe.className = 'rendered-html-iframe';
                                    iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                    iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                                    iframe.srcdoc = htmlPart;

                                    // 监听iframe加载完成后调整高度
                                    iframe.addEventListener('load', function() {
                                        try {
                                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                            if (iframeDoc && iframeDoc.body) {
                                                // 注入CSS使白色背景透明
                                                injectTransparentStyles(iframeDoc);

                                                setTimeout(() => {
                                                    try {
                                                        const height = Math.max(
                                                            iframeDoc.body.scrollHeight,
                                                            iframeDoc.documentElement.scrollHeight,
                                                            400
                                                        );
                                                        iframe.style.height = height + 'px';
                                                        iframeContainer.style.minHeight = height + 'px';
                                                    } catch (e) {
                                                        iframe.style.height = '600px';
                                                    }
                                                }, 100);
                                            }
                                        } catch (e) {
                                            iframe.style.height = '600px';
                                        }
                                    });

                                    iframeContainer.appendChild(iframe);
                                    messageBubble.appendChild(iframeContainer);
                                    messageBubble.className += ' p-0 overflow-hidden';
                                }
                            } else {
                                // 整个内容都是HTML文档,使用原有的iframe渲染逻辑
                                const iframeContainer = document.createElement('div');
                                iframeContainer.className = 'iframe-container';
                                iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                const iframe = document.createElement('iframe');
                                iframe.className = 'rendered-html-iframe';
                                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';
                                iframe.srcdoc = finalContent;

                                // 监听iframe加载完成后注入透明样式
                                iframe.addEventListener('load', function() {
                                    try {
                                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                        if (iframeDoc) {
                                            injectTransparentStyles(iframeDoc);
                                        }
                                    } catch (e) {
                                        console.log('[iframe] 无法注入透明样式:', e);
                                    }
                                });

                                iframeContainer.appendChild(iframe);
                                messageBubble.appendChild(iframeContainer);
                                messageBubble.className += ' p-0 overflow-hidden';
                            }
                        } else {
                            // 不是完整HTML文档,检查是否包含需要iframe的特殊元素
                            const needsIframe = /<audio[^>]*>/i.test(finalContent) ||
                                              /<video[^>]*>/i.test(finalContent) ||
                                              /<iframe[^>]*>/i.test(finalContent) ||
                                              /<script[^>]*>/i.test(finalContent);

                            if (needsIframe) {
                                // 使用iframe渲染
                                const iframeContainer = document.createElement('div');
                                iframeContainer.className = 'iframe-container';
                                iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                const iframe = document.createElement('iframe');
                                iframe.className = 'rendered-html-iframe';
                                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                                // 检测是否为移动设备
                                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                                let loadSuccess = false;

                                // PC端优先使用Blob URL
                                if (!isMobile) {
                                    try {
                                        const blob = new Blob([finalContent], { type: 'text/html; charset=utf-8' });
                                        const blobUrl = URL.createObjectURL(blob);
                                        iframe.src = blobUrl;

                                        iframe.addEventListener('load', function() {
                                            setTimeout(() => {
                                                URL.revokeObjectURL(blobUrl);
                                            }, 1000);
                                        });

                                        loadSuccess = true;
                                    } catch (e) {
                                        console.error('[iframe] Blob URL加载失败:', e);
                                    }
                                }

                                // 移动端或失败时使用srcdoc
                                if (!loadSuccess) {
                                    iframe.srcdoc = finalContent;
                                }

                                // 监听iframe内部错误
                                iframe.addEventListener('load', function() {
                                    try {
                                    const iframeWindow = iframe.contentWindow;
                                    if (iframeWindow) {
                                        // 注入透明背景样式
                                        const iframeDoc = iframe.contentDocument || iframeWindow.document;
                                        injectTransparentStyles(iframeDoc);

                                        iframeWindow.addEventListener('error', function(event) {
                                            console.error('[iframe] 内部错误:', event.error || event.message);
                                        });
                                        iframeWindow.addEventListener('unhandledrejection', function(event) {
                                            console.error('[iframe] Promise错误:', event.reason);
                                        });

                                        // 音频播放修复（移动端和PC端）
                                        console.log('[iframe] 注入音频播放支持代码');

                                        const audioFix = iframeWindow.document.createElement('script');
                                        audioFix.textContent = `
                                                (function() {
                                                    console.log('[Mobile Audio Fix] 初始化移动端音频支持');

                                                    let hasInteracted = false;

                                                    function markInteraction() {
                                                        if (hasInteracted) return;
                                                        hasInteracted = true;
                                                        console.log('[Mobile Audio Fix] 用户已交互，音频已解锁');
                                                        tryPlayMusic();
                                                    }

                                                    function tryPlayMusic() {
                                                        if (!hasInteracted) return;

                                                        const bgmPlayer = document.getElementById('bgMusic');
                                                        if (!bgmPlayer) return;

                                                        if (bgmPlayer.paused && bgmPlayer.src && bgmPlayer.src !== window.location.href) {
                                                            bgmPlayer.play().catch(e => console.error("Autoplay prevent after interaction:", e));
                                                        }
                                                    }

                                                    // 在第一次用户交互时解锁（使用捕获阶段）
                                                    document.addEventListener('click', (e) => {
                                                        markInteraction();
                                                    }, true);

                                                    document.addEventListener('touchend', (e) => {
                                                        markInteraction();
                                                    }, true);

                                                    if (window.toggleMusic) {
                                                        const originalToggleMusic = window.toggleMusic;
                                                        window.toggleMusic = function() {
                                                            markInteraction();
                                                            console.log('[Mobile Audio Fix] toggleMusic 被调用');

                                                            const music = document.getElementById('bgMusic');
                                                            if (!music) {
                                                                console.log('[Mobile Audio Fix] 未找到bgMusic元素');
                                                                return;
                                                            }

                                                            if (!music.src || music.src === window.location.href) {
                                                                console.log('[Mobile Audio Fix] 音乐源未设置');
                                                                return;
                                                            }

                                                            if (music.paused) {
                                                                console.log('[Mobile Audio Fix] 尝试播放音乐:', music.src);
                                                                const playPromise = music.play();
                                                                if (playPromise !== undefined) {
                                                                    playPromise.then(() => {
                                                                        console.log('[Mobile Audio Fix] 音乐播放成功');
                                                                    }).catch(err => {
                                                                        console.error('[Mobile Audio Fix] 播放失败:', err);
                                                                    });
                                                                }
                                                            } else {
                                                                console.log('[Mobile Audio Fix] 暂停音乐');
                                                                music.pause();
                                                            }

                                                            const playIcon = document.getElementById('musicIconPlay');
                                                            const pauseIcon = document.getElementById('musicIconPause');
                                                            if (playIcon && pauseIcon) {
                                                                if (music.paused) {
                                                                    playIcon.style.display = 'block';
                                                                    pauseIcon.style.display = 'none';
                                                                } else {
                                                                    playIcon.style.display = 'none';
                                                                    pauseIcon.style.display = 'block';
                                                                }
                                                            }
                                                        };
                                                    }

                                                    if (window.nextScene) {
                                                        const originalNextScene = window.nextScene;
                                                        window.nextScene = function() {
                                                            const result = originalNextScene.apply(this, arguments);

                                                            setTimeout(() => {
                                                                if (hasInteracted) {
                                                                    const music = document.getElementById('bgMusic');
                                                                    if (music && music.src && !music.paused) {
                                                                        if (music.readyState > 0) {
                                                                            const playPromise = music.play();
                                                                            if (playPromise !== undefined) {
                                                                                playPromise.catch(err => {
                                                                                    console.log('[Mobile Audio Fix] 场景切换后音乐播放失败:', err);
                                                                                });
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }, 100);

                                                            return result;
                                                        };
                                                    }

                                                    console.log('[Mobile Audio Fix] 音频播放支持已安装');
                                                })();
                                            `;
                                            iframeWindow.document.body.appendChild(audioFix);
                                    }
                                } catch (e) {
                                    console.log('[iframe] 无法访问iframe窗口:', e);
                                }
                            });

                                iframe.addEventListener('load', function() {
                                    try {
                                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                        if (iframeDoc && iframeDoc.body) {
                                            // 注入透明背景样式
                                            injectTransparentStyles(iframeDoc);

                                            setTimeout(() => {
                                                try {
                                                    const height = Math.max(
                                                        iframeDoc.body.scrollHeight,
                                                        iframeDoc.documentElement.scrollHeight,
                                                        iframeDoc.body.offsetHeight,
                                                        iframeDoc.documentElement.offsetHeight,
                                                        400
                                                    );
                                                    iframe.style.height = height + 'px';
                                                    iframeContainer.style.minHeight = height + 'px';
                                                } catch (e) {
                                                    console.log('[iframe] 无法访问iframe高度:', e);
                                                    iframe.style.height = '600px';
                                                }
                                            }, 100);
                                        }
                                    } catch (e) {
                                        console.log('[iframe] 无法访问iframe文档:', e);
                                        iframe.style.height = '600px';
                                    }
                                });

                                iframeContainer.appendChild(iframe);
                                messageBubble.appendChild(iframeContainer);
                                messageBubble.className += ' p-0 overflow-hidden';
                            } else {
                                // 如果regex替换后包含HTML标签,需要特殊处理<style>标签
                                // 检查是否包含<style>标签
                                const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
                                const styles = [];
                                let match;

                                // 提取所有<style>标签内容
                                while ((match = styleRegex.exec(finalContent)) !== null) {
                                    styles.push(match[1]);
                                }

                                if (styles.length > 0) {
                                    // 如果有样式,移除原内容中的<style>标签
                                    const contentWithoutStyles = finalContent.replace(styleRegex, '');

                                    // 创建一个唯一的样式容器ID
                                    const styleId = `style-${id}`;

                                    // 创建并插入<style>元素到文档头部
                                    const styleElement = document.createElement('style');
                                    styleElement.id = styleId;
                                    styleElement.textContent = styles.join('\n');
                                    document.head.appendChild(styleElement);

                                    // 插入不含<style>的HTML内容
                                    // 先转换所有类型的换行符为<br>标签,确保换行被保留
                                    // 处理 \r\n (Windows), \n (Unix/Linux), \r (Mac)
                                    const contentWithBreaks = contentWithoutStyles
                                        .replace(/\r\n/g, '<br>')  // Windows换行
                                        .replace(/\r/g, '<br>')    // Mac换行
                                        .replace(/\n/g, '<br>');   // Unix/Linux换行
                                    contentDiv.innerHTML = contentWithBreaks;
                                    contentDiv.setAttribute('data-style-id', styleId);
                                } else {
                                    // 没有样式,直接使用innerHTML
                                    // 先转换所有类型的换行符为<br>标签,确保换行被保留
                                    const contentWithBreaks = finalContent
                                        .replace(/\r\n/g, '<br>')  // Windows换行
                                        .replace(/\r/g, '<br>')    // Mac换行
                                        .replace(/\n/g, '<br>');   // Unix/Linux换行
                                    contentDiv.innerHTML = contentWithBreaks;
                                }

                                messageBubble.appendChild(contentDiv);
                            }
                        }
                    } else {
                        // 否则使用textContent保持纯文本,保留换行
                        contentDiv.textContent = finalContent;
                        messageBubble.appendChild(contentDiv);
                    }
                } else if (type === 'image') {
                    messageBubble.className += ' image-bubble';
                    // 使用imageUrl显示图片（缩略图），并在下方显示AI识别的描述
                    const imgSrc = imageUrl || content; // 兼容旧数据
                    messageBubble.innerHTML += `
                        <div class="image-message">
                            <img src="${imgSrc}" alt="image" onclick="showImagePreview('${imgSrc}')">
                            ${description ? `<div style="padding: 8px; font-size: 13px; color: var(--text-secondary-color); border-top: 1px solid var(--border-color); margin-top: 8px; background: rgba(0,0,0,0.02);">
                                <i class="fas fa-robot" style="margin-right: 4px;"></i>${description}
                            </div>` : ''}
                        </div>
                    `;
                }

                messageContentContainer.appendChild(messageBubble);

                group.appendChild(messageContentContainer);
                chatMessages.appendChild(group);
            }

            async function deleteMessage(id) {
                const messageIndex = chatHistory.findIndex(m => m.id === id);
                if (messageIndex > -1) {
                    chatHistory.splice(messageIndex, 1);
                    const messageElement = document.getElementById(id);

                    // 清理该消息注入的样式
                    const styleId = `style-${id}`;
                    const styleElement = document.getElementById(styleId);
                    if (styleElement) {
                        styleElement.remove();
                    }

                    messageElement?.remove();

                    // 保存更新后的聊天记录
                    if (char.activeCharacterId) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    }
                }
            }

            // 消息编辑功能
            let currentEditingMessageId = null;

            function startEditMessage(messageId) {
                const message = chatHistory.find(m => m.id === messageId);
                if (!message || message.type !== 'text') return;

                currentEditingMessageId = messageId;

                // 填充弹窗内容
                document.getElementById('edit-message-textarea').value = message.content;

                // 显示弹窗
                document.getElementById('message-edit-modal').classList.add('active');
            }

            function saveEditMessage(messageId, newContent) {
                if (!messageId) messageId = currentEditingMessageId;
                const message = chatHistory.find(m => m.id === messageId);
                if (!message) return;

                const trimmedContent = newContent.trim();
                if (!trimmedContent) {
                    alert('消息内容不能为空！');
                    return;
                }

                // 更新历史记录
                message.content = trimmedContent;

                // 重新渲染消息
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    const bubble = messageElement.querySelector('.chat-bubble');
                    const contentDiv = bubble.querySelector('.message-content');

                    if (contentDiv) {
                        // 只对AI消息应用regex
                        let processedContent = trimmedContent;
                        if (message.role === 'assistant') {
                            processedContent = applyRegex(trimmedContent);
                        }

                        // 如果包含HTML,使用innerHTML;否则使用textContent
                        if (containsHTML(processedContent)) {
                            // 转换所有类型的换行符为<br>标签
                            const contentWithBreaks = processedContent
                                .replace(/\r\n/g, '<br>')
                                .replace(/\r/g, '<br>')
                                .replace(/\n/g, '<br>');
                            contentDiv.innerHTML = contentWithBreaks;
                        } else {
                            contentDiv.textContent = processedContent;
                        }
                        contentDiv.className = 'message-content text-left whitespace-pre-wrap';
                    }
                }

                // 关闭弹窗
                document.getElementById('message-edit-modal').classList.remove('active');
                currentEditingMessageId = null;

                // 如果编辑的是用户消息，提示是否重新生成AI回复
                if (message.role === 'user') {
                    const messageIndex = chatHistory.findIndex(m => m.id === messageId);
                    const nextMessage = chatHistory[messageIndex + 1];

                    if (nextMessage && nextMessage.role === 'assistant') {
                        if (confirm('用户消息已修改，是否重新生成AI回复？')) {
                            regenerateMessage(nextMessage.id);
                        }
                    }
                }
            }

            function cancelEditMessage() {
                const modal = document.getElementById('message-edit-modal');
                modal.classList.remove('active');
                // 重置扩大状态
                modal.classList.remove('expanded');
                const icon = document.querySelector('#toggle-expand-edit-message i');
                if (icon) {
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                }
                currentEditingMessageId = null;
            }

            // 绑定编辑弹窗事件
            document.getElementById('save-edit-message').addEventListener('click', () => {
                const newContent = document.getElementById('edit-message-textarea').value;
                saveEditMessage(currentEditingMessageId, newContent);
            });

            document.getElementById('cancel-edit-message').addEventListener('click', cancelEditMessage);
            document.getElementById('close-edit-message').addEventListener('click', cancelEditMessage);

            // 扩大/缩小编辑弹窗
            document.getElementById('toggle-expand-edit-message').addEventListener('click', () => {
                const modal = document.getElementById('message-edit-modal');
                const icon = document.querySelector('#toggle-expand-edit-message i');

                if (modal.classList.contains('expanded')) {
                    modal.classList.remove('expanded');
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                } else {
                    modal.classList.add('expanded');
                    icon.classList.remove('fa-expand');
                    icon.classList.add('fa-compress');
                }
            });

            // 点击弹窗外部关闭
            document.getElementById('message-edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'message-edit-modal') {
                    cancelEditMessage();
                }
            });

            async function regenerateMessage(id) {
                const messageIndex = chatHistory.findIndex(m => m.id === id);
                if (messageIndex > -1 && chatHistory[messageIndex].role === 'assistant') {
                    // Temporarily remove the message and any subsequent messages for the API call
                    chatHistory.splice(messageIndex);
                    // Re-render the UI to reflect this
                    const messagesToRemove = Array.from(chatMessages.children).slice(messageIndex);
                    messagesToRemove.forEach(el => el.remove());
                    // Send the shortened history to the API
                    await sendApiRequest();
                }
            }

            // 导出函数到全局作用域
            window.startEditMessage = startEditMessage;
            window.saveEditMessage = saveEditMessage;
            window.cancelEditMessage = cancelEditMessage;
            
            async function constructFinalPrompt() {
                const character = char.activeCharacterId ? char.data[char.activeCharacterId] : null;
                const currentPresetName = document.querySelector('.preset-item.active')?.dataset.name || '默认';
                const presets = await getPresets();
                const preset = presets[currentPresetName] || presets['默认'];

                // 获取当前用户设置
                const currentUser = userManagement.getCurrentUser();

                let messages = [];
                let systemPromptParts = [];

                // 1. 添加用户的系统提示词（如果有）
                if (currentUser?.systemPrompt) {
                    systemPromptParts.push(currentUser.systemPrompt);
                }

                // 2. 收集预设中的系统提示词
                if (preset?.prompts) {
                    preset.prompts.forEach(prompt => {
                        if (prompt.enabled && prompt.role === 'system') {
                            if (prompt.identifier === 'main' && prompt.content) {
                                systemPromptParts.push(prompt.content);
                            } else if (prompt.identifier === 'personaDescription') {
                                // 使用当前用户的描述
                                if (currentUser?.description) {
                                    systemPromptParts.push(`User: ${currentUser.name}\n${currentUser.description}`);
                                }
                            } else if (prompt.identifier === 'charDescription' && character) {
                                systemPromptParts.push(`Character: ${character.name}\n${character.description || ''}`);
                            } else if (prompt.identifier === 'charPersonality' && character?.personality) {
                                systemPromptParts.push(`Personality: ${character.personality}`);
                            } else if (prompt.identifier === 'scenario' && character?.scenario) {
                                systemPromptParts.push(`Scenario: ${character.scenario}`);
                            } else if (prompt.content && !prompt.marker) {
                                systemPromptParts.push(prompt.content);
                            }
                        }
                    });
                }

                // 3. 添加角色基本信息（如果预设中没有）
                if (character && systemPromptParts.length === 0) {
                    systemPromptParts.push(`You are ${character.name}. ${character.description || ''}`);
                }

                // 4. 收集并应用世界书条目
                let worldInfoContent = [];

                // 收集全局世界书
                const selectedWorld = wi.worldSelect?.value;
                if (selectedWorld && selectedWorld !== 'char_book' && wi.data[selectedWorld]) {
                    const worldEntries = wi.data[selectedWorld];
                    worldEntries.forEach(entry => {
                        if (entry.enabled) {
                            // 检查关键词匹配
                            const keys = Array.isArray(entry.keys) ? entry.keys : (entry.keys || '').split(',').map(k => k.trim());
                            let shouldInclude = entry.constant || false; // constant 条目总是包含

                            if (!shouldInclude) {
                                // 检查是否有关键词在聊天历史中（跳过隐藏的消息）
                                const recentMessages = chatHistory.filter(m => !m.hidden).slice(-10).map(m => m.content).join(' ');
                                const allContext = systemPromptParts.join(' ') + ' ' + recentMessages;

                                for (const key of keys) {
                                    if (key && allContext.toLowerCase().includes(key.toLowerCase())) {
                                        shouldInclude = true;
                                        break;
                                    }
                                }
                            }

                            if (shouldInclude && entry.content) {
                                worldInfoContent.push(entry.content);
                            }
                        }
                    });
                }

                // 收集角色世界书
                console.log('[世界书] 检查角色世界书:', {
                    hasCharacter: !!character,
                    hasCharacterBook: !!character?.data?.character_book,
                    hasEntries: !!character?.data?.character_book?.entries,
                    entriesCount: character?.data?.character_book?.entries?.length || 0
                });

                if (character?.data?.character_book?.entries) {
                    console.log('[世界书] 角色世界书条目:', character.data.character_book.entries);

                    character.data.character_book.entries.forEach((entry, index) => {
                        console.log(`[世界书] 处理条目 ${index}:`, {
                            enabled: entry.enabled,
                            constant: entry.constant,
                            keys: entry.keys,
                            contentPreview: entry.content?.substring(0, 50)
                        });

                        if (entry.enabled !== false) {
                            const keys = Array.isArray(entry.keys) ? entry.keys : (entry.keys || '').split(',').map(k => k.trim());
                            let shouldInclude = entry.constant || false;

                            if (!shouldInclude) {
                                // 检查是否有关键词在聊天历史中（跳过隐藏的消息）
                                const recentMessages = chatHistory.filter(m => !m.hidden).slice(-10).map(m => m.content).join(' ');
                                const allContext = systemPromptParts.join(' ') + ' ' + recentMessages;

                                for (const key of keys) {
                                    if (key && allContext.toLowerCase().includes(key.toLowerCase())) {
                                        console.log(`[世界书] 条目 ${index} 匹配关键词: ${key}`);
                                        shouldInclude = true;
                                        break;
                                    }
                                }
                            }

                            if (shouldInclude && entry.content) {
                                console.log(`[世界书] 添加条目 ${index} 到提示词`);
                                worldInfoContent.push(entry.content);
                            } else {
                                console.log(`[世界书] 跳过条目 ${index} (shouldInclude: ${shouldInclude}, hasContent: ${!!entry.content})`);
                            }
                        }
                    });
                }

                // 5. 组合系统提示词
                if (worldInfoContent.length > 0) {
                    console.log('[世界书] 添加到系统提示词，总计条目数:', worldInfoContent.length);
                    systemPromptParts.push('\nWorld Information:\n' + worldInfoContent.join('\n'));
                } else {
                    console.log('[世界书] 没有世界书条目被添加');
                }

                if (systemPromptParts.length > 0) {
                    messages.push({ role: 'system', content: systemPromptParts.join('\n\n') });
                }

                // 6. 如果用户设置了自动发送用户描述，在第一条消息时发送
                if (currentUser?.autoAnnounce && chatHistory.length === 0 && currentUser.description) {
                    messages.push({ role: 'user', content: `我是${currentUser.name}。${currentUser.description}` });
                }

                // 7. 添加第一条消息（如果是新对话）
                if (chatHistory.length === 1 && character?.first_mes && chatHistory[0].role === 'assistant') {
                    // 第一条消息已经在聊天历史中
                } else if (chatHistory.length === 0 && character?.first_mes) {
                    messages.push({ role: 'assistant', content: character.first_mes });
                }

                // 8. 添加聊天历史（应用正则替换，跳过隐藏的消息）
                chatHistory.forEach(msg => {
                    // 跳过隐藏的消息
                    if (msg.hidden) return;

                    // 处理图片消息 - 使用描述文字替代图片（不发送base64数据）
                    if (msg.type === 'image') {
                        messages.push({
                            role: msg.role,
                            content: msg.description || '[图片内容]'
                        });
                    } else {
                        // 文本消息
                        let processedContent = msg.content;

                        // 应用正则表达式
                        if (msg.role === 'user') {
                            // 对用户输入应用正则
                            processedContent = applyRegex(processedContent);
                        }

                        messages.push({
                            role: msg.role,
                            content: processedContent
                        });
                    }
                });

                // 9. 保存构建的提示词供查看
                window.lastConstructedPrompt = messages;
                updatePromptPreview(messages);

                return messages;
            }

            async function sendApiRequest() {
                const apiConfig = getCurrentApiConfig();
                if (!apiConfig?.url || !apiConfig?.key || !apiConfig.model) {
                    addMessageToHistory({role: 'assistant', content: '错误: API 设置不完整。请在API设置中配置 URL, Key, 和模型。', type: 'text'});
                    return;
                }

                const messages = await constructFinalPrompt();
                if (messages.length === 0) return;

                sendButton.disabled = true;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const urlObj = new URL(apiConfig.url);
                    let endpoint = `${apiConfig.url.replace(/\/$/, '')}/chat/completions`;
                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    };

                    // 获取当前预设参数
                    const currentPreset = document.querySelector('.preset-item.active')?.dataset.name;
                    const presets = getPresets();
                    const preset = presets[currentPreset] || presets['默认'];

                    let body = {
                        model: apiConfig.model,
                        messages: messages,
                        stream: apiConfig.streaming || false,
                        temperature: preset?.temp || 0.7,
                        top_p: preset?.top_p || 1,
                        frequency_penalty: preset?.freq_pen || 0,
                        presence_penalty: preset?.pres_pen || 0,
                        max_tokens: preset?.max_tokens || 1024,
                    };

                    if(urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${apiConfig.model}:generateContent?key=${apiConfig.key}`;
                        delete headers.Authorization;

                        // 添加系统消息到第一条用户消息
                        const systemMessage = messages.find(m => m.role === 'system');
                        const userMessages = messages.filter(m => m.role !== 'system');

                        if (systemMessage && userMessages.length > 0) {
                            userMessages[0].content = systemMessage.content + '\n\n' + userMessages[0].content;
                        }

                        body = {
                            contents: userMessages.map(m => ({
                                role: m.role === 'assistant' ? 'model' : 'user',
                                parts: [{ text: m.content }]
                            })),
                            generationConfig: {
                                temperature: preset?.temp || 0.7,
                                topP: preset?.top_p || 1,
                                maxOutputTokens: preset?.max_tokens || 1024,
                            }
                        };
                    }

                    // 处理流式响应
                    if (apiConfig.streaming && !urlObj.hostname.includes('google')) {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error?.message || `HTTP Error ${response.status}`);
                        }

                        // 创建AI消息并获取其ID
                        const messageId = `msg_${Date.now()}`;
                        const aiMessage = { id: messageId, role: 'assistant', content: '', type: 'text' };
                        chatHistory.push(aiMessage);

                        // 渲染初始的空消息
                        renderMessage(aiMessage);
                        const messageElement = document.getElementById(messageId);
                        const contentDiv = messageElement.querySelector('.chat-bubble .message-content');
                        if (contentDiv) {
                            contentDiv.className = 'message-content text-left whitespace-pre-wrap';
                        }

                        // 处理流式数据
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullContent = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n').filter(line => line.trim() !== '');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') continue;

                                    try {
                                        const json = JSON.parse(data);
                                        const delta = json.choices?.[0]?.delta?.content;
                                        if (delta) {
                                            fullContent += delta;
                                            contentDiv.textContent = fullContent;
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    } catch (e) {
                                        // 忽略解析错误
                                    }
                                }
                            }
                        }

                        // 更新历史记录中的内容
                        aiMessage.content = fullContent;

                        // 流式渲染完成后,重新渲染消息以应用regex和HTML处理
                        if (messageElement) {
                            // 移除旧的消息元素
                            messageElement.remove();
                            // 重新渲染应用regex后的消息
                            renderMessage(aiMessage);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }

                    } else {
                        // 非流式响应
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error?.message || `HTTP Error ${response.status}`);
                        }

                        const data = await response.json();
                        let aiContent = '';
                        if (data.choices) { // OpenAI format
                           aiContent = data.choices[0].message.content;
                        } else if (data.candidates) { // Gemini format
                           aiContent = data.candidates[0].content.parts[0].text;
                        }
                        addMessageToHistory({role: 'assistant', content: aiContent, type: 'text'});
                    }

                } catch (error) {
                    addMessageToHistory({role: 'assistant', content: `API Error: ${error.message}`, type: 'text'});
                    console.error("API Error:", error);
                } finally {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }
            
            async function sendMessage() {
                const userInput = chatInput.value.trim();
                if (!userInput) return;
                
                if (!char.activeCharacterId) {
                    alert('请先选择一个角色!');
                    return;
                }
                
                addMessageToHistory({role: 'user', content: userInput, type: 'text', replyTo: currentReply});
                currentReply = null;
                document.getElementById('reply-status-container').innerHTML = '';
                
                chatInput.value = '';
                chatInput.style.height = 'auto'; // Reset height
                
                await sendApiRequest();
            }

            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
            });
            
            window.regenerateMessage = regenerateMessage;
            window.deleteMessage = deleteMessage;
            window.showImagePreview = (src) => {
                 const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.inset = 0;
                modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '200';
                modal.innerHTML = `<img src="${src}" style="max-width: 90%; max-height: 90%;">`;
                modal.onclick = () => document.body.removeChild(modal);
                document.body.appendChild(modal);
            }

            // --- Chat Menu Logic ---
            const chatMenuBtn = document.getElementById('chat-menu-btn');
            const chatMenuPanel = document.getElementById('chat-menu-panel');
            const menuImageBtn = document.getElementById('menu-image-btn');
            const menuViewPromptBtn = document.getElementById('menu-view-prompt-btn');
            const menuNewChatBtn = document.getElementById('menu-new-chat-btn');
            const imageFileInput = document.getElementById('imageFileInput');

            // 切换菜单显示
            chatMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                chatMenuPanel.classList.toggle('hidden');
            });

            // 点击外部关闭菜单
            document.addEventListener('click', (e) => {
                if (!chatMenuPanel.contains(e.target) && e.target !== chatMenuBtn) {
                    chatMenuPanel.classList.add('hidden');
                }
            });

            // 查看提示词
            menuViewPromptBtn.addEventListener('click', () => {
                showPromptPreview();
                chatMenuPanel.classList.add('hidden');
            });

            // 新对话
            menuNewChatBtn.addEventListener('click', async () => {
                if (confirm('确定要开始新对话吗？当前聊天记录将被清除。')) {
                    console.log('[新对话] 开始清空聊天记录...');

                    // 先保存当前聊天记录
                    if (char.activeCharacterId && chatHistory.length > 0) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        console.log('[新对话] 已保存旧的聊天记录');
                    }

                    // 清空聊天并重新开始
                    startNewChat();
                    console.log('[新对话] 聊天已清空，已添加开场白');

                    // 立即保存新的空聊天记录
                    if (char.activeCharacterId) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        console.log('[新对话] 已保存新的聊天记录');
                    }
                }
                chatMenuPanel.classList.add('hidden');
            });

            // 发送图片
            menuImageBtn.addEventListener('click', () => {
                imageFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            imageFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageDataUrl = event.target.result;

                        // 先添加图片消息到历史(显示加载状态，保留原图用于显示)
                        const tempMessage = {
                            role: 'user',
                            content: '[图片]',
                            type: 'image',
                            imageUrl: imageDataUrl, // 保留原图URL用于前端显示
                            description: '正在识别图片...'
                        };
                        addMessageToHistory(tempMessage);

                        // 调用识图API获取描述
                        try {
                            console.log('[图片识别] 开始调用识图API...');
                            const description = await analyzeImage(imageDataUrl);
                            console.log('[图片识别] API返回成功:', description);

                            // 更新消息：只保存描述和显示用的缩略图，删除大体积的原始base64
                            const lastMsg = chatHistory[chatHistory.length - 1];
                            if (!lastMsg) {
                                console.error('[图片识别] 无法找到最后一条消息');
                                return;
                            }

                            lastMsg.description = description;
                            lastMsg.content = `[图片] ${description}`; // 内容直接改为描述
                            // imageUrl保留用于显示，但我们将创建缩略图版本
                            console.log('[图片识别] 开始创建缩略图...');
                            lastMsg.imageUrl = await createThumbnail(imageDataUrl, 300, 300);
                            console.log('[图片识别] 缩略图创建完成');

                            await saveChat();

                            // 重新渲染这条消息
                            console.log('[图片识别] 重新渲染消息...');
                            const messageElement = document.getElementById(lastMsg.id);
                            if (messageElement) {
                                messageElement.remove();
                            }
                            renderMessage(lastMsg);
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            console.log('[图片识别] 完整流程成功');
                        } catch (error) {
                            console.error('[图片识别] 失败:', error);
                            console.error('[图片识别] 错误详情:', error.message, error.stack);

                            const lastMsg = chatHistory[chatHistory.length - 1];
                            if (lastMsg) {
                                lastMsg.description = `图片识别失败: ${error.message || '未知错误'}`;
                                lastMsg.content = `图片识别失败: ${error.message || '未知错误'}`;
                                lastMsg.imageUrl = await createThumbnail(imageDataUrl, 300, 300);
                                await saveChat();

                                // 重新渲染这条消息
                                const messageElement = document.getElementById(lastMsg.id);
                                if (messageElement) {
                                    messageElement.remove();
                                }
                                renderMessage(lastMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; // 重置input以便可以重复选择同一文件
            });

            // 创建缩略图函数 - 压缩图片以减少存储空间
            async function createThumbnail(imageDataUrl, maxWidth = 300, maxHeight = 300) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // 计算缩放比例
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // 使用较低质量压缩，进一步减小体积
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = imageDataUrl;
                });
            }

            // 图片识别函数 - 带重试和详细日志
            async function analyzeImage(imageDataUrl, retryCount = 0) {
                const MAX_RETRIES = 2;
                console.log('[analyzeImage] 函数开始执行，重试次数:', retryCount);
                const apiConfig = getCurrentApiConfig();
                console.log('[analyzeImage] 当前API配置:', apiConfig);

                // 检查识图API配置
                if (!apiConfig?.visionUrl || !apiConfig?.visionKey || !apiConfig?.visionModel) {
                    const missingFields = [];
                    if (!apiConfig?.visionUrl) missingFields.push('识图API URL');
                    if (!apiConfig?.visionKey) missingFields.push('识图API Key');
                    if (!apiConfig?.visionModel) missingFields.push('识图模型');
                    throw new Error(`识图API配置不完整，缺少: ${missingFields.join(', ')}。\n\n请在侧边栏"API设置"中配置识图API。`);
                }

                const endpoint = `${apiConfig.visionUrl.replace(/\/$/, '')}/chat/completions`;
                console.log('[analyzeImage] 请求端点:', endpoint);
                console.log('[analyzeImage] 原始图片数据长度:', imageDataUrl.length);

                // 如果图片太大，先压缩（某些API对base64大小有限制）
                let processedImageUrl = imageDataUrl;
                if (imageDataUrl.length > 1024 * 1024) { // 如果超过1MB
                    console.log('[analyzeImage] 图片过大，先压缩...');
                    processedImageUrl = await createThumbnail(imageDataUrl, 800, 800);
                    console.log('[analyzeImage] 压缩后图片数据长度:', processedImageUrl.length);
                }

                const requestBody = {
                    model: apiConfig.visionModel,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: `Act as a professional image analyst. Your task is to write an exceptionally detailed visual description report for an image, avoiding all generalizations. Your description must be strictly based on the image's visual content, covering its subject, background, composition, lighting, and textures.

Ensure the final description is detailed, specific, and **at least 200 words long**.

You must structure your entire output strictly in the following format, without any additional introductory or concluding remarks:

【图片信息】
[Your detailed description here]`
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: processedImageUrl
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                };

                console.log('[analyzeImage] 请求体结构:', {
                    model: requestBody.model,
                    messagesCount: requestBody.messages.length,
                    contentCount: requestBody.messages[0].content.length,
                    imageUrlLength: processedImageUrl.length
                });

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.visionKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('[analyzeImage] 响应状态:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[analyzeImage] API错误响应:', errorText);
                        let errorMsg = `HTTP ${response.status}`;
                        let shouldRetry = false;

                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg = errorJson.error?.message || errorJson.message || errorMsg;
                            console.error('[analyzeImage] 解析后的错误:', errorJson);

                            // 检查是否应该重试
                            if (response.status === 503 || response.status === 429 ||
                                (response.status === 500 && errorMsg.includes('overloaded'))) {
                                shouldRetry = true;
                            }
                        } catch (e) {
                            errorMsg += ': ' + errorText.substring(0, 200);
                        }

                        // 如果是500错误且包含特定信息，说明API不支持
                        if (response.status === 500 && errorText.includes('map')) {
                            errorMsg = '该API服务不支持视觉识别功能。\n\n建议：\n1. 使用支持视觉的API（如 OpenAI gpt-4o）\n2. 或者不配置识图API（图片仍可发送，但无AI描述）';
                            throw new Error(errorMsg);
                        }

                        // 重试逻辑
                        if (shouldRetry && retryCount < MAX_RETRIES) {
                            const delay = (retryCount + 1) * 2000; // 2秒、4秒
                            console.log(`[analyzeImage] 将在${delay}ms后重试...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return analyzeImage(imageDataUrl, retryCount + 1);
                        }

                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    console.log('[analyzeImage] API响应数据:', data);

                    const content = data.choices?.[0]?.message?.content;
                    if (!content) {
                        console.error('[analyzeImage] 无效的响应格式，完整数据:', JSON.stringify(data, null, 2));
                        throw new Error('API返回数据格式错误，未找到content字段');
                    }

                    return content;
                } catch (error) {
                    console.error('[analyzeImage] 请求异常:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('网络请求失败，请检查API URL是否正确');
                    }
                    throw error;
                }
            }

            // 图片预览功能
            function showImagePreview(imageSrc) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    cursor: pointer;
                    padding: 20px;
                `;

                const img = document.createElement('img');
                img.src = imageSrc;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                `;

                modal.appendChild(img);
                document.body.appendChild(modal);

                // 点击关闭
                modal.addEventListener('click', () => {
                    modal.remove();
                });

                // ESC键关闭
                const closeOnEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', closeOnEsc);
                    }
                };
                document.addEventListener('keydown', closeOnEsc);
            }

            // 导出配置
            const menuExportConfigBtn = document.getElementById('menu-export-config-btn');
            menuExportConfigBtn.addEventListener('click', async () => {
                try {
                    console.log('开始导出配置...');

                    // 收集所有配置数据
                    const config = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        api: {
                            apiUrl: await idbStorage.getItem('api_url_v2') || '',
                            apiKey: await idbStorage.getItem('api_key_v2') || '',
                            model: await idbStorage.getItem('api_model_v2') || '',
                            visionUrl: await idbStorage.getItem('vision_url_v2') || '',
                            visionKey: await idbStorage.getItem('vision_key_v2') || '',
                            visionModel: await idbStorage.getItem('vision_model_v2') || ''
                        },
                        characters: char.data || {},
                        worldInfo: wi.data || {},
                        regex: regex.data || {},
                        presets: await getPresets() || {},
                        users: userManagement.users || {},
                        currentUserId: userManagement.currentUserId || null,
                        theme: {
                            primaryColor: await idbStorage.getItem('primary_color') || '',
                            customCSS: await idbStorage.getItem('custom_css') || ''
                        },
                        chatHistories: {}
                    };

                    console.log('配置数据已收集');

                    // 导出所有角色的聊天记录
                    if (char.data && typeof char.data === 'object') {
                        for (const charId of Object.keys(char.data)) {
                            const history = await idbStorage.getItem(`chat_history_${charId}`);
                            if (history) {
                                try {
                                    config.chatHistories[charId] = JSON.parse(history);
                                } catch (e) {
                                    console.warn(`无法解析角色 ${charId} 的聊天记录:`, e);
                                }
                            }
                        }
                    }

                    console.log('聊天记录已收集');

                    // 创建下载链接
                    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat-config-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();

                    // 延迟移除和释放URL,确保下载开始
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);

                    console.log('配置已导出成功');
                    alert('配置已导出成功！');
                } catch (error) {
                    console.error('导出配置失败:', error);
                    alert('导出配置失败: ' + error.message);
                } finally {
                    chatMenuPanel.classList.add('hidden');
                }
            });

            // 导入配置
            const menuImportConfigBtn = document.getElementById('menu-import-config-btn');
            const configFileInput = document.getElementById('config-file-input');

            menuImportConfigBtn.addEventListener('click', () => {
                configFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            configFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const config = JSON.parse(event.target.result);

                            if (!confirm('确定要导入配置吗？这将覆盖当前的所有设置、角色和聊天记录！')) {
                                return;
                            }

                            // 导入API设置
                            if (config.api) {
                                if (config.api.apiUrl) await idbStorage.setItem('api_url_v2', config.api.apiUrl);
                                if (config.api.apiKey) await idbStorage.setItem('api_key_v2', config.api.apiKey);
                                if (config.api.model) await idbStorage.setItem('api_model_v2', config.api.model);
                                if (config.api.visionUrl) await idbStorage.setItem('vision_url_v2', config.api.visionUrl);
                                if (config.api.visionKey) await idbStorage.setItem('vision_key_v2', config.api.visionKey);
                                if (config.api.visionModel) await idbStorage.setItem('vision_model_v2', config.api.visionModel);
                            }

                            // 导入角色数据
                            if (config.characters) {
                                char.data = config.characters;
                                await saveCharacters();
                            }

                            // 导入世界书
                            if (config.worldInfo) {
                                wi.data = config.worldInfo;
                                await saveWiData(wi.data);
                            }

                            // 导入正则表达式
                            if (config.regex) {
                                regex.data = config.regex;
                                await saveRegexData();
                            }

                            // 导入预设
                            if (config.presets) {
                                presets.data = config.presets;
                                await savePresets();
                            }

                            // 导入用户数据（兼容新旧格式）
                            if (config.users) {
                                userManagement.users = config.users;
                                if (config.currentUserId) {
                                    userManagement.currentUserId = config.currentUserId;
                                }
                                await userManagement.saveUsers();
                                userManagement.updateCurrentUserDisplay();
                            } else if (config.user) {
                                // 兼容旧格式
                                userManagement.users = config.user;
                                await userManagement.saveUsers();
                            }

                            // 导入主题设置
                            if (config.theme) {
                                if (config.theme.primaryColor) {
                                    await idbStorage.setItem('primary_color', config.theme.primaryColor);
                                }
                                if (config.theme.customCSS) {
                                    await idbStorage.setItem('custom_css', config.theme.customCSS);
                                }
                            }

                            // 导入聊天记录
                            if (config.chatHistories) {
                                for (const charId of Object.keys(config.chatHistories)) {
                                    await idbStorage.setItem(`chat_history_${charId}`, JSON.stringify(config.chatHistories[charId]));
                                }
                            }

                            alert('配置导入成功！页面将刷新以应用新配置。');
                            location.reload();
                        } catch (error) {
                            console.error('导入配置失败:', error);
                            alert('导入配置失败: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });

            // 导出聊天记录
            const menuExportChatBtn = document.getElementById('menu-export-chat-btn');
            menuExportChatBtn.addEventListener('click', () => {
                if (!char.activeCharacterId) {
                    alert('请先选择一个角色！');
                    return;
                }

                if (chatHistory.length === 0) {
                    alert('当前没有聊天记录！');
                    return;
                }

                try {
                    const character = char.data[char.activeCharacterId];
                    const chatData = {
                        characterName: character.name,
                        exportDate: new Date().toISOString(),
                        messages: chatHistory
                    };

                    const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat-${character.name}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert('聊天记录已导出成功！');
                } catch (error) {
                    console.error('导出聊天记录失败:', error);
                    alert('导出聊天记录失败: ' + error.message);
                }
                chatMenuPanel.classList.add('hidden');
            });

            // 导入聊天记录
            const menuImportChatBtn = document.getElementById('menu-import-chat-btn');
            const chatFileInput = document.getElementById('chat-file-input');

            menuImportChatBtn.addEventListener('click', () => {
                if (!char.activeCharacterId) {
                    alert('请先选择一个角色！');
                    return;
                }
                chatFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            chatFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const chatData = JSON.parse(event.target.result);

                            if (!chatData.messages || !Array.isArray(chatData.messages)) {
                                alert('无效的聊天记录文件格式！');
                                return;
                            }

                            if (!confirm(`确定要导入聊天记录吗？当前聊天记录将被替换。\n\n角色名称: ${chatData.characterName || '未知'}\n导出日期: ${chatData.exportDate ? new Date(chatData.exportDate).toLocaleString() : '未知'}\n消息数量: ${chatData.messages.length}`)) {
                                return;
                            }

                            // 替换当前聊天记录
                            chatHistory = chatData.messages;

                            // 保存到IndexedDB
                            if (char.activeCharacterId) {
                                await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                            }

                            // 重新渲染聊天界面
                            chatMessages.innerHTML = '';
                            document.querySelectorAll('style[id^="style-"]').forEach(style => {
                                style.remove();
                            });
                            chatHistory.forEach(message => {
                                renderMessage(message);
                            });
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            alert('聊天记录导入成功！');
                        } catch (error) {
                            console.error('导入聊天记录失败:', error);
                            alert('导入聊天记录失败: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });


            // --- User Management Logic ---
            const userManagement = {
                users: {},
                currentUserId: null,

                async init() {
                    await this.loadUsers();
                    this.bindEvents();
                    this.renderUserList();
                },

                async loadUsers() {
                    const usersData = await idbStorage.getItem('user_profiles_v1');
                    this.users = usersData ? JSON.parse(usersData) : {};
                    this.currentUserId = await idbStorage.getItem('current_user_id_v1');

                    // 创建默认用户如果没有
                    if (Object.keys(this.users).length === 0) {
                        const defaultUserId = 'user_default';
                        this.users[defaultUserId] = {
                            id: defaultUserId,
                            name: '默认用户',
                            avatar: 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=U',
                            status: '在线',
                            description: '',
                            systemPrompt: '',
                            autoAnnounce: false,
                            showTyping: true
                        };
                        this.currentUserId = defaultUserId;
                        await this.saveUsers();
                    }

                    if (!this.currentUserId || !this.users[this.currentUserId]) {
                        this.currentUserId = Object.keys(this.users)[0];
                    }

                    this.updateCurrentUserDisplay();
                    this.updateUserPreviewCard();
                },

                async saveUsers() {
                    await idbStorage.setItem('user_profiles_v1', JSON.stringify(this.users));
                    await idbStorage.setItem('current_user_id_v1', this.currentUserId);
                },

                renderUserList() {
                    const userList = document.getElementById('user-list');
                    if (!userList) return;

                    userList.innerHTML = '';

                    Object.values(this.users).forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'user-item p-3 rounded-lg cursor-pointer border-2 transition-all';
                        item.dataset.userId = user.id;

                        if (user.id === this.currentUserId) {
                            item.className += ' border-primary-color bg-primary-color bg-opacity-10';
                        } else {
                            item.className += ' border-gray-200 hover:border-primary-color hover:bg-gray-50';
                        }

                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${user.avatar || 'https://placehold.co/40x40/E4E6EB/1A1A1D?text=U'}"
                                     class="w-12 h-12 rounded-full object-cover border-2 ${user.id === this.currentUserId ? 'border-primary-color' : 'border-gray-300'}">
                                <div class="flex-1">
                                    <p class="font-bold text-base">${user.name}</p>
                                    <p class="text-xs text-gray-500">${user.status || '离线'}</p>
                                </div>
                                ${user.id === this.currentUserId ? '<i class="fas fa-check-circle text-primary-color text-xl"></i>' : ''}
                            </div>
                        `;

                        item.addEventListener('click', () => {
                            this.useUser(user.id);
                            this.selectUser(user.id);  // 自动进入编辑状态
                            this.closeUserSelector();
                        });
                        userList.appendChild(item);
                    });
                },

                openUserSelector() {
                    const modal = document.getElementById('user-selector-modal');
                    if (modal) {
                        this.renderUserList();
                        modal.classList.add('active');
                    }
                },

                closeUserSelector() {
                    const modal = document.getElementById('user-selector-modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                },

                updateUserPreviewCard() {
                    const user = this.users[this.currentUserId];
                    if (!user) return;

                    const avatarEl = document.getElementById('current-user-avatar-preview');
                    const nameEl = document.getElementById('current-user-name-preview');
                    const statusEl = document.getElementById('current-user-status-preview');

                    if (avatarEl) avatarEl.src = user.avatar || 'https://placehold.co/48x48/E4E6EB/1A1A1D?text=U';
                    if (nameEl) nameEl.textContent = user.name || '未命名用户';
                    if (statusEl) statusEl.textContent = user.status || '离线';
                },

                selectUser(userId) {
                    const user = this.users[userId];
                    if (!user) return;

                    // 显示编辑器
                    document.getElementById('user-editor-placeholder').classList.add('hidden');
                    document.getElementById('user-editor-content').classList.remove('hidden');

                    // 填充表单
                    document.getElementById('user-editing-id').value = user.id;
                    document.getElementById('user-editor-avatar').src = user.avatar || 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=U';
                    document.getElementById('user-editor-name').value = user.name || '';
                    document.getElementById('user-editor-status').value = user.status || '';
                    document.getElementById('user-editor-description').value = user.description || '';
                    document.getElementById('user-editor-system-prompt').value = user.systemPrompt || '';
                    document.getElementById('user-auto-announce').checked = user.autoAnnounce || false;
                    document.getElementById('user-show-typing').checked = user.showTyping !== false;
                },

                createNewUser() {
                    const newUserId = `user_${Date.now()}`;
                    const newUser = {
                        id: newUserId,
                        name: '新用户',
                        avatar: 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=NEW',
                        status: '在线',
                        description: '',
                        systemPrompt: '',
                        autoAnnounce: false,
                        showTyping: true
                    };

                    this.users[newUserId] = newUser;
                    this.saveUsers();
                    this.renderUserList();
                    this.selectUser(newUserId);
                },

                saveCurrentUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    const user = this.users[userId];
                    user.name = document.getElementById('user-editor-name').value;
                    user.status = document.getElementById('user-editor-status').value;
                    user.description = document.getElementById('user-editor-description').value;
                    user.systemPrompt = document.getElementById('user-editor-system-prompt').value;
                    user.autoAnnounce = document.getElementById('user-auto-announce').checked;
                    user.showTyping = document.getElementById('user-show-typing').checked;

                    this.saveUsers();
                    this.renderUserList();

                    if (userId === this.currentUserId) {
                        this.updateCurrentUserDisplay();
                        this.updateUserPreviewCard();
                    }

                    alert(`用户 "${user.name}" 已保存！`);
                },

                useUser(userId) {
                    if (!userId) {
                        userId = document.getElementById('user-editing-id').value;
                    }

                    if (!this.users[userId]) return;

                    this.currentUserId = userId;
                    this.saveUsers();
                    this.updateCurrentUserDisplay();
                    this.updateUserPreviewCard();
                    this.renderUserList();

                    alert(`已切换到用户 "${this.users[userId].name}"`);
                },

                duplicateUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    const originalUser = this.users[userId];
                    const newUserId = `user_${Date.now()}`;
                    const newUser = {
                        ...originalUser,
                        id: newUserId,
                        name: `${originalUser.name} (复制)`
                    };

                    this.users[newUserId] = newUser;
                    this.saveUsers();
                    this.renderUserList();
                    this.selectUser(newUserId);
                },

                deleteUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    if (userId === 'user_default') {
                        alert('不能删除默认用户！');
                        return;
                    }

                    if (!confirm(`确定要删除用户 "${this.users[userId].name}" 吗？`)) return;

                    delete this.users[userId];

                    // 如果删除的是当前用户，切换到默认用户
                    if (userId === this.currentUserId) {
                        this.currentUserId = Object.keys(this.users)[0];
                        this.updateCurrentUserDisplay();
                    }

                    this.saveUsers();
                    this.renderUserList();

                    // 隐藏编辑器
                    document.getElementById('user-editor-placeholder').classList.remove('hidden');
                    document.getElementById('user-editor-content').classList.add('hidden');
                },

                uploadAvatar(file) {
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const avatar = e.target.result;
                        document.getElementById('user-editor-avatar').src = avatar;

                        const userId = document.getElementById('user-editing-id').value;
                        if (userId && this.users[userId]) {
                            this.users[userId].avatar = avatar;
                        }
                    };
                    reader.readAsDataURL(file);
                },

                updateCurrentUserDisplay() {
                    const user = this.users[this.currentUserId];
                    if (!user) return;

                    // 更新聊天界面的用户头像
                    const userAvatars = document.querySelectorAll('.chat-message-group.justify-end img');
                    userAvatars.forEach(img => {
                        if (user.avatar) {
                            img.src = user.avatar;
                        }
                    });
                },

                uploadAvatar(file) {
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const avatar = e.target.result;
                        document.getElementById('user-editor-avatar').src = avatar;

                        const userId = document.getElementById('user-editing-id').value;
                        if (userId && this.users[userId]) {
                            this.users[userId].avatar = avatar;

                            if (userId === this.currentUserId) {
                                this.updateUserPreviewCard();
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                },

                getCurrentUser() {
                    return this.users[this.currentUserId];
                },

                bindEvents() {
                    // 打开用户选择器
                    const openSelectorBtn = document.getElementById('open-user-selector-btn');
                    const previewCard = document.getElementById('user-preview-card');

                    if (openSelectorBtn) {
                        openSelectorBtn.addEventListener('click', () => this.openUserSelector());
                    }

                    if (previewCard) {
                        previewCard.addEventListener('click', () => this.openUserSelector());
                    }

                    // 关闭用户选择器
                    const closeSelectorBtns = document.querySelectorAll('.close-user-selector-btn');
                    closeSelectorBtns.forEach(btn => {
                        btn.addEventListener('click', () => this.closeUserSelector());
                    });

                    // 点击弹窗外部关闭
                    const selectorModal = document.getElementById('user-selector-modal');
                    if (selectorModal) {
                        selectorModal.addEventListener('click', (e) => {
                            if (e.target === selectorModal) {
                                this.closeUserSelector();
                            }
                        });
                    }

                    // 其他按钮事件
                    const userNewBtn = document.getElementById('user-new-btn');
                    const userSaveBtn = document.getElementById('user-save-btn');
                    const userUseBtn = document.getElementById('user-use-btn');
                    const userDuplicateBtn = document.getElementById('user-duplicate-btn');
                    const userDeleteBtn = document.getElementById('user-delete-btn');
                    const userAvatarUpload = document.getElementById('user-avatar-upload');

                    if (userNewBtn) userNewBtn.addEventListener('click', () => this.createNewUser());
                    if (userSaveBtn) userSaveBtn.addEventListener('click', () => this.saveCurrentUser());
                    if (userUseBtn) userUseBtn.addEventListener('click', () => this.useUser());
                    if (userDuplicateBtn) userDuplicateBtn.addEventListener('click', () => this.duplicateUser());
                    if (userDeleteBtn) userDeleteBtn.addEventListener('click', () => this.deleteUser());

                    if (userAvatarUpload) {
                        userAvatarUpload.addEventListener('change', (e) => {
                            this.uploadAvatar(e.target.files[0]);
                        });
                    }

                    // Language selector event listener
                    const languageSelect = document.getElementById('language-select');
                    if (languageSelect) {
                        // Initialize language selector value from i18n.currentLang
                        languageSelect.value = i18n.currentLang;

                        // Add change event listener
                        languageSelect.addEventListener('change', (e) => {
                            i18n.setLanguage(e.target.value);
                        });
                    }
                }
            };

            // --- Preferences Logic ---
            const preferencesManager = {
                init() {
                    const savePreferencesBtn = document.getElementById('save-preferences-btn');
                    if (savePreferencesBtn) {
                        savePreferencesBtn.addEventListener('click', () => this.savePreferences());
                    }

                    // Initialize preferences modal when opened
                    const preferencesModal = document.getElementById('preferences-modal');
                    if (preferencesModal) {
                        preferencesModal.addEventListener('click', (e) => {
                            if (e.target === preferencesModal && preferencesModal.classList.contains('active')) {
                                this.loadPreferences();
                            }
                        });
                    }

                    // Initialize language selector
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        languageSelectPref.addEventListener('change', (e) => {
                            i18n.setLanguage(e.target.value);
                        });
                    }

                    // Load preferences when modal opens
                    const navButtons = document.querySelectorAll('[data-modal="preferences-modal"]');
                    navButtons.forEach(btn => {
                        btn.addEventListener('click', () => this.loadPreferences());
                    });
                },

                loadPreferences() {
                    const currentUser = userManager.getCurrentUser();
                    if (!currentUser) return;

                    // Load language
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        languageSelectPref.value = i18n.currentLang;
                    }

                    // Load user behavior settings
                    document.getElementById('user-auto-announce-pref').checked = currentUser.autoAnnounce || false;
                    document.getElementById('user-show-typing-pref').checked = currentUser.showTyping !== false;
                },

                savePreferences() {
                    const currentUser = userManager.getCurrentUser();
                    if (!currentUser) {
                        alert('请先选择一个用户！');
                        return;
                    }

                    // Save language (already saved by change event)
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        i18n.setLanguage(languageSelectPref.value);
                    }

                    // Save user behavior settings
                    currentUser.autoAnnounce = document.getElementById('user-auto-announce-pref').checked;
                    currentUser.showTyping = document.getElementById('user-show-typing-pref').checked;

                    // Also update the user settings modal checkboxes
                    document.getElementById('user-auto-announce').checked = currentUser.autoAnnounce;
                    document.getElementById('user-show-typing').checked = currentUser.showTyping;

                    userManager.saveUsers();
                    alert('偏好设置已保存！');
                }
            };

            // --- Theme Logic ---
            const themeManager = {
                themes: {},
                currentTheme: null,
                customCss: '',
                defaultPresets: {
                    default: {
                        primaryColor: '#5E5B9D',
                        bgColor: '#f0f2f5',
                        userBubbleColor: '#5E5B9D',
                        aiBubbleColor: '#FFFFFF',
                        cardBgColor: '#ffffff',
                        textColor: '#1a1a1d',
                        borderColor: '#dcdfe3',
                        inputBgColor: '#e4e6eb'
                    },
                    dark: {
                        primaryColor: '#7875b3',
                        bgColor: '#1a1a1d',
                        userBubbleColor: '#7875b3',
                        aiBubbleColor: '#2d2d30',
                        cardBgColor: '#2d2d30',
                        textColor: '#e0e0e0',
                        borderColor: '#404040',
                        inputBgColor: '#404040'
                    },
                    blue: {
                        primaryColor: '#3498db',
                        bgColor: '#ecf0f1',
                        userBubbleColor: '#3498db',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#2c3e50',
                        borderColor: '#bdc3c7',
                        inputBgColor: '#d5dbdb'
                    },
                    green: {
                        primaryColor: '#27ae60',
                        bgColor: '#f0fff4',
                        userBubbleColor: '#2ecc71',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#27ae60',
                        borderColor: '#a9dfbf',
                        inputBgColor: '#d5f4e6'
                    },
                    purple: {
                        primaryColor: '#8e44ad',
                        bgColor: '#f9f6fb',
                        userBubbleColor: '#9b59b6',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#6c3483',
                        borderColor: '#d2b4de',
                        inputBgColor: '#ebdef0'
                    },
                    pink: {
                        primaryColor: '#e91e63',
                        bgColor: '#fce4ec',
                        userBubbleColor: '#f06292',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#880e4f',
                        borderColor: '#f8bbd0',
                        inputBgColor: '#f5d0db'
                    }
                },

                init() {
                    this.loadThemes();
                    this.bindEvents();
                    this.loadCustomCss();
                    this.renderSavedThemes();
                    this.applyCurrentTheme();
                    this.initColorInputs();
                },

                async loadThemes() {
                    const themesData = await idbStorage.getItem('saved_themes_v1');
                    this.themes = themesData ? JSON.parse(themesData) : {};
                    this.currentTheme = await idbStorage.getItem('current_theme_v1') || 'default';
                },

                async saveThemes() {
                    await idbStorage.setItem('saved_themes_v1', JSON.stringify(this.themes));
                    await idbStorage.setItem('current_theme_v1', this.currentTheme);
                },

                async loadCustomCss() {
                    this.customCss = await idbStorage.getItem('custom_css_v1') || '';
                    const editor = document.getElementById('custom-css-editor');
                    if (editor) editor.value = this.customCss;
                    this.applyCustomCss();
                },

                async saveCustomCss(css) {
                    this.customCss = css;
                    await idbStorage.setItem('custom_css_v1', css);
                    this.applyCustomCss();
                },

                applyCustomCss() {
                    let styleEl = document.getElementById('custom-theme-styles');
                    if (!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = 'custom-theme-styles';
                        document.head.appendChild(styleEl);
                    }
                    styleEl.textContent = this.customCss;
                },

                getCurrentThemeColors() {
                    const root = document.documentElement;
                    const computedStyle = getComputedStyle(root);
                    return {
                        primaryColor: computedStyle.getPropertyValue('--primary-color').trim() || '#5E5B9D',
                        bgColor: computedStyle.getPropertyValue('--bg-color').trim() || '#f0f2f5',
                        userBubbleColor: computedStyle.getPropertyValue('--user-bubble-color').trim() || '#5E5B9D',
                        aiBubbleColor: computedStyle.getPropertyValue('--ai-bubble-color').trim() || '#FFFFFF',
                        cardBgColor: computedStyle.getPropertyValue('--card-bg-color').trim() || '#ffffff',
                        textColor: computedStyle.getPropertyValue('--text-color').trim() || '#1a1a1d',
                        borderColor: computedStyle.getPropertyValue('--border-color').trim() || '#dcdfe3',
                        inputBgColor: computedStyle.getPropertyValue('--input-bg-color').trim() || '#e4e6eb'
                    };
                },

                applyTheme(themeData) {
                    const root = document.documentElement;

                    if (themeData.primaryColor) root.style.setProperty('--primary-color', themeData.primaryColor);
                    if (themeData.bgColor) root.style.setProperty('--bg-color', themeData.bgColor);
                    if (themeData.userBubbleColor) root.style.setProperty('--user-bubble-color', themeData.userBubbleColor);
                    if (themeData.aiBubbleColor) root.style.setProperty('--ai-bubble-color', themeData.aiBubbleColor);
                    if (themeData.cardBgColor) root.style.setProperty('--card-bg-color', themeData.cardBgColor);
                    if (themeData.textColor) root.style.setProperty('--text-color', themeData.textColor);
                    if (themeData.borderColor) root.style.setProperty('--border-color', themeData.borderColor);
                    if (themeData.inputBgColor) root.style.setProperty('--input-bg-color', themeData.inputBgColor);

                    // 计算衍生颜色
                    root.style.setProperty('--primary-hover-color', this.adjustBrightness(themeData.primaryColor || '#5E5B9D', 20));
                    root.style.setProperty('--text-secondary-color', this.adjustBrightness(themeData.textColor || '#1a1a1d', 40));

                    if (themeData.customCss) {
                        this.saveCustomCss(themeData.customCss);
                    }

                    this.updateColorInputs();
                },

                applyCurrentTheme() {
                    // 首先尝试加载保存的主题
                    if (this.themes[this.currentTheme]) {
                        this.applyTheme(this.themes[this.currentTheme]);
                    }
                    // 然后检查是否是预设主题
                    else if (this.defaultPresets[this.currentTheme]) {
                        this.applyTheme(this.defaultPresets[this.currentTheme]);
                    }
                },

                saveAsNewTheme(name) {
                    if (!name) {
                        name = prompt('请输入主题名称：');
                        if (!name) return;
                    }

                    const themeData = {
                        ...this.getCurrentThemeColors(),
                        customCss: this.customCss,
                        createdAt: new Date().toISOString()
                    };

                    this.themes[name] = themeData;
                    this.currentTheme = name;
                    this.saveThemes();
                    this.renderSavedThemes();

                    alert(`主题 "${name}" 已保存！`);
                },

                deleteTheme(name) {
                    if (!this.themes[name]) return;

                    if (!confirm(`确定要删除主题 "${name}" 吗？`)) return;

                    delete this.themes[name];

                    if (this.currentTheme === name) {
                        this.currentTheme = 'default';
                        this.applyTheme(this.defaultPresets.default);
                    }

                    this.saveThemes();
                    this.renderSavedThemes();
                },

                exportTheme(name) {
                    const theme = name ? this.themes[name] : {
                        ...this.getCurrentThemeColors(),
                        customCss: this.customCss
                    };

                    if (!theme) {
                        alert('主题不存在！');
                        return;
                    }

                    const exportData = {
                        name: name || 'custom-theme',
                        theme: theme,
                        version: '1.0',
                        exportedAt: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `theme-${name || 'custom'}.json`;
                    // 移动端需要将a标签添加到DOM中才能触发下载
                    document.body.appendChild(a);
                    a.click();
                    // 延迟移除和释放URL,确保下载开始
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                },

                importTheme(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (!data.theme) {
                                throw new Error('无效的主题文件！');
                            }

                            const name = data.name || prompt('请输入主题名称：', data.name || 'imported-theme');
                            if (!name) return;

                            this.themes[name] = data.theme;
                            this.saveThemes();
                            this.renderSavedThemes();

                            if (confirm(`主题 "${name}" 已导入！是否立即应用？`)) {
                                this.currentTheme = name;
                                this.applyTheme(data.theme);
                                this.saveThemes();
                            }
                        } catch (err) {
                            alert(`导入失败：${err.message}`);
                        }
                    };
                    reader.readAsText(file);
                },

                renderSavedThemes() {
                    const list = document.getElementById('saved-themes-list');
                    const noThemes = document.getElementById('no-saved-themes');

                    if (!list) return;

                    list.innerHTML = '';

                    const themeNames = Object.keys(this.themes);

                    if (themeNames.length === 0) {
                        if (noThemes) noThemes.style.display = 'block';
                        list.style.display = 'none';
                    } else {
                        if (noThemes) noThemes.style.display = 'none';
                        list.style.display = 'block';

                        themeNames.forEach(name => {
                            const theme = this.themes[name];
                            const item = document.createElement('div');
                            item.className = 'theme-item p-3 rounded-lg border border-gray-200 hover:border-primary-color cursor-pointer';

                            if (name === this.currentTheme) {
                                item.classList.add('border-primary-color', 'bg-primary-color', 'bg-opacity-10');
                            }

                            item.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h4 class="font-medium">${name}</h4>
                                        <div class="flex gap-2 mt-2">
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.primaryColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.bgColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.userBubbleColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.aiBubbleColor}"></span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="apply-theme-btn px-3 py-1 btn-primary text-sm rounded" data-theme="${name}">应用</button>
                                        <button class="export-theme-btn px-3 py-1 btn-secondary text-sm rounded" data-theme="${name}"><i class="fas fa-download"></i></button>
                                        <button class="delete-theme-btn px-3 py-1 btn-secondary text-sm rounded hover:bg-red-100 hover:text-red-600" data-theme="${name}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `;

                            list.appendChild(item);
                        });

                        // 绑定主题操作按钮事件
                        list.querySelectorAll('.apply-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const themeName = btn.dataset.theme;
                                this.currentTheme = themeName;
                                this.applyTheme(this.themes[themeName]);
                                this.saveThemes();
                                this.renderSavedThemes();
                            });
                        });

                        list.querySelectorAll('.export-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.exportTheme(btn.dataset.theme);
                            });
                        });

                        list.querySelectorAll('.delete-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.deleteTheme(btn.dataset.theme);
                            });
                        });
                    }
                },

                adjustBrightness(color, percent) {
                    const num = parseInt(color.replace('#', ''), 16);
                    const amt = Math.round(2.55 * percent);
                    const R = (num >> 16) + amt;
                    const G = (num >> 8 & 0x00FF) + amt;
                    const B = (num & 0x0000FF) + amt;
                    return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                        (B < 255 ? B < 1 ? 0 : B : 255))
                        .toString(16).slice(1);
                },

                formatCss(css) {
                    // 简单的CSS格式化
                    return css
                        .replace(/\s*{\s*/g, ' {\n    ')
                        .replace(/;\s*/g, ';\n    ')
                        .replace(/\s*}\s*/g, '\n}\n')
                        .replace(/\n\s*\n/g, '\n');
                },

                minifyCss(css) {
                    // 简单的CSS压缩
                    return css
                        .replace(/\/\*[\s\S]*?\*\//g, '')
                        .replace(/\s+/g, ' ')
                        .replace(/\s*{\s*/g, '{')
                        .replace(/;\s*/g, ';')
                        .replace(/\s*}\s*/g, '}')
                        .trim();
                },

                initColorInputs() {
                    const colorInputs = [
                        { color: 'primaryColor', text: 'primaryColorText' },
                        { color: 'bgColor', text: 'bgColorText' },
                        { color: 'userBubbleColor', text: 'userBubbleColorText' },
                        { color: 'aiBubbleColor', text: 'aiBubbleColorText' },
                        { color: 'cardBgColor', text: 'cardBgColorText' },
                        { color: 'textColor', text: 'textColorText' },
                        { color: 'borderColor', text: 'borderColorText' },
                        { color: 'inputBgColor', text: 'inputBgColorText' }
                    ];

                    colorInputs.forEach(({ color, text }) => {
                        const colorInput = document.getElementById(`${color}Input`);
                        const textInput = document.getElementById(`${text}`);

                        if (colorInput && textInput) {
                            // 同步颜色选择器和文本输入
                            colorInput.addEventListener('input', (e) => {
                                textInput.value = e.target.value;
                            });

                            textInput.addEventListener('input', (e) => {
                                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                                    colorInput.value = e.target.value;
                                }
                            });
                        }
                    });

                    this.updateColorInputs();
                },

                updateColorInputs() {
                    const colors = this.getCurrentThemeColors();

                    Object.entries(colors).forEach(([key, value]) => {
                        const colorInput = document.getElementById(`${key}Input`);
                        const textInput = document.getElementById(`${key}Text`);

                        if (colorInput) colorInput.value = value;
                        if (textInput) textInput.value = value;
                    });
                },

                bindEvents() {
                    // 预设主题按钮
                    document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const themeName = btn.dataset.theme;
                            if (this.defaultPresets[themeName]) {
                                this.applyTheme(this.defaultPresets[themeName]);
                                this.currentTheme = themeName;
                                this.saveThemes();

                                document.querySelectorAll('.theme-preset-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            }
                        });
                    });

                    // 应用按钮
                    const applyBtn = document.getElementById('applyThemeBtn');
                    if (applyBtn) {
                        applyBtn.addEventListener('click', () => {
                            const colors = {};
                            ['primaryColor', 'bgColor', 'userBubbleColor', 'aiBubbleColor', 'cardBgColor', 'textColor', 'borderColor', 'inputBgColor'].forEach(key => {
                                const input = document.getElementById(`${key}Input`);
                                if (input) colors[key] = input.value;
                            });

                            this.applyTheme(colors);

                            // 保存自定义CSS
                            const cssEditor = document.getElementById('custom-css-editor');
                            if (cssEditor) {
                                this.saveCustomCss(cssEditor.value);
                            }
                        });
                    }

                    // 另存为按钮
                    const saveAsBtn = document.getElementById('saveAsThemeBtn');
                    if (saveAsBtn) {
                        saveAsBtn.addEventListener('click', () => this.saveAsNewTheme());
                    }

                    // 导出按钮
                    const exportBtn = document.getElementById('exportThemeBtn');
                    if (exportBtn) {
                        exportBtn.addEventListener('click', () => this.exportTheme());
                    }

                    // 导入按钮
                    const importBtn = document.getElementById('importThemeBtn');
                    const importFile = document.getElementById('themeImportFile');
                    if (importBtn && importFile) {
                        importBtn.addEventListener('click', () => importFile.click());
                        importFile.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.importTheme(e.target.files[0]);
                                e.target.value = '';
                            }
                        });
                    }

                    // 重置按钮
                    const resetBtn = document.getElementById('resetThemeBtn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            this.currentTheme = 'default';
                            this.applyTheme(this.defaultPresets.default);
                            this.saveCustomCss('');
                            this.saveThemes();
                            document.getElementById('custom-css-editor').value = '';
                        });
                    }

                    // CSS编辑器按钮
                    const formatBtn = document.getElementById('css-format-btn');
                    const minifyBtn = document.getElementById('css-minify-btn');
                    const previewBtn = document.getElementById('css-preview-btn');
                    const cssEditor = document.getElementById('custom-css-editor');

                    if (formatBtn && cssEditor) {
                        formatBtn.addEventListener('click', () => {
                            cssEditor.value = this.formatCss(cssEditor.value);
                        });
                    }

                    if (minifyBtn && cssEditor) {
                        minifyBtn.addEventListener('click', () => {
                            cssEditor.value = this.minifyCss(cssEditor.value);
                        });
                    }

                    if (previewBtn && cssEditor) {
                        previewBtn.addEventListener('click', () => {
                            this.saveCustomCss(cssEditor.value);
                            alert('CSS已应用预览！');
                        });
                    }

                    // 保存当前主题按钮
                    const saveCurrentBtn = document.getElementById('save-current-theme-btn');
                    if (saveCurrentBtn) {
                        saveCurrentBtn.addEventListener('click', () => this.saveAsNewTheme());
                    }
                }
            };

            // 主题标签页切换
            window.switchThemeTab = function(tab) {
                document.querySelectorAll('.theme-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                document.querySelectorAll('#theme-settings-modal .border-b button').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-primary-color', 'font-medium');
                    btn.classList.add('text-gray-500');
                });

                const content = document.getElementById(`theme-${tab}-content`);
                if (content) content.classList.remove('hidden');

                const tabBtn = document.getElementById(`theme-tab-${tab}`);
                if (tabBtn) {
                    tabBtn.classList.add('border-b-2', 'border-primary-color', 'font-medium');
                    tabBtn.classList.remove('text-gray-500');
                }

                // 如果切换到保存的主题页,刷新列表
                if (tab === 'saved' && typeof themeManager !== 'undefined' && themeManager.renderSavedThemes) {
                    themeManager.renderSavedThemes();
                }
            };

            // 初始化主题管理
            themeManager.init();
            preferencesManager.init();


            // --- Initial Load ---
            // 异步初始化函数
            async function initializeApp() {
                await userManagement.init();
                loadApiConfigs();
                loadPresetsList();
                await loadCharacters(); // This now handles loading character data and then triggers WI/Regex loads.
            }

            // 执行初始化
            initializeApp();

            // 更新预设Token统计
            function updatePresetTokenEstimate() {
                const preset = getPresets()[document.querySelector('.preset-item.active')?.dataset.name || '默认'];
                if (!preset?.prompts) return;

                let totalTokens = 0;
                preset.prompts.forEach(prompt => {
                    if (prompt.enabled && prompt.content) {
                        totalTokens += estimateTokens(prompt.content);
                    }
                });

                document.getElementById('preset-token-estimate').textContent = totalTokens;

                // 更新上下文使用情况
                const contextSize = parseInt(document.getElementById('param-context-size').value) || 4096;
                const maxTokens = parseInt(document.getElementById('param-max-tokens').value) || 1024;
                const remaining = contextSize - totalTokens - maxTokens;

                document.getElementById('remaining-context').textContent = `${remaining} / ${contextSize}`;

                const usagePercent = ((totalTokens + maxTokens) / contextSize) * 100;
                document.getElementById('context-usage-bar').style.width = `${Math.min(100, usagePercent)}%`;

                if (usagePercent > 90) {
                    document.getElementById('context-usage-bar').className = 'bg-red-500 h-2 rounded-full';
                } else if (usagePercent > 70) {
                    document.getElementById('context-usage-bar').className = 'bg-yellow-500 h-2 rounded-full';
                } else {
                    document.getElementById('context-usage-bar').className = 'bg-primary-color h-2 rounded-full';
                }
            }

            // 监听预设参数变化
            document.getElementById('param-context-size')?.addEventListener('input', updatePresetTokenEstimate);
            document.getElementById('param-max-tokens')?.addEventListener('input', updatePresetTokenEstimate);

            // 在切换预设时更新Token统计
            const originalSelectPreset = selectPreset;
            selectPreset = function(name) {
                originalSelectPreset(name);
                setTimeout(updatePresetTokenEstimate, 100);
            };

            // --- 总结聊天功能 ---
            const summarizeConfig = {
                apiUrl: document.getElementById('summarize-api-url'),
                apiKey: document.getElementById('summarize-api-key'),
                apiModel: document.getElementById('summarize-api-model'),
                apiModelSelect: document.getElementById('summarize-api-model-select'),
                floorCount: document.getElementById('summarize-floor-count'),
                prompt: document.getElementById('summarize-prompt'),
                autoHide: document.getElementById('summarize-auto-hide'),
                autoEnable: document.getElementById('summarize-auto-enable'),
                templatesSelect: document.getElementById('summarize-prompt-templates'),
                modal: document.getElementById('summarize-modal')
            };

            // 验证所有必需的元素都存在
            const missingElements = Object.entries(summarizeConfig).filter(([key, el]) => !el).map(([key]) => key);
            if (missingElements.length > 0) {
                console.warn('[总结配置] 缺少以下元素:', missingElements);
            }

            // 加载提示词模板列表
            async function loadPromptTemplates() {
                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                summarizeConfig.templatesSelect.innerHTML = '<option value="">选择模板...</option>';

                Object.keys(templates).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    summarizeConfig.templatesSelect.appendChild(option);
                });
            }

            // 保存提示词模板
            document.getElementById('save-prompt-template-btn').addEventListener('click', async () => {
                const templateName = prompt('请输入模板名称:');
                if (!templateName || !templateName.trim()) return;

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                templates[templateName.trim()] = summarizeConfig.prompt.value;
                await idbStorage.setItem('summarize_prompt_templates', JSON.stringify(templates));

                await loadPromptTemplates();
                summarizeConfig.templatesSelect.value = templateName.trim();
                alert(`模板 "${templateName}" 已保存！`);
            });

            // 加载提示词模板
            document.getElementById('load-prompt-template-btn').addEventListener('click', async () => {
                const selectedTemplate = summarizeConfig.templatesSelect.value;
                if (!selectedTemplate) {
                    alert('请先选择一个模板！');
                    return;
                }

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                if (templates[selectedTemplate]) {
                    summarizeConfig.prompt.value = templates[selectedTemplate];
                    alert(`已加载模板 "${selectedTemplate}"`);
                }
            });

            // 删除提示词模板
            document.getElementById('delete-prompt-template-btn').addEventListener('click', async () => {
                const selectedTemplate = summarizeConfig.templatesSelect.value;
                if (!selectedTemplate) {
                    alert('请先选择一个模板！');
                    return;
                }

                if (!confirm(`确定要删除模板 "${selectedTemplate}" 吗？`)) return;

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                delete templates[selectedTemplate];
                await idbStorage.setItem('summarize_prompt_templates', JSON.stringify(templates));

                await loadPromptTemplates();
                alert(`模板 "${selectedTemplate}" 已删除！`);
            });

            // 模型选择器变化事件
            summarizeConfig.apiModelSelect.addEventListener('change', () => {
                const selected = summarizeConfig.apiModelSelect.value;
                if (selected === 'custom') {
                    summarizeConfig.apiModel.classList.remove('hidden');
                    summarizeConfig.apiModel.value = '';
                    summarizeConfig.apiModel.focus();
                } else if (selected) {
                    summarizeConfig.apiModel.classList.add('hidden');
                    summarizeConfig.apiModel.value = selected;
                }
            });

            // 从API获取模型列表
            document.getElementById('fetch-models-btn').addEventListener('click', async () => {
                const btn = document.getElementById('fetch-models-btn');
                const resultDiv = document.getElementById('summarize-api-test-result');
                const icon = btn.querySelector('i');

                if (!summarizeConfig.apiUrl.value) {
                    resultDiv.innerHTML = '请先填写API地址！';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                if (!summarizeConfig.apiKey.value) {
                    resultDiv.innerHTML = '请先填写API密钥！';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                try {
                    resultDiv.innerHTML = '加载中...';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-yellow-500';
                    icon.classList.add('fa-spin');
                    btn.disabled = true;

                    // 参考主API实现
                    const urlObj = new URL(summarizeConfig.apiUrl.value);
                    let modelsUrl;
                    let headers = {};

                    if (urlObj.hostname.includes('google')) {
                        modelsUrl = `${urlObj.origin}/v1beta/models?key=${summarizeConfig.apiKey.value}`;
                    } else {
                        const baseUrl = summarizeConfig.apiUrl.value.replace(/\/chat\/completions.*$/, '');
                        modelsUrl = `${baseUrl}/models`;
                        headers['Authorization'] = `Bearer ${summarizeConfig.apiKey.value}`;
                    }

                    const response = await fetch(modelsUrl, {
                        method: 'GET',
                        headers: headers
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    let models = [];

                    if (data.data) {
                        models = data.data; // OpenAI格式
                    } else if (data.models) {
                        models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Google格式
                    }

                    if (models.length > 0) {
                        // 清空现有选项
                        summarizeConfig.apiModelSelect.innerHTML = '<option value="">选择模型...</option>';

                        // 添加获取到的模型
                        models
                            .sort((a, b) => a.id.localeCompare(b.id))
                            .forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.id;
                                summarizeConfig.apiModelSelect.appendChild(option);
                            });

                        // 添加自定义选项
                        const customOption = document.createElement('option');
                        customOption.value = 'custom';
                        customOption.textContent = '自定义...';
                        summarizeConfig.apiModelSelect.appendChild(customOption);

                        // 如果之前有选中的模型，尝试保持选中
                        const currentModel = summarizeConfig.apiModel.value;
                        const matchingOption = Array.from(summarizeConfig.apiModelSelect.options).find(opt => opt.value === currentModel);
                        if (matchingOption) {
                            summarizeConfig.apiModelSelect.value = currentModel;
                        }

                        resultDiv.innerHTML = `成功加载 ${models.length} 个模型！`;
                        resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-green-500';
                    } else {
                        throw new Error('未找到可用模型');
                    }
                } catch (error) {
                    resultDiv.innerHTML = `获取模型列表失败: ${error.message}`;
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                } finally {
                    icon.classList.remove('fa-spin');
                    btn.disabled = false;
                }
            });

            // 保存API配置
            document.getElementById('save-summarize-api-config-btn').addEventListener('click', () => {
                saveSummarizeConfig();
                alert('API配置已保存！');
            });

            // 加载API配置
            document.getElementById('load-summarize-api-config-btn').addEventListener('click', () => {
                loadSummarizeConfig();
                alert('API配置已加载！');
            });

            // 加载总结配置
            async function loadSummarizeConfig() {
                const saved = await idbStorage.getItem('summarize_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    summarizeConfig.apiUrl.value = config.apiUrl || '';
                    summarizeConfig.apiKey.value = config.apiKey || '';

                    // 设置模型
                    const modelValue = config.apiModel || 'gpt-4o-mini';
                    summarizeConfig.apiModel.value = modelValue;

                    // 检查下拉列表中是否有这个模型
                    const options = Array.from(summarizeConfig.apiModelSelect.options);
                    const matchingOption = options.find(opt => opt.value === modelValue);

                    if (matchingOption) {
                        summarizeConfig.apiModelSelect.value = modelValue;
                        summarizeConfig.apiModel.classList.add('hidden');
                    } else {
                        // 如果下拉列表中没有，选择"自定义"
                        summarizeConfig.apiModelSelect.value = 'custom';
                        summarizeConfig.apiModel.classList.remove('hidden');
                    }

                    summarizeConfig.floorCount.value = config.floorCount || 10;
                    summarizeConfig.prompt.value = config.prompt || summarizeConfig.prompt.value;
                    summarizeConfig.autoHide.checked = config.autoHide !== false;
                    summarizeConfig.autoEnable.checked = config.autoEnable || false;
                }
                await loadPromptTemplates();
            }

            // 保存总结配置
            async function saveSummarizeConfig() {
                // 确保使用正确的模型值
                const selectedModel = summarizeConfig.apiModelSelect.value;
                if (selectedModel && selectedModel !== 'custom') {
                    summarizeConfig.apiModel.value = selectedModel;
                }

                const config = {
                    apiUrl: summarizeConfig.apiUrl.value,
                    apiKey: summarizeConfig.apiKey.value,
                    apiModel: summarizeConfig.apiModel.value,
                    floorCount: parseInt(summarizeConfig.floorCount.value) || 10,
                    prompt: summarizeConfig.prompt.value,
                    autoHide: summarizeConfig.autoHide.checked,
                    autoEnable: summarizeConfig.autoEnable.checked
                };
                await idbStorage.setItem('summarize_config', JSON.stringify(config));
            }

            // 执行总结的核心函数
            async function performSummarize(isAuto = false) {
                try {
                    const configData = await idbStorage.getItem('summarize_config');
                    const config = configData ? JSON.parse(configData) : {};

                    if (!config.apiUrl || !config.apiKey || !config.apiModel) {
                        if (!isAuto) alert('请先配置完整的API设置（URL、密钥、模型）！');
                        return false;
                    }

                    const floorCount = parseInt(config.floorCount) || 10;
                    const visibleMessages = chatHistory.filter(m => !m.hidden);
                    // 从第1条开始往后取,而不是从后往前取
                    const messagesToSummarize = visibleMessages.slice(0, Math.min(floorCount, visibleMessages.length));

                    if (messagesToSummarize.length === 0) {
                        if (!isAuto) alert('没有可总结的消息！');
                        return false;
                    }

                    console.log(`[总结] ${isAuto ? '自动' : '手动'}总结 ${messagesToSummarize.length} 条消息`);

                    // 构建总结请求 - 参考主API的实现
                    const conversationText = messagesToSummarize.map(msg =>
                        `${msg.role === 'user' ? '用户' : '助手'}: ${msg.content}`
                    ).join('\n\n');

                    // 参考主API构建endpoint和headers
                    const urlObj = new URL(config.apiUrl);
                    let endpoint = `${config.apiUrl.replace(/\/$/, '')}`;
                    // 如果URL不包含chat/completions，添加它
                    if (!endpoint.includes('/chat/completions')) {
                        endpoint = `${endpoint}/chat/completions`;
                    }

                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    };

                    let body = {
                        model: config.apiModel,
                        messages: [
                            {
                                role: 'system',
                                content: config.prompt || '请简明扼要地总结以下对话内容。'
                            },
                            {
                                role: 'user',
                                content: conversationText
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    };

                    // 支持Google API格式
                    if (urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${config.apiModel}:generateContent?key=${config.apiKey}`;
                        delete headers.Authorization;

                        body = {
                            contents: [
                                {
                                    role: 'user',
                                    parts: [{ text: `${config.prompt}\n\n${conversationText}` }]
                                }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 500,
                            }
                        };
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(error.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    let summary = '';

                    // 处理不同格式的响应
                    if (result.choices) {
                        // OpenAI格式
                        summary = result.choices[0].message.content;
                    } else if (result.candidates) {
                        // Google格式
                        summary = result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('无法解析API响应格式');
                    }

                    console.log('[总结] 总结结果:', summary);

                    // 添加总结到角色世界书
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        if (!activeChar.data.character_book) {
                            activeChar.data.character_book = {
                                name: `${activeChar.name}的记忆`,
                                entries: []
                            };
                        }

                        // 查找是否已存在总结条目
                        let summaryEntry = activeChar.data.character_book.entries.find(
                            entry => entry.keys && entry.keys.includes('总结')
                        );

                        if (summaryEntry) {
                            // 已存在总结条目,追加新内容
                            const timestamp = new Date().toLocaleString();
                            summaryEntry.content += `\n\n---[${isAuto ? '自动' : '手动'}总结 ${timestamp}]---\n${summary}`;
                            summaryEntry.name = `聊天总结 (最后更新: ${timestamp})`;
                            console.log('[总结] 已追加到现有总结条目');
                        } else {
                            // 不存在总结条目,创建新的
                            summaryEntry = {
                                id: `summary_${Date.now()}`,
                                enabled: true,
                                name: `聊天总结 (创建: ${new Date().toLocaleString()})`,
                                keys: ['总结', '记忆', '回忆'],
                                content: summary,
                                case_sensitive: false,
                                whole_word: false,
                                position: 0,
                                role: 0,
                                scan_depth: 100,
                                use_regex: false
                            };
                            activeChar.data.character_book.entries.push(summaryEntry);
                            console.log('[总结] 已创建新的总结条目');
                        }

                        saveCharacters();
                        console.log('[总结] 已保存到角色世界书');
                    }

                    // 隐藏已总结的消息
                    if (config.autoHide) {
                        messagesToSummarize.forEach(msg => {
                            msg.hidden = true;
                        });
                        saveChat();
                        renderMessages();
                        console.log(`[总结] 已隐藏 ${messagesToSummarize.length} 条消息`);
                    }

                    if (!isAuto) {
                        alert(`总结成功！\n\n已总结 ${messagesToSummarize.length} 条消息，并添加到角色世界书。\n\n${config.autoHide ? '已隐藏总结过的消息。' : ''}`);
                    }

                    return true;
                } catch (error) {
                    console.error('[总结] 失败:', error);
                    if (!isAuto) {
                        alert(`总结失败: ${error.message}`);
                    }
                    return false;
                }
            }

            // 检查是否需要自动总结
            async function checkAutoSummarize() {
                const configData = await idbStorage.getItem('summarize_config');
                const config = configData ? JSON.parse(configData) : {};

                if (!config.autoEnable) return;
                if (!config.apiUrl || !config.apiKey) return;

                const floorCount = parseInt(config.floorCount) || 10;
                const visibleMessages = chatHistory.filter(m => !m.hidden);

                if (visibleMessages.length >= floorCount) {
                    console.log('[自动总结] 达到触发条件，开始总结...');
                    await performSummarize(true);
                }
            }

            // 打开总结模态框
            document.getElementById('menu-summarize-btn').addEventListener('click', () => {
                loadSummarizeConfig();
                if (summarizeConfig.modal) {
                    summarizeConfig.modal.classList.add('active');
                }
                const menuDropdown = document.getElementById('menu-dropdown');
                if (menuDropdown) {
                    menuDropdown.classList.remove('active');
                }
            });

            // 总结聊天弹窗关闭按钮
            document.getElementById('summarize-modal-close').addEventListener('click', () => {
                const modal = document.getElementById('summarize-modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });

            // 点击弹窗背景关闭
            document.getElementById('summarize-modal').addEventListener('click', (e) => {
                if (e.target.id === 'summarize-modal') {
                    e.target.classList.remove('active');
                }
            });

            // 测试API - 发送测试消息
            document.getElementById('test-summarize-api-btn').addEventListener('click', async () => {
                const btn = document.getElementById('test-summarize-api-btn');
                const resultDiv = document.getElementById('summarize-api-test-result');
                const originalHtml = btn.innerHTML;

                // 先保存配置
                saveSummarizeConfig();

                // 验证必填项
                if (!summarizeConfig.apiUrl.value || !summarizeConfig.apiKey.value) {
                    resultDiv.innerHTML = '请先填写API地址和密钥！';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                if (!summarizeConfig.apiModel.value) {
                    resultDiv.innerHTML = '请先选择模型！';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                try {
                    resultDiv.innerHTML = '测试中...';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-yellow-500';
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>测试中...';
                    btn.disabled = true;

                    // 参考主API的实现构建请求
                    const urlObj = new URL(summarizeConfig.apiUrl.value);
                    let endpoint = `${summarizeConfig.apiUrl.value.replace(/\/$/, '')}`;
                    if (!endpoint.includes('/chat/completions')) {
                        endpoint = `${endpoint}/chat/completions`;
                    }

                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${summarizeConfig.apiKey.value}`
                    };

                    let body = {
                        model: summarizeConfig.apiModel.value,
                        messages: [{
                            role: 'user',
                            content: '你好，这是一个API连接测试，请简单回复"连接成功"。'
                        }],
                        max_tokens: 50
                    };

                    // 支持Google API
                    if (urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${summarizeConfig.apiModel.value}:generateContent?key=${summarizeConfig.apiKey.value}`;
                        delete headers.Authorization;

                        body = {
                            contents: [{
                                role: 'user',
                                parts: [{ text: '你好，这是一个API连接测试，请简单回复"连接成功"。' }]
                            }],
                            generationConfig: {
                                maxOutputTokens: 50
                            }
                        };
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        let reply = '';

                        if (data.choices) {
                            reply = data.choices[0].message.content;
                        } else if (data.candidates) {
                            reply = data.candidates[0].content.parts[0].text;
                        }

                        resultDiv.innerHTML = `测试成功！回复: ${reply.substring(0, 50)}...`;
                        resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-green-500';
                    } else {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    resultDiv.innerHTML = `测试失败: ${error.message}`;
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            });

            // 开始总结
            document.getElementById('start-summarize-btn').addEventListener('click', async () => {
                const btn = document.getElementById('start-summarize-btn');
                const originalHtml = btn.innerHTML;

                try {
                    // 保存配置
                    saveSummarizeConfig();

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>总结中...';
                    btn.disabled = true;

                    const success = await performSummarize(false);

                    if (success) {
                        summarizeConfig.modal.classList.remove('active');
                    }
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            });

            // 在发送消息后检查自动总结
            const originalSendMessage = sendMessage;
            sendMessage = async function(...args) {
                await originalSendMessage.apply(this, args);

                // 延迟检查，确保消息已添加
                setTimeout(() => {
                    checkAutoSummarize();
                }, 1000);
            };

            // 初始化
            loadSummarizeConfig();

        });
    </script>

    <!-- 保存提示Toast -->
    <div id="save-toast" class="save-toast">
        <div class="icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="message">已自动保存</div>
    </div>

</body>
</html>